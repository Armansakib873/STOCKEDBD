<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>STOCKED BD | Ultimate POS</title>
    <style>
        /* --- 1. CORE THEME --- */
        :root {
            --primary: #4f46e5; /* Indigo 600 */
            --primary-dark: #4338ca;
            --bg-body: #f1f5f9; /* Slate 100 */
            --bg-surface: #ffffff;
            --text-main: #0f172a;
            --text-muted: #64748b;
            --border: #e2e8f0;
            --success: #10b981;
            --danger: #ef4444;
            --radius: 8px;
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
        }
        * { box-sizing: border-box; outline: none; }
        body { 
            font-family: 'Segoe UI', system-ui, sans-serif; margin: 0; 
            background: var(--bg-body); color: var(--text-main); 
            height: 100vh; display: flex; flex-direction: column; overflow: hidden; 
        }

        /* --- 2. HEADER --- */
        header {
            background: var(--bg-surface); height: 65px; 
            border-bottom: 1px solid var(--border); padding: 0 25px;
            display: flex; align-items: center; justify-content: space-between; z-index: 10;
        }
        .brand { font-size: 22px; font-weight: 800; color: var(--primary); letter-spacing: -0.5px; display: flex; align-items: center; gap: 8px; }
        .nav-bar { background: #f8fafc; padding: 5px; border-radius: var(--radius); border: 1px solid var(--border); display: flex; gap: 5px; }
        .nav-item {
            padding: 8px 16px; border: none; background: transparent; color: var(--text-muted);
            font-weight: 600; font-size: 14px; cursor: pointer; border-radius: 6px; transition: 0.2s;
        }
        .nav-item:hover { color: var(--primary); background: #eef2ff; }
        .nav-item.active { background: var(--bg-surface); color: var(--primary); box-shadow: 0 1px 2px rgba(0,0,0,0.1); }

        /* --- 3. LAYOUT --- */
        main { flex: 1; overflow-y: auto; padding: 25px; max-width: 1600px; margin: 0 auto; width: 100%; }
        .section { display: none; animation: fadeIn 0.3s ease; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- 4. DASHBOARD COMPONENTS --- */
        .shortcut-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .shortcut-card {
            background: var(--bg-surface); padding: 15px; border-radius: var(--radius);
            border: 1px solid var(--border); cursor: pointer; font-weight: 600;
            display: flex; align-items: center; gap: 10px; color: var(--text-muted); transition: 0.2s;
        }
        .shortcut-card:hover { border-color: var(--primary); color: var(--primary); transform: translateY(-2px); box-shadow: var(--shadow); }
        
        .stats-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 25px; }
        .stat-box {
            background: var(--bg-surface); padding: 20px; border-radius: var(--radius);
            border: 1px solid var(--border); position: relative; overflow: hidden; cursor: pointer;
        }
        .stat-box:hover { box-shadow: var(--shadow); }
        .stat-label { font-size: 13px; color: var(--text-muted); text-transform: uppercase; font-weight: 600; }
        .stat-value { font-size: 32px; font-weight: 800; margin-top: 5px; color: var(--text-main); }
        .stat-box.alert .stat-value { color: var(--danger); }

        .dashboard-split { display: grid; grid-template-columns: 2fr 1fr; gap: 25px; }
        .panel { background: var(--bg-surface); border: 1px solid var(--border); border-radius: var(--radius); overflow: hidden; }
        .panel-head { padding: 15px 20px; background: #f8fafc; border-bottom: 1px solid var(--border); font-weight: 700; }

        /* --- 5. POS SYSTEM --- */
        .pos-container { display: grid; grid-template-columns: 1fr 420px; gap: 20px; height: calc(100vh - 130px); }
        .pos-left { display: flex; flex-direction: column; gap: 15px; overflow: hidden; }
        .product-grid { 
            display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); 
            gap: 12px; overflow-y: auto; padding: 2px; align-content: start; 
        }
        .pos-card {
            background: var(--bg-surface); border: 1px solid var(--border); padding: 12px;
            border-radius: var(--radius); cursor: pointer; position: relative; transition: 0.2s;
            display: flex; flex-direction: column; gap: 5px;
        }
        .pos-card:hover { border-color: var(--primary); box-shadow: var(--shadow); }
        .stock-tag { position: absolute; top: 8px; right: 8px; background: #f1f5f9; font-size: 10px; padding: 2px 6px; border-radius: 4px; font-weight: bold; }
        
        .pos-right { background: var(--bg-surface); border: 1px solid var(--border); border-radius: var(--radius); display: flex; flex-direction: column; overflow: hidden; }
        .cart-header { padding: 15px; border-bottom: 1px solid var(--border); background: #f8fafc; }
        .cart-list { flex: 1; overflow-y: auto; padding: 0; }
        .cart-item { 
            padding: 12px; border-bottom: 1px dashed var(--border); font-size: 13px; 
            display: grid; grid-template-columns: 1fr auto; gap: 8px;
        }
        .cart-controls { display: flex; align-items: center; gap: 8px; margin-top: 5px; }
        .cart-input { width: 60px; padding: 4px; text-align: center; border: 1px solid var(--border); border-radius: 4px; }
        .cart-footer { padding: 15px; background: #f8fafc; border-top: 1px solid var(--border); }
        .total-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px; }
        .grand-total { font-size: 20px; font-weight: 800; color: var(--primary); margin: 10px 0; display: flex; justify-content: space-between; }

        /* --- 6. INVENTORY & TABLES --- */
        .toolbar { display: flex; justify-content: space-between; margin-bottom: 15px; gap: 15px; flex-wrap: wrap; }
        .search-box { flex: 1; max-width: 400px; position: relative; }
        .table-wrap { background: var(--bg-surface); border: 1px solid var(--border); border-radius: var(--radius); overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th { background: #f8fafc; padding: 12px 15px; text-align: left; border-bottom: 1px solid var(--border); color: var(--text-muted); cursor: pointer; user-select: none; }
        th:hover { background: #e2e8f0; }
        td { padding: 10px 15px; border-bottom: 1px solid var(--border); }
        tr:hover td { background: #f8fafc; }
        
        .btn { padding: 8px 16px; border-radius: 6px; border: none; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 6px; font-size: 13px; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-sec { background: white; border: 1px solid var(--border); color: var(--text-main); }
        .btn-sec:hover { background: #f1f5f9; }
        .btn-danger { background: #fee2e2; color: var(--danger); }
        .btn-sm { padding: 4px 8px; font-size: 12px; }

        input, select { padding: 8px 12px; border: 1px solid var(--border); border-radius: 6px; width: 100%; font-size: 13px; }
        
        /* --- 7. MODALS & PRINT --- */
        .modal { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 1000; backdrop-filter: blur(2px); }
       .modal-box {
    background: #ffffff;
    width: 650px; /* Slightly wider */
    max-width: 95vw;
    padding: 30px;
    border-radius: 16px; /* Softer corners */
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    display: flex;
    flex-direction: column;
    gap: 20px;
    position: relative;
}
        @keyframes popIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        .tag { padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: bold; }
        .tag-sale { background: #dcfce7; color: #166534; }
        .tag-return { background: #fee2e2; color: #991b1b; }
        
        
        /* --- TABS --- */
.tab-container { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #e2e8f0; }
.tab-btn { 
    padding: 10px 20px; background: none; border: none; 
    font-weight: 600; color: var(--text-muted); cursor: pointer; 
    border-bottom: 3px solid transparent; transition: 0.2s;
}
.tab-btn:hover { color: var(--primary); }
.tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); }

   /* --- PRINT SETTINGS (A4) --- */
    
    /* 1. Hide the print area strictly in normal view */
    #print-area { 
        display: none; 
    }

    /* 2. A4 Print Layout */
    @media print {
        /* Hide the App Interface */
        body * { visibility: hidden; height: 0; overflow: hidden; }
        
        /* Show only the receipt area */
        #print-area, #print-area * { visibility: visible; height: auto; }
        
        #print-area {
            display: block !important;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            padding: 40px; /* A4 Margins */
            background: white;
            font-family: 'Segoe UI', sans-serif; /* Professional Font */
            color: black;
        }

        /* A4 Page Setup */
        @page { 
            size: A4; 
            margin: 0; 
        }

        /* Print Specific Table Styling */
        .print-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .print-table th { border-bottom: 2px solid #000; text-align: left; padding: 8px; }
        .print-table td { border-bottom: 1px solid #ddd; padding: 8px; }
        .text-right { text-align: right; }
        .print-header { display: flex; justify-content: space-between; border-bottom: 2px solid #000; padding-bottom: 20px; margin-bottom: 20px; }
        
        /* --- SEARCH DROPDOWN IN MODAL --- */
/* --- MAIN SPOTLIGHT SEARCH --- */
.search-wrapper {
    position: relative;
    z-index: 50; /* Ensure dropdown floats above everything */
}
.search-input {
    width: 100%;
    padding: 14px 18px;
    padding-left: 45px; /* Space for icon */
    border: 2px solid #e2e8f0;
    border-radius: 12px;
    font-size: 15px;
    transition: all 0.2s;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2394a3b8' stroke-width='2'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' d='M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z' /%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: 15px center;
    background-size: 20px;
}

.search-input:focus {
    border-color: var(--primary);
    box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.1);
}
/* --- SEARCH RESULTS DROPDOWN --- */
.search-results {
    position: absolute;
    top: 110%;
    left: 0;
    width: 100%;
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    max-height: 300px;
    overflow-y: auto;
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    display: none;
    animation: slideDown 0.1s ease-out;
}

@keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

.search-result-row {
    padding: 12px 16px;
    border-bottom: 1px solid #f1f5f9;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: background 0.1s;
}

.search-result-row:hover { background-color: #f8fafc; }
.search-result-row:last-child { border-bottom: none; }

.res-title { font-weight: 600; color: var(--text-main); display: block; }
.res-sub { font-size: 12px; color: var(--text-muted); font-family: monospace; }
.res-stock { font-size: 11px; background: #e2e8f0; padding: 3px 8px; border-radius: 12px; font-weight: 600; }

/* --- FEEDBACK ALERTS (UID & NAME) --- */
.feedback-box {
    margin-top: 6px;
    font-size: 12px;
    padding: 8px 12px;
    border-radius: 8px;
    display: none; /* Hidden by default */
    animation: fadeIn 0.2s;
    line-height: 1.4;
}

/* 1. Success (Unique UID) */
.fb-success {
    background-color: #f0fdf4;
    color: #15803d;
    border: 1px solid #bbf7d0;
}

/* 2. Error (Duplicate UID) */
.fb-error {
    background-color: #fef2f2;
    color: #b91c1c;
    border: 1px solid #fecaca;
}

/* 3. Warning (Similar Name) */
.fb-warning {
    background-color: #fff7ed;
    color: #c2410c;
    border: 1px solid #fed7aa;
}

.fb-link {
    text-decoration: underline;
    font-weight: 700;
    cursor: pointer;
    margin-left: 5px;
}
.search-item { padding: 10px; border-bottom: 1px solid #f1f5f9; cursor: pointer; display: flex; justify-content: space-between; }
.search-item:hover { background: #f8fafc; color: var(--primary); }
.search-item:last-child { border-bottom: none; }
    }



    /* --- VARIANT STYLES --- */
.variant-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 12px; }
.variant-table th { background: #f1f5f9; padding: 8px; text-align: left; border: 1px solid #e2e8f0; }
.variant-table td { padding: 6px; border: 1px solid #e2e8f0; }
.v-input { width: 100%; border: none; background: transparent; outline: none; }
.btn-icon { padding: 4px 8px; background: #fee2e2; color: red; border-radius: 4px; border: none; cursor: pointer; }

/* POS Variant Selector Modal */
.v-selector-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; margin-top: 15px; }
.v-select-card { 
    background: #f8fafc; border: 1px solid #e2e8f0; padding: 10px; 
    border-radius: 6px; cursor: pointer; text-align: center; transition: 0.2s;
}
.v-select-card:hover { border-color: var(--primary); background: #eef2ff; }
.v-stock-badge { font-size: 10px; background: #e2e8f0; padding: 2px 6px; border-radius: 4px; }


    </style>
</head>
<body>

    <!-- HEADER -->
    <header>
        <div class="brand">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 7h-9"/><path d="M14 17H5"/><circle cx="17" cy="17" r="3"/><circle cx="7" cy="7" r="3"/></svg>
            STOCKED <span style="font-weight:400; color:var(--text-muted); font-size:14px;">Ultimate</span>
        </div>
        <div class="nav-bar">
            <button class="nav-item active" onclick="nav('dashboard')">Dashboard</button>
            <button class="nav-item" onclick="nav('pos')">POS System</button>
            <button class="nav-item" onclick="nav('inventory')">Inventory</button>
            <button class="nav-item" onclick="nav('history')">History</button>
            <button class="nav-item" onclick="nav('settings')">Settings</button>
        </div>
    </header>

    <main>
        <!-- 1. DASHBOARD -->
        <div id="dashboard" class="section active">
            <div class="shortcut-grid">
                <div class="shortcut-card" onclick="nav('pos')">‚ö° Quick Sale</div>
                <div class="shortcut-card" onclick="openProdModal()">üì¶ New Product</div>
                <div class="shortcut-card" onclick="filterLowStock()">‚ö†Ô∏è Low Stock</div>
                <div class="shortcut-card" onclick="nav('history')">üìÑ View Reports</div>
            </div>

            <div class="stats-row">
                <div class="stat-box">
                    <div class="stat-label">Total Sales (Today)</div>
                    <div class="stat-value" style="color: var(--primary);" id="d-sales">0</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Net Profit (Today)</div>
                    <div class="stat-value" style="color: var(--success);" id="d-profit">0</div>
                </div>
                <div class="stat-box alert" onclick="filterLowStock()">
                    <div class="stat-label">Low Stock Items</div>
                    <div class="stat-value" id="d-low">0</div>
                    <div style="font-size:11px; color:var(--danger); margin-top:5px;">Click to manage</div>
                </div>
            </div>

            <div class="dashboard-split">
                <div class="panel">
                    <div class="panel-head">üî• Top Selling Products</div>
                    <table id="top-table">
                        <thead><tr><th>Product</th><th>Sold</th><th>Revenue</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div class="panel">
                    <div class="panel-head">üïí Recent Activity</div>
                    <div id="recent-list" style="padding:10px;"></div>
                </div>
            </div>
        </div>

        <!-- 2. POS SYSTEM -->
        <div id="pos" class="section">
            <div class="pos-container">
                <!-- LEFT: PRODUCTS -->
                <div class="pos-left">
                    <div style="display:flex; gap:10px;">
                        <input type="text" id="pos-search" placeholder="Scan Barcode or Search Name..." onkeyup="renderPOS()" autofocus>
                        <select id="pos-cat" onchange="renderPOS()" style="width:150px;">
                            <option value="">All Categories</option>
                        </select>
                    </div>
                    <div class="product-grid" id="pos-grid"></div>
                </div>

                <!-- RIGHT: CART -->
                <div class="pos-right">
                    <div class="cart-header">
                        <h3 style="margin:0 0 10px 0;">Current Order</h3>
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                            <input id="cust-name" placeholder="Customer Name">
                            <input id="cust-phone" placeholder="Phone Number">
                        </div>
                    </div>
                    <div class="cart-list" id="cart-list">
                        <!-- Items Injected Here -->
                    </div>
                   <!-- UPDATE THIS SECTION IN YOUR HTML -->
<div class="cart-footer">
    <div class="total-row"><span>Subtotal (Gross):</span> <span id="c-sub">0</span></div>
    
    <div class="total-row">
        <span>Delivery Charge:</span> 
        <input type="number" id="c-del" value="0" style="width:80px; text-align:right;" onchange="updateCartTotals()">
    </div>
    
    <!-- CHANGED: Overall Discount is now Percentage -->
    <div class="total-row" style="align-items: center;">
        <span>Apply Overall Disc (%):</span> 
        <input type="number" id="c-disc-global" placeholder="0%" style="width:80px; text-align:right;" oninput="applyGlobalDiscount(this.value)">
    </div>

    <div class="grand-total"><span>Net Payable:</span> <span id="c-total">0</span></div>
    
    <button class="btn btn-primary" style="width:100%; justify-content:center; padding:12px;" onclick="processCheckout()">
        ‚úÖ Complete Sale & Print
    </button>
</div>
                </div>
            </div>
        </div>

        <!-- 3. INVENTORY -->
        <div id="inventory" class="section">
            <div class="toolbar">
                <div class="search-box">
                    <input id="inv-search" placeholder="Search by UID or Name..." onkeyup="renderInv()">
                </div>
                <select id="inv-cat-filter" onchange="renderInv()" style="width:180px;">
                    <option value="">All Categories</option>
                </select>
                <button class="btn btn-primary" onclick="openProdModal()">+ Add New Product</button>
            </div>
            <div class="table-wrap">
                <table>
                    <thead>
                        <tr>
                            <th onclick="sortInv('uid')">UID ‚Üï</th>
                            <th onclick="sortInv('name')">Product Name ‚Üï</th>
                            <th>Category</th>
                            <th>Supplier</th>
                            <th>Cost</th>
                            <th>Price</th>
                            <th onclick="sortInv('stock')">Stock ‚Üï</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="inv-body"></tbody>
                </table>
            </div>
        </div>

       <!-- 4. HISTORY & REPORTS -->
<div id="history" class="section">
    
    <!-- TABS -->
    <div class="tab-container">
        <button class="tab-btn active" onclick="switchTab('trans')">Sales & Returns</button>
        <button class="tab-btn" onclick="switchTab('logs')">Stock Entry Logs</button>
    </div>

    <!-- VIEW 1: SALES TRANSACTIONS -->
    <div id="view-trans">
        <div class="toolbar">
            <div style="display:flex; gap:10px; flex:1;">
                <!-- NEW: Search Bar for History -->
                <input id="hist-search" placeholder="üîç Search Bill ID, Customer or Phone..." onkeyup="renderHistory()">
                
                <input type="date" id="hist-date" onchange="renderHistory()" style="width:150px;">
                <select id="hist-type" onchange="renderHistory()" style="width:150px;">
                    <option value="">All Types</option>
                    <option value="sale">Sales</option>
                    <option value="return">Returns</option>
                </select>
            </div>
            <button class="btn btn-sec" onclick="renderHistory()">üîÑ Refresh</button>
        </div>
        <div class="table-wrap">
            <table>
                <thead><tr><th>ID</th><th>Date</th><th>Type</th><th>Customer</th><th>Total</th><th>Actions</th></tr></thead>
                <tbody id="hist-body"></tbody>
            </table>
        </div>
    </div>

    <!-- VIEW 2: PRODUCT LOGS (NEW) -->
    <div id="view-logs" style="display:none;">
        <div class="toolbar">
            <div class="search-box">
                <input id="log-search" placeholder="üîç Search Log by Product Name or UID..." onkeyup="renderProductLogs()">
            </div>
        </div>
        <div class="table-wrap">
            <table>
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Action Type</th>
                        <th>Product</th>
                        <th>UID</th>
                        <th>Qty Added</th>
                        <th>Stock After</th>
                    </tr>
                </thead>
                <tbody id="log-body"></tbody>
            </table>
        </div>
    </div>
</div>

        <!-- 5. SETTINGS -->
        <div id="settings" class="section">
            <h2>‚öôÔ∏è Settings & Data</h2>
            <div style="max-width:600px; background:white; padding:20px; border-radius:8px; border:1px solid var(--border);">
                
                <h3>Shop Details (For Receipt)</h3>
                <div style="display:grid; gap:10px; margin-bottom:20px;">
                    <input id="set-name" placeholder="Shop Name" onchange="saveSettings()">
                    <input id="set-addr" placeholder="Address" onchange="saveSettings()">
                    <input id="set-phone" placeholder="Phone" onchange="saveSettings()">
                </div>

                <h3>Data Backup</h3>
                <p style="color:var(--text-muted); font-size:13px;">Download your data regularly to avoid loss.</p>
                <div style="display:flex; gap:10px; margin-bottom:20px;">
                    <button class="btn btn-primary" onclick="exportData()">‚¨áÔ∏è Export Backup</button>
                    <button class="btn btn-sec" onclick="document.getElementById('file-in').click()">‚¨ÜÔ∏è Restore Data</button>
                    <input type="file" id="file-in" hidden onchange="importData(this)">
                </div>
                
                <hr>
                <button class="btn btn-danger" onclick="factoryReset()" style="margin-top:10px;">‚ö†Ô∏è Factory Reset</button>
            </div>
        </div>
    </main>

    <!-- MODALS -->
    
<!-- MODAL: PRODUCT & VARIANT MASTER -->
<div id="modal-prod" class="modal">
    <div class="modal-box">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2 id="m-title" style="margin:0;">Product Manager</h2>
            <button onclick="closeModal('modal-prod')" style="background:none; border:none; font-size:20px; cursor:pointer;">&times;</button>
        </div>
        
        <!-- 1. MAIN SPOTLIGHT SEARCH -->
       <div class="search-wrapper">
    <input id="p-search" class="search-input" 
           placeholder="Scan Barcode, Type Name or UID to Edit..." 
           onkeyup="searchForModal(this.value)" 
           autocomplete="off">
    <div id="p-results" class="search-results"></div>
</div>

        <input type="hidden" id="p-id"> 


        

        <!-- MASTER DETAILS SECTION -->
        <div style="background: #f8fafc; padding: 20px; border-radius: 12px; border: 1px solid #e2e8f0;">
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-bottom:15px;">
                <!-- UID INPUT WITH FEEDBACK -->
                <div>
                    <label style="font-size:12px; font-weight:600; color:#64748b;">Master UID (Style Code)</label>
                    <input id="p-uid" placeholder="e.g. 1001" onkeyup="checkMasterUid(this.value)" autocomplete="off">
                    <!-- The Feedback Div -->
                    <div id="uid-feedback" class="feedback-box"></div>
                </div>
                <div>
                    <label style="font-size:12px; font-weight:600; color:#64748b;">Category</label>
                    <select id="p-cat" style="padding:10px;"></select>
                </div>
            </div>
            
            <!-- NAME INPUT WITH FEEDBACK -->
            <div style="margin-bottom:15px;">
                <label style="font-size:12px; font-weight:600; color:#64748b;">Product Name</label>
                <input id="p-name" onkeyup="checkMasterName(this.value)" autocomplete="off">
                <!-- The Feedback Div -->
                <div id="name-feedback" class="feedback-box"></div>
            </div>

            <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:15px;">
                <div><label style="font-size:12px; font-weight:600; color:#64748b;">Supplier</label><input id="p-sup"></div>
                <div><label style="font-size:12px; font-weight:600; color:#64748b;">Buy Price</label><input type="number" id="p-buy"></div>
                <div><label style="font-size:12px; font-weight:600; color:#64748b;">Sell Price</label><input type="number" id="p-sell"></div>
            </div>
        </div>

        <!-- VARIANT BUILDER (No changes to logic, just wrapper) -->
        <div>
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <h4 style="margin:0;">Variants & Stock</h4>
                <span style="font-size:11px; color:#64748b;">Total Stock: <span id="v-total-display">0</span></span>
            </div>
            
            <div style="display:flex; gap:10px; margin-bottom:10px;">
                <input id="v-color" placeholder="Color (e.g. Red)" style="flex:1">
                <input id="v-size" placeholder="Size (e.g. XL)" style="flex:1">
                <input type="number" id="v-qty" placeholder="Qty" style="width:80px;">
                <button class="btn btn-primary" onclick="addVariantRow()">+ Add</button>
            </div>
            
            <div style="max-height: 150px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 8px;">
                <table class="variant-table" style="margin:0;">
                    <thead style="position:sticky; top:0; background:#f1f5f9;">
                        <tr><th>SKU</th><th>Color</th><th>Size</th><th>Stock</th><th>Action</th></tr>
                    </thead>
                    <tbody id="variant-list"></tbody>
                </table>
            </div>
        </div>

        <div style="display:flex; justify-content:flex-end; gap:10px; padding-top:10px; border-top: 1px solid #e2e8f0;">
            <button class="btn btn-sec" onclick="closeModal('modal-prod')">Cancel</button>
            <button class="btn btn-primary" onclick="saveProduct()">üíæ Save Product</button>
        </div>
    </div>
</div>

<!-- NEW MODAL: POS VARIANT SELECTOR -->
<div id="modal-v-select" class="modal">
    <div class="modal-box" style="width: 400px;">
        <h3>Select Variation</h3>
        <p id="v-select-title" style="color:#64748b; margin-top:-10px;"></p>
        <div id="v-select-grid" class="v-selector-grid"></div>
        <div style="text-align:right; margin-top:15px;">
            <button class="btn btn-sec" onclick="closeModal('modal-v-select')">Cancel</button>
        </div>
    </div>
</div>

<!-- MODAL: VIEW TRANSACTION DETAILS -->
<div id="modal-trx" class="modal">
    <div class="modal-box">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <h3 style="margin:0;">Transaction Details</h3>
            <button onclick="closeModal('modal-trx')" style="background:none; border:none; font-size:24px; cursor:pointer; color:var(--text-muted);">&times;</button>
        </div>
        
        <!-- This container is where JS injects the bill details -->
        <div id="trx-content" style="max-height: 70vh; overflow-y: auto;"></div>

        <div style="text-align:right; margin-top:15px; pt-3; border-top:1px solid var(--border);">
            <button class="btn btn-sec" onclick="closeModal('modal-trx')">Close</button>
        </div>
    </div>
</div>
    <!-- Hidden Print Area -->
    <div id="print-area"></div>

    <script>
        /* --- 1. DATA STRUCTURE & INIT --- */
        const DB_NAME = "stocked_ultimate_db";
        let db = { 
            products: [], 
            transactions: [], 
            settings: { name: "My Shop", addr: "Dhaka", phone: "017..." } 
        };
        let cart = [];
        let sortKey = 'name', sortAsc = true;

        window.onload = () => {
    const saved = localStorage.getItem(DB_NAME);
    if (saved) db = JSON.parse(saved);
    else seedData();
    
    // --- ADD THIS LINE ---
    if (!db.productLogs) db.productLogs = []; // Ensure logs array exists
    // --------------------
    
    loadSettings();
    nav('dashboard');
    updateCatDropdowns();
};

        function seedData() {
            db.products = [
                {id:1, uid:"1001", name:"Cotton Polo Shirt", cat:"Clothing", sup:"FashionBd", buy:300, sell:550, stock:40},
                {id:2, uid:"2050", name:"USB-C Charger", cat:"Electronics", sup:"GadgetMart", buy:150, sell:350, stock:8}
            ];
            save();
        }
        function save() { localStorage.setItem(DB_NAME, JSON.stringify(db)); }

        function nav(id) {
            document.querySelectorAll('.section').forEach(e => e.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
            // Simple active state logic based on button text matching id roughly
            const btns = document.querySelectorAll('.nav-item');
            btns.forEach(b => { if(b.innerText.toLowerCase().includes(id)) b.classList.add('active'); });

            if(id === 'dashboard') renderDash();
            if(id === 'pos') renderPOS();
            if(id === 'inventory') renderInv();
            if(id === 'history') renderHistory();
        }

        /* --- 2. INVENTORY LOGIC --- */
        function renderInv() {
            const tbody = document.getElementById('inv-body');
            tbody.innerHTML = "";
            const q = document.getElementById('inv-search').value.toLowerCase();
            const cat = document.getElementById('inv-cat-filter').value;

            let list = db.products.filter(p => 
                (p.name.toLowerCase().includes(q) || p.uid.toLowerCase().includes(q)) &&
                (cat === "" || p.cat === cat)
            );

            // Sort
            list.sort((a,b) => {
                let va = a[sortKey], vb = b[sortKey];
                if(typeof va === 'string') { va = va.toLowerCase(); vb = vb.toLowerCase(); }
                return (va > vb ? 1 : -1) * (sortAsc ? 1 : -1);
            });

            list.forEach(p => {
                tbody.innerHTML += `
                    <tr>
                        <td style="font-family:monospace; color:var(--primary); font-weight:bold;">${p.uid}</td>
                        <td>${p.name}</td>
                        <td><span class="tag" style="background:#f1f5f9;">${p.cat}</span></td>
                        <td>${p.sup}</td>
                        <td>${p.buy}</td>
                        <td>${p.sell}</td>
                        <td>${p.stock} ${p.stock<5 ? 'üî¥' : ''}</td>
                        <td>
                            <button class="btn btn-sec btn-sm" onclick="editProd(${p.id})">‚úèÔ∏è</button>
                            <button class="btn btn-danger btn-sm" onclick="delProd(${p.id})">üóë</button>
                        </td>
                    </tr>
                `;
            });
        }
        
        function editProd(id) {
    // Reuse the logic we built for the search bar
    // This ensures the modal opens and fills correctly
    openProdModal(); // Open and reset first
    fillModalFromSearch(id); // Fill with data
    document.getElementById('m-title').innerText = "Edit Product Details";
}


        function sortInv(key) {
            if(sortKey === key) sortAsc = !sortAsc;
            else { sortKey = key; sortAsc = true; }
            renderInv();
        }

        // --- SMART PRODUCT MODAL LOGIC ---

// 1. Open Modal (Resets everything)
// --- VARIANT & PRODUCT LOGIC ---

// Global temporary array to hold variants while editing
let tempVariants = [];

function openProdModal() {
    // ... existing code ...
    document.getElementById('m-title').innerText = "Add New Product";
    document.getElementById('p-id').value = "";
    document.querySelectorAll('#modal-prod input').forEach(i => i.value = "");
    
    // --- ADD THESE LINES ---
    document.getElementById('uid-feedback').style.display = 'none';
    document.getElementById('name-feedback').style.display = 'none';
    // ----------------------

    // ... rest of existing code ...
    tempVariants = [];
    renderVariantTable();
    
    document.getElementById('p-uid').readOnly = false;
    document.getElementById('modal-prod').style.display = 'flex';
    setTimeout(() => document.getElementById('p-search').focus(), 100);
}

function fillModalFromSearch(id) {
    const p = db.products.find(x => x.id === id);
    if(!p) return;

    document.getElementById('p-id').value = p.id;
    document.getElementById('p-uid').value = p.uid;
    document.getElementById('p-uid').readOnly = true;
    document.getElementById('p-name').value = p.name;
    document.getElementById('p-cat').value = p.cat;
    document.getElementById('p-sup').value = p.sup;
    document.getElementById('p-buy').value = p.buy;
    document.getElementById('p-sell').value = p.sell;

    // Load existing variants into temp array
    // If old product (no variants), create a default one
    tempVariants = p.variants ? JSON.parse(JSON.stringify(p.variants)) : 
                   [{sku: p.uid, color: 'Std', size: 'Std', stock: p.stock}];
    
    renderVariantTable();
    document.getElementById('p-results').style.display = 'none';
    document.getElementById('p-search').value = "";
}

// Add a row to the table (InMemory)
function addVariantRow() {
    const color = document.getElementById('v-color').value || "Std";
    const size = document.getElementById('v-size').value || "Std";
    const qty = Number(document.getElementById('v-qty').value);
    const uid = document.getElementById('p-uid').value;

    if(!uid) return alert("Enter Master UID first!");
    if(qty <= 0) return alert("Enter Quantity");

    // Auto-Generate SKU: UID-COLOR-SIZE
    const sku = `${uid}-${color.toUpperCase().slice(0,3)}-${size.toUpperCase()}`;
    
    // Check if SKU exists in temp list
    const ex = tempVariants.find(v => v.sku === sku);
    if(ex) {
        ex.stock += qty; // Just add stock
    } else {
        tempVariants.push({ sku, color, size, stock: qty });
    }

    renderVariantTable();
    // Clear inputs
    document.getElementById('v-qty').value = "";
}

function renderVariantTable() {
    const tbody = document.getElementById('variant-list');
    tbody.innerHTML = tempVariants.map((v, i) => `
        <tr>
            <td>${v.sku}</td>
            <td>${v.color}</td>
            <td>${v.size}</td>
            <td><b>${v.stock}</b></td>
            <td><button class="btn-icon" onclick="tempVariants.splice(${i},1); renderVariantTable()">√ó</button></td>
        </tr>
    `).join('');
}

// --- ADVANCED SEARCH FOR MODAL ---

function searchForModal(q) {
    const resDiv = document.getElementById('p-results');
    
    // 1. Hide if empty
    if (!q || q.trim().length < 1) {
        resDiv.style.display = 'none';
        return;
    }
    
    const term = q.toLowerCase().trim();

    // 2. Filter Database
    const matches = db.products.filter(p => {
        // Safe check for fields in case they are undefined
        const name = (p.name || "").toLowerCase();
        const uid = (p.uid || "").toLowerCase();
        const sup = (p.sup || "").toLowerCase();
        
        // A. Check Master Details
        if (name.includes(term) || uid.includes(term) || sup.includes(term)) {
            return true;
        }

        // B. Check Child Variants (e.g., Scanning a specific sub-SKU)
        if (p.variants && p.variants.length > 0) {
            // Check if ANY variant sku matches the search term
            return p.variants.some(v => v.sku.toLowerCase().includes(term));
        }

        return false;
    });

    // 3. Render Results
    if (matches.length > 0) {
        resDiv.style.display = 'block';
        resDiv.innerHTML = matches.slice(0, 10).map(p => `
            <div class="search-item" onclick="fillModalFromSearch(${p.id})">
                <div style="display:flex; flex-direction:column; gap:2px;">
                    <div>
                        <strong style="color:var(--primary);">${p.name}</strong> 
                        <small style="color:#64748b; font-family:monospace;">[${p.uid}]</small>
                    </div>
                    <div style="font-size:11px; color:#64748b;">
                        Supplier: ${p.sup || 'N/A'}
                    </div>
                </div>
                <div style="text-align:right;">
                    <span style="font-size:12px; background:#f1f5f9; padding:2px 6px; border-radius:4px; font-weight:bold;">
                        Stock: ${p.stock}
                    </span>
                    <br>
                    <small style="font-size:10px; color:#94a3b8;">Click to Edit</small>
                </div>
            </div>
        `).join('');
    } else {
        resDiv.style.display = 'none';
    }
}

// HELPER: Centralized Logging for Variants
function addLog(prodName, prodUid, variantSku, variantDetails, qtyChange, type, currentStock) {
    if (!db.productLogs) db.productLogs = [];
    
    db.productLogs.unshift({
        date: new Date().toISOString(),
        name: prodName,
        uid: prodUid,
        sku: variantSku || "N/A", // NEW: Track SKU
        variant: variantDetails || "Std", // NEW: Track Color/Size
        added: qtyChange,
        type: type,
        finalStock: currentStock
    });
}

function saveProduct() {
    const id = document.getElementById('p-id').value;
    const uid = document.getElementById('p-uid').value || "GEN-" + Date.now();
    
    // 1. DUPLICATE CHECK (Master Level)
    const duplicate = db.products.find(p => p.uid.toLowerCase() === uid.toLowerCase() && p.id != id);
    if(duplicate) {
        alert(`STOP! The UID "${uid}" is already taken by "${duplicate.name}".`);
        return; 
    }

    // 2. PREPARE NEW DATA OBJECT
    const obj = {
        uid: uid,
        name: document.getElementById('p-name').value,
        cat: document.getElementById('p-cat').value || "General",
        sup: document.getElementById('p-sup').value,
        buy: Number(document.getElementById('p-buy').value),
        sell: Number(document.getElementById('p-sell').value),
        variants: tempVariants 
    };

    // Calculate Master Stock
    obj.stock = tempVariants.reduce((sum, v) => sum + v.stock, 0);

    if(!obj.name || !obj.sell) return alert("Name and Sell Price required!");
    if(tempVariants.length === 0) return alert("Add at least one variant/stock!");

    // 3. DETAILED LOGGING LOGIC
    if(id) {
        // --- UPDATE EXISTING PRODUCT ---
        const idx = db.products.findIndex(x => x.id == id);
        if(idx > -1) {
            const oldProd = db.products[idx];
            obj.id = Number(id);
            
            // Compare Old Variants vs New Variants to log changes
            obj.variants.forEach(newV => {
                const oldV = oldProd.variants ? oldProd.variants.find(ov => ov.sku === newV.sku) : null;
                const oldQty = oldV ? oldV.stock : 0;
                const diff = newV.stock - oldQty;

                if (diff !== 0) {
                    const type = diff > 0 ? 'Stock Added' : 'Stock Adjusted';
                    addLog(obj.name, obj.uid, newV.sku, `${newV.color}/${newV.size}`, diff, type, newV.stock);
                }
            });

            // Handle newly created variants that didn't exist before
            // (Covered by the logic above if oldV is undefined, diff becomes newV.stock)

            db.products[idx] = obj;
        }
    } else {
        // --- CREATE NEW PRODUCT ---
        obj.id = Date.now();
        db.products.push(obj);
        
        // Log entry for EVERY variant
        obj.variants.forEach(v => {
            addLog(obj.name, obj.uid, v.sku, `${v.color}/${v.size}`, v.stock, 'Initial Stock', v.stock);
        });
    }

    save();
    closeModal('modal-prod');
    renderInv();
    renderPOS();
    alert("Saved Successfully!");
}

        function delProd(id) {
            if(confirm("Delete this product?")) {
                db.products = db.products.filter(x => x.id !== id);
                save();
                renderInv();
            }
        }

        /* --- 3. POS LOGIC --- */
       function renderPOS() {
    const grid = document.getElementById('pos-grid');
    grid.innerHTML = "";
    const q = document.getElementById('pos-search').value.toLowerCase();
    const cat = document.getElementById('pos-cat').value;

    db.products.filter(p => 
        (p.name.toLowerCase().includes(q) || p.uid.toLowerCase().includes(q)) &&
        (cat === "" || p.cat === cat) && p.stock > 0
    ).forEach(p => {
        grid.innerHTML += `
            <div class="pos-card" onclick="addToCart(${p.id})">
                <div class="stock-tag">${p.stock}</div>
                <div style="font-weight:bold; font-size:14px;">${p.name}</div>
                <div style="font-size:12px; color:var(--text-muted);">${p.uid}</div>
                <div style="color:var(--primary); font-weight:bold; margin-top:auto;">‡ß≥${p.sell}</div>
            </div>
        `;
    });
}
function addToCart(idOrSku) {
    // 1. Try to find by specific Variant SKU first (Scanner behavior)
    let foundProd = null;
    let foundVariant = null;

    // Loop to find SKU match
    db.products.forEach(p => {
        if(p.variants) {
            const v = p.variants.find(v => v.sku === idOrSku); // Check Variant SKU
            if(v) { foundProd = p; foundVariant = v; }
        }
    });

    // 2. If scanned specific variant, add directly
    if(foundProd && foundVariant) {
        pushToCart(foundProd, foundVariant);
        return;
    }

    // 3. If not found by SKU, find by Master Product ID
    foundProd = db.products.find(x => x.id === idOrSku);
    
    if(foundProd) {
        // Handle "One-click" for old data or single variant
        if(!foundProd.variants || foundProd.variants.length <= 1) {
            // Create dummy variant if old data
            const v = foundProd.variants ? foundProd.variants[0] : {sku: foundProd.uid, color:'Std', size:'Std', stock: foundProd.stock};
            pushToCart(foundProd, v);
        } else {
            // MULTIPLE VARIANTS: Show Selector Modal
            openVariantSelector(foundProd);
        }
    }
}

// Helper: The "Which one?" Popup
function openVariantSelector(prod) {
    const grid = document.getElementById('v-select-grid');
    document.getElementById('v-select-title').innerText = prod.name;
    
    grid.innerHTML = prod.variants.map(v => `
        <div class="v-select-card" onclick="selectVariant(${prod.id}, '${v.sku}')">
            <div style="font-weight:bold;">${v.color} - ${v.size}</div>
            <div style="font-size:11px; color:#64748b;">${v.sku}</div>
            <div class="v-stock-badge ${v.stock<1?'bg-red':''}">Stock: ${v.stock}</div>
        </div>
    `).join('');
    
    document.getElementById('modal-v-select').style.display = 'flex';
}

function selectVariant(prodId, vSku) {
    const p = db.products.find(x => x.id === prodId);
    const v = p.variants.find(x => x.sku === vSku);
    pushToCart(p, v);
    closeModal('modal-v-select');
}

// Actual Cart Add Logic
function pushToCart(prod, variant) {
    if(variant.stock <= 0) return alert("Out of Stock!");

    // Check if this specific VARIANT is in cart
    const ex = cart.find(c => c.sku === variant.sku);
    
    if(ex) {
        if(ex.qty < variant.stock) ex.qty++;
        else alert("Stock Limit Reached");
    } else {
        const globalDisc = Number(document.getElementById('c-disc-global').value) || 0;
        cart.push({
            id: prod.id,
            name: prod.name,
            sku: variant.sku,        // STORE THE SKU
            color: variant.color,    // STORE DETAILS
            size: variant.size,
            stock: variant.stock,    // Max Stock
            actualSell: prod.sell,
            buy: prod.buy,
            qty: 1,
            discPercent: globalDisc,
            sup: prod.sup
        });
    }
    renderCart();
}
     function renderCart() {
    const div = document.getElementById('cart-list');
    div.innerHTML = "";
    
    cart.forEach((c, idx) => {
        // Math calculations
        const originalTotal = c.actualSell * c.qty;
        const discountAmount = originalTotal * (c.discPercent / 100);
        const finalLineTotal = originalTotal - discountAmount;

        div.innerHTML += `
            <div class="cart-item" style="display:block;">
                <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                    <span style="font-weight:600;">${c.name}</span>
                    <button style="color:red; border:none; background:none; cursor:pointer;" onclick="remCart(${idx})">‚úñ</button>
                </div>
                
                <!-- RESTORED: Supplier and Stock Info -->
                <div style="font-size:11px; color:#64748b; margin-bottom:5px;">
                    ${c.sup || 'N/A'} | Stock: ${c.stock}
                </div>
                
                <div style="display:flex; align-items:center; gap:5px; font-size:12px; color:#64748b;">
                    <span>Price: ‡ß≥</span>
                    <input class="cart-input" type="number" value="${c.actualSell}" 
                           onchange="updateCartItem(${idx}, 'price', this.value)" style="width:60px;">
                </div>

                <div style="display:flex; align-items:center; justify-content:space-between; margin-top:8px;">
                    <!-- QTY CONTROLS -->
                    <div class="cart-controls">
                        <button class="btn btn-sec btn-sm" onclick="updCart(${idx}, -1)">-</button>
                        <span style="font-weight:bold;">${c.qty}</span>
                        <button class="btn btn-sec btn-sm" onclick="updCart(${idx}, 1)">+</button>
                    </div>

                    <!-- DISCOUNT CONTROL -->
                    <div style="display:flex; align-items:center; gap:2px;">
                        <small>Disc%</small>
                        <input class="cart-input" type="number" value="${c.discPercent}" 
                               onchange="updateCartItem(${idx}, 'disc', this.value)" style="width:45px; border-color:var(--primary);">
                    </div>

                    <!-- FINAL PRICE DISPLAY -->
                    <div style="font-weight:bold; font-size:14px; color:var(--primary);">
                        ‡ß≥${Math.round(finalLineTotal)}
                    </div>
                </div>
            </div>
        `;
    });
    updateCartTotals();
}
        function updCart(idx, chg) {
            const c = cart[idx];
            if(c.qty + chg > 0 && c.qty + chg <= c.stock) {
                c.qty += chg;
                renderCart();
            }
        }
        function updPrice(idx, val) { cart[idx].actualSell = Number(val); renderCart(); }
        function remCart(idx) { cart.splice(idx, 1); renderCart(); }

       // Handle specific item updates
function updateCartItem(idx, type, val) {
    const v = Number(val);
    if(type === 'price') cart[idx].actualSell = v;
    if(type === 'disc') cart[idx].discPercent = v; // Update specific item discount
    renderCart();
}

// Handle "Apply to All" Discount
function applyGlobalDiscount(val) {
    const pct = Number(val);
    // Loop through all items and update their discount percent
    cart.forEach(item => {
        item.discPercent = pct;
    });
    renderCart();
}

// Calculate Grand Total
function updateCartTotals() {
    let grossSub = 0;
    let totalPayable = 0;

    cart.forEach(c => {
        const lineGross = c.actualSell * c.qty;
        const lineDisc = lineGross * (c.discPercent / 100);
        
        grossSub += lineGross;
        totalPayable += (lineGross - lineDisc);
    });

    const del = Number(document.getElementById('c-del').value);
    
    document.getElementById('c-sub').innerText = grossSub; // Show original value
    document.getElementById('c-total').innerText = "‡ß≥" + Math.round(totalPayable + del);
}

   function processCheckout() {
    if(cart.length === 0) return alert("Cart is Empty!");

    let grossSub = 0;
    let netTotal = 0;
    const del = Number(document.getElementById('c-del').value) || 0;

    // 1. PREPARE ITEMS & CALCULATE TOTALS
    const finalItems = cart.map(c => {
        const unitGross = c.actualSell;
        const unitDisc = unitGross * (c.discPercent / 100);
        const unitFinal = unitGross - unitDisc;
        
        grossSub += (unitGross * c.qty);
        netTotal += (unitFinal * c.qty);
        
        return {
            id: c.id,              // Master ID
            uid: c.uid,            // Master UID
            sku: c.sku,            // Specific Variant SKU
            name: c.name,
            color: c.color,        // Variant Detail
            size: c.size,          // Variant Detail
            qty: c.qty,
            buy: c.buy,
            actualSell: c.actualSell, // Original Price
            discPercent: c.discPercent,
            unitFinalPrice: unitFinal, // Price after discount
            sup: c.sup
        };
    });

    const grandTotal = netTotal + del;
    const totalDiscount = grossSub - netTotal;
    
    // Calculate Profit
    const profit = finalItems.reduce((acc, item) => {
        return acc + ((item.unitFinalPrice - item.buy) * item.qty);
    }, 0);

    // 2. DEDUCT STOCK FROM DB (CRITICAL FIX)
    finalItems.forEach(cartItem => {
        // Find Master Product
        const product = db.products.find(p => p.id === cartItem.id);
        
        if (product) {
            if (product.variants && product.variants.length > 0) {
                // Find Specific Variant by SKU
                const variant = product.variants.find(v => v.sku === cartItem.sku);
                if (variant) {
                    variant.stock -= cartItem.qty;
                }
                // Recalculate Master Stock Sum
                product.stock = product.variants.reduce((sum, v) => sum + v.stock, 0);
            } else {
                // Fallback for old non-variant products
                product.stock -= cartItem.qty;
            }
        }
    });

    // 3. CREATE TRANSACTION OBJECT
    const trx = {
        id: "INV-" + Date.now().toString().slice(-6),
        date: new Date().toISOString(),
        type: 'sale',
        cust: document.getElementById('cust-name').value || "Guest",
        phone: document.getElementById('cust-phone').value || "",
        items: finalItems,
        sub: Math.round(grossSub), 
        del: del, 
        disc: Math.round(totalDiscount), 
        total: Math.round(grandTotal), 
        profit: Math.round(profit)
    };

    // 4. SAVE TO DB
    db.transactions.unshift(trx);
    save();
    
    // 5. TRIGGER PRINT
    printReceipt(trx);
    
    // 6. RESET POS
    cart = [];
    document.getElementById('c-del').value = 0;
    document.getElementById('c-disc-global').value = "";
    document.getElementById('cust-name').value = "";
    document.getElementById('cust-phone').value = "";
    renderCart();
    renderPOS(); // Refresh grid to show new stock levels
    renderDash(); // Update dashboard stats
}

        /* --- 4. HISTORY & RETURNS --- */
        function renderHistory() {
            const tbody = document.getElementById('hist-body');
            tbody.innerHTML = "";
            const date = document.getElementById('hist-date').value;
            const type = document.getElementById('hist-type').value;

            db.transactions.forEach(t => {
                if(date && !t.date.startsWith(date)) return;
                if(type && t.type !== type) return;
                
                const tag = t.type === 'sale' ? '<span class="tag tag-sale">SALE</span>' : '<span class="tag tag-return">RETURN</span>';
                
                tbody.innerHTML += `
                    <tr>
                        <td>${t.id}</td>
                        <td>${new Date(t.date).toLocaleString()}</td>
                        <td>${tag}</td>
                        <td>${t.cust}<br><small>${t.phone}</small></td>
                        <td style="font-weight:bold;">‡ß≥${t.total}</td>
                        <td>
                            <button class="btn btn-sec btn-sm" onclick='viewTrx("${t.id}")'>üëÅ Details</button>
                            <button class="btn btn-sec btn-sm" onclick='printReceiptById("${t.id}")'>üñ® Print</button>
                        </td>
                    </tr>
                `;
            });
        }

function viewTrx(id) {
    // 1. Find the transaction
    const t = db.transactions.find(x => x.id === id);
    
    if (!t) {
        console.error("Transaction ID not found:", id);
        return alert("Error: Transaction not found in database.");
    }

    // 2. Build Header
    let html = `
        <div style="display:flex; justify-content:space-between; margin-bottom:10px; align-items:center;">
            <div>
                <span style="font-size:18px; font-weight:bold; color:var(--primary);">Bill: ${t.id}</span>
            </div>
            <div style="font-size:12px; color:#64748b;">${new Date(t.date).toLocaleString()}</div>
        </div>
        
        <div style="background:#f8fafc; padding:12px; border-radius:8px; margin-bottom:15px; border:1px solid #e2e8f0; font-size:13px;">
            <div style="display:flex; justify-content:space-between;">
                <span><strong>Customer:</strong> ${t.cust || 'Guest'}</span>
                <span><strong>Phone:</strong> ${t.phone || 'N/A'}</span>
            </div>
        </div>

        <table style="width:100%; border-collapse:collapse; font-size:13px;">
            <thead style="background:#f1f5f9; color:#475569;">
                <tr>
                    <th style="padding:10px; text-align:left; border-bottom:2px solid #e2e8f0;">Item Details</th>
                    <th style="padding:10px; text-align:center; border-bottom:2px solid #e2e8f0;">Price</th>
                    <th style="padding:10px; text-align:center; border-bottom:2px solid #e2e8f0;">Qty</th>
                    <th style="padding:10px; text-align:center; border-bottom:2px solid #e2e8f0;">Disc</th>
                    <th style="padding:10px; text-align:right; border-bottom:2px solid #e2e8f0;">Total</th>
                    <th style="padding:10px; text-align:center; border-bottom:2px solid #e2e8f0;">Action</th>
                </tr>
            </thead>
            <tbody>
    `;

    // 3. Loop Items (With Safety Checks)
    t.items.forEach((i, idx) => {
        const isRet = i.isReturned === true;
        
        // SAFETY CHECKS: Handle missing data from old versions
        const name = i.name || "Unknown Item";
        const sku = i.sku || i.uid || "";
        const variantInfo = (i.color || i.size) ? `(${i.color || ''}/${i.size || ''})` : "";
        
        // Price Logic (Fallback to simple calculation if new fields missing)
        const unitPrice = Number(i.actualSell || 0);
        const discPct = Number(i.discPercent || 0);
        // If unitFinalPrice exists, use it. Otherwise calculate it.
        const finalPrice = i.unitFinalPrice !== undefined ? Number(i.unitFinalPrice) : (unitPrice - (unitPrice * discPct / 100));
        
        const lineTotal = (i.qty * finalPrice).toFixed(2);
        
        // Styles
        const rowStyle = isRet ? 'background:#fff1f2; color:#991b1b;' : 'border-bottom:1px solid #f1f5f9;';
        const textStyle = isRet ? 'text-decoration:line-through; opacity:0.7;' : '';
        const statusBadge = isRet ? '<br><span class="tag tag-return" style="font-size:10px;">RETURNED</span>' : '';

        html += `
            <tr style="${rowStyle}">
                <td style="padding:10px;">
                    <div style="${textStyle}"><b>${name}</b></div>
                    <div style="font-size:11px; color:#64748b;">${sku} ${variantInfo}</div>
                    ${statusBadge}
                </td>
                <td style="text-align:center; ${textStyle}">${unitPrice}</td>
                <td style="text-align:center; ${textStyle}">${i.qty}</td>
                <td style="text-align:center; ${textStyle}">${discPct}%</td>
                <td style="text-align:right; font-weight:bold; ${textStyle}">${lineTotal}</td>
                <td style="text-align:center;">
                     ${t.type === 'sale' && !isRet ? 
                       `<button class="btn btn-danger btn-sm" style="padding:4px 8px;" onclick="processReturn('${t.id}', ${idx})">‚Ü©</button>` : 
                       '-'
                     }
                </td>
            </tr>
        `;
    });

    // 4. Footer Totals
    html += `</tbody></table>
        <div style="text-align:right; margin-top:20px; padding-top:15px; border-top:2px solid #e2e8f0;">
            <div style="margin-bottom:5px; color:#64748b;">Subtotal: <span style="color:#0f172a;">${t.sub || 0}</span></div>
            <div style="margin-bottom:5px; color:#ef4444;">Discount: -${t.disc || 0}</div>
            <div style="margin-bottom:5px; color:#64748b;">Delivery: +${t.del || 0}</div>
            <div style="font-size:18px; font-weight:800; color:var(--primary); margin-top:10px;">
                Total Paid: ‡ß≥${t.total || 0}
            </div>
        </div>`;

    // 5. Inject and Show
    const contentDiv = document.getElementById('trx-content');
    const modalDiv = document.getElementById('modal-trx');

    if (contentDiv && modalDiv) {
        contentDiv.innerHTML = html;
        modalDiv.style.display = 'flex';
    } else {
        console.error("Modal elements missing in HTML");
    }
}
    function processReturn(tid, idx) {
    if(!confirm("Process Return? Stock will be restored to specific Variation.")) return;
    
    const orgTrx = db.transactions.find(x => x.id === tid);
    const item = orgTrx.items[idx];

    if(item.isReturned) return alert("Item already returned!");

    // 1. RESTORE STOCK TO SPECIFIC VARIANT
    const prod = db.products.find(p => p.id === item.id);
    
    if(prod) {
        // Find the specific variant using SKU
        let variant = null;
        if(prod.variants) {
            variant = prod.variants.find(v => v.sku === item.sku);
        }

        if(variant) {
            // Update Variant Stock
            variant.stock += item.qty;
            
            // Recalculate Master Stock
            prod.stock = prod.variants.reduce((sum, v) => sum + v.stock, 0);
            
            // LOG: Specific Variant Return
            addLog(prod.name, prod.uid, variant.sku, `${variant.color}/${variant.size}`, item.qty, 'Customer Return', variant.stock);
        } else {
            // Fallback for old data (Legacy support)
            prod.stock += item.qty;
            addLog(prod.name, prod.uid, "N/A", "General", item.qty, 'Customer Return (Legacy)', prod.stock);
        }
    }

    // 2. UPDATE TRANSACTION STATUS
    item.isReturned = true;
    orgTrx.items[idx] = item;

    // 3. CREATE RETURN RECEIPT
    const refundAmount = item.qty * item.unitFinalPrice; 
    const reversedProfit = (item.unitFinalPrice - item.buy) * item.qty;

    const retTrx = {
        id: "RET-" + Date.now().toString().slice(-6),
        date: new Date().toISOString(),
        type: 'return',
        cust: orgTrx.cust, 
        phone: orgTrx.phone,
        items: [{...item}],
        sub: -refundAmount, 
        del: 0, 
        disc: 0, 
        total: -refundAmount, 
        profit: -reversedProfit
    };

    db.transactions.unshift(retTrx);
    save();
    
    closeModal('modal-trx');
    renderHistory(); 
    renderDash();
    alert("Return Processed. Stock Restored to Variant.");
}

        /* --- 5. DASHBOARD LOGIC --- */
  function renderDash() {
    const today = new Date().toISOString().slice(0, 10);
    
    // Filter transactions for TODAY
    const dailyTrx = db.transactions.filter(t => t.date.startsWith(today));
    
    // Calculate Net Totals (Sales + Returns)
    // Since Returns are negative numbers, simply adding them works perfectly!
    const netSales = dailyTrx.reduce((sum, t) => sum + t.total, 0);
    const netProfit = dailyTrx.reduce((sum, t) => sum + t.profit, 0);
    
    // Low Stock Count
    const low = db.products.filter(p => p.stock < 5).length;
    
    // Update UI
    document.getElementById('d-sales').innerText = "‡ß≥" + netSales.toLocaleString();
    document.getElementById('d-profit').innerText = "‡ß≥" + netProfit.toLocaleString();
    document.getElementById('d-low').innerText = low;
    
    // Top Selling Logic (Exclude Returns from "Top Selling" visual)
    let counts = {};
    db.transactions.filter(t => t.type === 'sale').forEach(t => {
        t.items.forEach(i => {
            // Don't count if it was returned later
            if (!i.isReturned) {
                if (!counts[i.name]) counts[i.name] = { q: 0, rev: 0 };
                counts[i.name].q += i.qty;
                counts[i.name].rev += (i.qty * i.actualSell);
            }
        });
    });
    
    const top = Object.keys(counts).sort((a, b) => counts[b].q - counts[a].q).slice(0, 5);
    document.querySelector('#top-table tbody').innerHTML = top.map(k => `
        <tr><td>${k}</td><td>${counts[k].q}</td><td>‡ß≥${counts[k].rev}</td></tr>
    `).join('');
    
    // Recent Activity List
    document.getElementById('recent-list').innerHTML = db.transactions.slice(0, 6).map(t => `
        <div style="padding:10px; border-bottom:1px solid #f1f5f9; display:flex; justify-content:space-between; align-items:center;">
            <div>
                <div style="font-weight:600; font-size:13px;">${t.cust}</div> 
                <div style="font-size:11px; color:#64748b;">${t.type.toUpperCase()} #${t.id}</div>
            </div>
            <div style="font-weight:bold; color:${t.type==='sale'?'var(--success)':'var(--danger)'}">
                ${t.type==='sale' ? '+' : ''}‡ß≥${t.total}
            </div>
        </div>
    `).join('');
}

        function filterLowStock() {
            nav('inventory');
            // simple filter hack
            const rows = document.querySelectorAll('#inv-body tr');
            rows.forEach(r => {
                if(!r.innerHTML.includes('üî¥')) r.style.display = 'none';
            });
        }




        // --- REAL-TIME DUPLICATE CHECKER ---

/* --- UPDATED FEEDBACK LOGIC --- */

function checkMasterUid(val) {
    const box = document.getElementById('uid-feedback');
    const currentId = document.getElementById('p-id').value;
    
    // Reset classes
    box.className = 'feedback-box'; 
    
    if(!val) { box.style.display = 'none'; return; }

    const exist = db.products.find(p => p.uid.toLowerCase() === val.toLowerCase());

    if(exist) {
        if(currentId && exist.id == currentId) {
            box.style.display = 'none'; // Valid (Editing self)
            return;
        }
        // ERROR: Duplicate
        box.classList.add('fb-error');
        box.style.display = 'block';
        box.innerHTML = `
            <span>‚õî <b>UID Taken!</b> product "${exist.name}" uses this code.</span>
            <span class="fb-link" onclick="fillModalFromSearch(${exist.id})">Edit "${exist.name}" instead?</span>
        `;
    } else {
        // SUCCESS: Unique
        box.classList.add('fb-success');
        box.style.display = 'block';
        box.innerHTML = `<span>‚úÖ <b>Available!</b> This UID is unique.</span>`;
    }
}

function checkMasterName(val) {
    const box = document.getElementById('name-feedback');
    
    // Reset
    box.className = 'feedback-box';
    
    if(!val) { box.style.display = 'none'; return; }

    const similar = db.products.filter(p => p.name.toLowerCase().includes(val.toLowerCase()));
    
    if(similar.length > 0) {
        // WARNING: Similar names exist
        box.classList.add('fb-warning');
        box.style.display = 'block';
        const links = similar.slice(0,3).map(p => 
            `<span class="fb-link" onclick="fillModalFromSearch(${p.id})">${p.name}</span>`
        ).join(', ');
        
        box.innerHTML = `<span>üí° <b>Similar Products:</b> ${links}</span>`;
    } else {
        box.style.display = 'none';
    }
}

// Update the Search Result Renderer to match new CSS
/* --- FIXED MAIN SEARCH FOR MODAL --- */
function searchForModal(q) {
    const resDiv = document.getElementById('p-results');
    
    // 1. Safety Check: Hide if input is empty
    if (!q || q.trim().length < 1) {
        resDiv.style.display = 'none';
        return;
    }
    
    const term = q.toLowerCase().trim();

    // 2. Filter Logic: Search EVERYWHERE (Name, UID, Supplier, Variants)
    const matches = db.products.filter(p => {
        // Safe access to strings
        const name = (p.name || "").toLowerCase();
        const uid = (p.uid || "").toLowerCase();
        const sup = (p.sup || "").toLowerCase();
        
        // A. Check Master Details
        if (name.includes(term) || uid.includes(term) || sup.includes(term)) {
            return true;
        }

        // B. Check Child Variants (e.g. searching "RED" or a specific SKU)
        if (p.variants && p.variants.length > 0) {
            return p.variants.some(v => v.sku.toLowerCase().includes(term));
        }

        return false;
    });

    // 3. Render UI: Uses the new CSS classes
    if (matches.length > 0) {
        resDiv.style.display = 'block';
        resDiv.innerHTML = matches.slice(0, 10).map(p => `
            <div class="search-result-row" onclick="fillModalFromSearch(${p.id})">
                <div style="display:flex; flex-direction:column;">
                    <span class="res-title">${p.name}</span>
                    <span class="res-sub">UID: ${p.uid} ‚Ä¢ Sup: ${p.sup || 'N/A'}</span>
                </div>
                <div style="text-align:right;">
                    <span class="res-stock">Stock: ${p.stock}</span>
                </div>
            </div>
        `).join('');
    } else {
        resDiv.style.display = 'none';
    }
}


        /* --- 6. UTILS, SETTINGS & PRINT --- */
        function updateCatDropdowns() {
            const cats = [...new Set(db.products.map(p=>p.cat))];
            const opts = `<option value="">All Categories</option>` + cats.map(c=>`<option value="${c}">${c}</option>`).join('');
            document.getElementById('pos-cat').innerHTML = opts;
            document.getElementById('inv-cat-filter').innerHTML = opts;
            
            // For Add Modal
            const modOpts = cats.map(c=>`<option value="${c}">${c}</option>`).join('') + `<option value="General">General</option>`;
            document.getElementById('p-cat').innerHTML = modOpts;
        }

        function loadSettings() {
            if(db.settings) {
                document.getElementById('set-name').value = db.settings.name;
                document.getElementById('set-addr').value = db.settings.addr;
                document.getElementById('set-phone').value = db.settings.phone;
            }
        }
        function saveSettings() {
            db.settings = {
                name: document.getElementById('set-name').value,
                addr: document.getElementById('set-addr').value,
                phone: document.getElementById('set-phone').value
            };
            save();
        }

        function printReceiptById(id) {
            const t = db.transactions.find(x => x.id === id);
            if(t) printReceipt(t);
        }

      function printReceipt(t) {
    const shop = db.settings || { name: "Shop Name", addr: "Address", phone: "Phone" };
    
    const html = `
        <div style="max-width: 210mm; margin: 0 auto;">
            <div class="print-header">
                <div>
                    <h1 style="margin:0; font-size: 24px; color: #4f46e5;">${shop.name}</h1>
                    <p style="margin:5px 0;">${shop.addr}</p>
                    <p style="margin:0;">üìû ${shop.phone}</p>
                </div>
                <div style="text-align: right;">
                    <h2 style="margin:0; color: #333;">INVOICE</h2>
                    <p style="margin:5px 0;"><b>Bill ID:</b> ${t.id}</p>
                    <p style="margin:0;"><b>Date:</b> ${new Date(t.date).toLocaleString()}</p>
                </div>
            </div>

            <div style="margin-bottom: 20px; padding: 10px; border: 1px solid #eee; border-radius: 5px;">
                <strong>Bill To:</strong> <span style="font-size: 16px;">${t.cust}</span>
                <span style="float:right">Phone: ${t.phone || "N/A"}</span>
            </div>

            <table class="print-table">
                <thead>
                    <tr>
                        <th style="width: 5%;">#</th>
                        <th style="width: 45%;">Item Description</th>
                        <th style="width: 15%; text-align: center;">Rate</th>
                        <th style="width: 10%; text-align: center;">Qty</th>
                        <th style="width: 10%; text-align: center;">Disc%</th>
                        <th style="width: 15%; text-align: right;">Amount</th>
                    </tr>
                </thead>
                <tbody>
                    ${t.items.map((item, index) => `
                        <tr>
                            <td>${index + 1}</td>
                            <td>
                                <b>${item.name}</b>
                                <br><small style="color:#666;">${item.sku || item.uid} ${item.size ? `(${item.color}/${item.size})` : ''}</small>
                            </td>
                            <td style="text-align: center;">${item.actualSell}</td>
                            <td style="text-align: center;">${item.qty}</td>
                            <td style="text-align: center;">${item.discPercent}%</td>
                            <td class="text-right">${(item.qty * item.unitFinalPrice).toFixed(2)}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>

            <div style="display: flex; justify-content: flex-end; margin-top: 20px;">
                <div style="width: 250px;">
                    <div style="display: flex; justify-content: space-between; padding: 5px 0;">
                        <span>Subtotal:</span> <span>${t.sub}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 5px 0; color: red;">
                        <span>Discount:</span> <span>-${t.disc}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 5px 0;">
                        <span>Delivery:</span> <span>+${t.del}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 10px 0; border-top: 2px solid #000; font-weight: bold; font-size: 18px;">
                        <span>Grand Total:</span> <span>‡ß≥${t.total}</span>
                    </div>
                </div>
            </div>

            <div style="margin-top: 50px; border-top: 1px solid #ddd; padding-top: 10px; display: flex; justify-content: space-between; font-size: 12px; color: #666;">
                <div>Authorized Signature</div>
                <div>Software by STOCKED BD</div>
            </div>
        </div>
    `;
    
    document.getElementById('print-area').innerHTML = html;
    window.print();
}

        function exportData() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(db));
            const a = document.createElement('a');
            a.href = dataStr;
            a.download = "stocked_backup_" + Date.now() + ".json";
            a.click();
        }

        function importData(input) {
            const reader = new FileReader();
            reader.onload = e => {
                try {
                    db = JSON.parse(e.target.result);
                    save();
                    location.reload();
                } catch(err) { alert("Invalid File"); }
            };
            reader.readAsText(input.files[0]);
        }

        function factoryReset() {
            if(confirm("PERMANENTLY DELETE ALL DATA?")) {
                localStorage.removeItem(DB_NAME);
                location.reload();
            }
        }

        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        
        // --- HISTORY TABS & LOGIC ---

function switchTab(tab) {
    // Toggle Views
    document.getElementById('view-trans').style.display = tab === 'trans' ? 'block' : 'none';
    document.getElementById('view-logs').style.display = tab === 'logs' ? 'block' : 'none';
    
    // Toggle Buttons
    const btns = document.querySelectorAll('.tab-btn');
    btns.forEach(b => b.classList.remove('active'));
    event.target.classList.add('active');

    if(tab === 'trans') renderHistory();
    if(tab === 'logs') renderProductLogs();
}

// Updated Transaction History with Search
function renderHistory() {
    const tbody = document.getElementById('hist-body');
    tbody.innerHTML = "";
    
    const q = document.getElementById('hist-search').value.toLowerCase();
    const date = document.getElementById('hist-date').value;
    const type = document.getElementById('hist-type').value;

    // Sort by Date Descending (Newest first)
    const sortedTrx = [...db.transactions].sort((a, b) => new Date(b.date) - new Date(a.date));

    sortedTrx.forEach(t => {
        // Filter Logic
        if(date && !t.date.startsWith(date)) return;
        if(type && t.type !== type) return;
        
        // Search Logic
        const searchStr = (t.id + (t.cust||"") + (t.phone||"")).toLowerCase();
        if(q && !searchStr.includes(q)) return;
        
        const tag = t.type === 'sale' ? 
            '<span class="tag tag-sale">SALE</span>' : 
            '<span class="tag tag-return">RETURN</span>';
        
        tbody.innerHTML += `
            <tr>
                <td style="font-family:monospace; color:var(--primary);">${t.id}</td>
                <td style="font-size:12px;">${new Date(t.date).toLocaleString()}</td>
                <td>${tag}</td>
                <td>
                    <div style="font-weight:600;">${t.cust || 'Guest'}</div>
                    <div style="font-size:11px; color:#64748b;">${t.phone || ''}</div>
                </td>
                <td style="font-weight:bold;">‡ß≥${t.total}</td>
                <td>
                    <!-- ENSURE ID IS QUOTED CORRECTLY -->
                    <button class="btn btn-sec btn-sm" onclick="viewTrx('${t.id}')" title="View Details">üëÅ</button>
                    <button class="btn btn-sec btn-sm" onclick="printReceiptById('${t.id}')" title="Print Receipt">üñ®</button>
                </td>
            </tr>
        `;
    });
}

// New Product Log Renderer
function renderProductLogs() {
    const tbody = document.getElementById('log-body');
    
    // Update Header (DOM Manipulation purely via JS to avoid HTML edits)
    const theadRow = document.querySelector('#view-logs thead tr');
    if(theadRow.children.length === 6) {
        // Inject a new header column if it doesn't exist yet
        const th = document.createElement('th');
        th.innerText = "Variant (SKU)";
        theadRow.insertBefore(th, theadRow.children[3]); // Insert after Product Name
    }

    tbody.innerHTML = "";
    const q = document.getElementById('log-search').value.toLowerCase();

    if(!db.productLogs) return;

    db.productLogs.forEach(log => {
        // Filter logic
        const searchStr = (log.name + log.uid + (log.sku||"")).toLowerCase();
        if(q && !searchStr.includes(q)) return;

        // Color code
        let typeColor = 'gray';
        if(log.type.includes('Initial')) typeColor = 'blue';
        if(log.type.includes('Added')) typeColor = 'green';
        if(log.type.includes('Return')) typeColor = '#b91c1c';

        // Handle legacy logs that might not have sku/variant fields
        const variantDisplay = log.sku ? 
            `<b>${log.variant}</b><br><small style="color:#64748b">${log.sku}</small>` : 
            `<span style="color:#ccc">Master</span>`;

        tbody.innerHTML += `
            <tr>
                <td style="font-size:12px;">${new Date(log.date).toLocaleString()}</td>
                <td><b style="color:${typeColor}">${log.type}</b></td>
                <td>${log.name}</td>
                
                <!-- NEW VARIANT COLUMN -->
                <td>${variantDisplay}</td>
                
                <td style="font-family:monospace;">${log.uid}</td>
                <td style="font-weight:bold; color:${log.added > 0 ? 'green' : 'red'};">
                    ${log.added > 0 ? '+' : ''}${log.added}
                </td>
                <td>${log.finalStock}</td>
            </tr>
        `;
    });
}

    </script>
</body>
</html>
