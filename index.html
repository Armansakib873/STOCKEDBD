<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>STOCKED BD | Ultimate POS</title>
    <style>
/* --- 1. CORE THEME & VARIABLES --- */
:root {
    --primary: #4f46e5;
    --primary-dark: #4338ca;
    --primary-light: #eef2ff;
    --bg-body: #f8fafc;
    --bg-surface: #ffffff;
    --text-main: #0f172a;
    --text-muted: #64748b;
    --border: #e2e8f0;
    --border-light: #f1f5f9;
    --success: #10b981;
    --success-light: #d1fae5;
    --danger: #ef4444;
    --danger-light: #fee2e2;
    --warning: #f59e0b;
    --warning-light: #fef3c7;
    --radius: 12px;
    --radius-sm: 8px;
    --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
    --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
    --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
    --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
    --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
}

* { 
    box-sizing: border-box; 
    outline: none;
}

body { 
    font-family: 'Inter', 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
    margin: 0; 
    background: var(--bg-body);
    color: var(--text-main); 
    height: 100vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    font-size: 14px;
    line-height: 1.5;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
}

/* --- 2. ENHANCED HEADER --- */
header {
    background: var(--bg-surface);
    height: 70px;
    border-bottom: 2px solid var(--border);
    padding: 0 30px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    z-index: 100;
    box-shadow: var(--shadow-sm);
    position: sticky;
    top: 0;
}

.brand {
    font-size: 24px;
    font-weight: 900;
    color: var(--primary);
    letter-spacing: -0.8px;
    display: flex;
    align-items: center;
    gap: 10px;
    user-select: none;
}

.brand svg {
    filter: drop-shadow(0 2px 4px rgba(79, 70, 229, 0.3));
}

.brand span {
    font-weight: 400;
    color: var(--text-muted);
    font-size: 15px;
    letter-spacing: 0;
}

.nav-bar {
    background: var(--bg-body);
    padding: 6px;
    border-radius: var(--radius);
    border: 1px solid var(--border);
    display: flex;
    gap: 6px;
    box-shadow: var(--shadow-sm);
}

.nav-item {
    padding: 10px 18px;
    border: none;
    background: transparent;
    color: var(--text-muted);
    font-weight: 600;
    font-size: 14px;
    cursor: pointer;
    border-radius: var(--radius-sm);
    transition: var(--transition);
    position: relative;
}

.nav-item:hover {
    color: var(--primary);
    background: var(--primary-light);
    transform: translateY(-1px);
}

.nav-item.active {
    background: var(--bg-surface);
    color: var(--primary);
    box-shadow: var(--shadow);
}

.nav-item.active::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 50%;
    transform: translateX(-50%);
    width: 30px;
    height: 3px;
    background: var(--primary);
    border-radius: 2px 2px 0 0;
}

/* --- 3. MAIN LAYOUT --- */
main {
    flex: 1;
    overflow-y: auto;
    padding: 30px;
    max-width: 1800px;
    margin: 0 auto;
    width: 100%;
}

.section {
    display: none;
    animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}

.section.active {
    display: block;
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* --- 4. ENHANCED DASHBOARD --- */
.shortcut-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 18px;
    margin-bottom: 30px;
}

.shortcut-card {
    background: linear-gradient(135deg, var(--bg-surface) 0%, #fafbfc 100%);
    padding: 20px;
    border-radius: var(--radius);
    border: 2px solid var(--border);
    cursor: pointer;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 12px;
    color: var(--text-main);
    transition: var(--transition);
    font-size: 15px;
    position: relative;
    overflow: hidden;
}


.shortcut-card:hover {
    border-color: var(--primary);
    color: var(--primary);
    transform: translateY(-4px);
    box-shadow: var(--shadow-lg);
}

.shortcut-card:hover::before {
    transform: scaleX(1);
}

.stats-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 24px;
    margin-bottom: 30px;
}

.stat-box {
    background: var(--bg-surface);
    padding: 24px;
    border-radius: var(--radius);
    border: 2px solid var(--border);
    position: relative;
    overflow: hidden;
    cursor: pointer;
    transition: var(--transition);
}


.stat-box:hover {
    box-shadow: var(--shadow-lg);
    transform: translateY(-2px);
}

.stat-box:hover::before {
    transform: scaleY(1);
}

.stat-label {
    font-size: 12px;
    color: var(--text-muted);
    text-transform: uppercase;
    font-weight: 700;
    letter-spacing: 0.5px;
    margin-bottom: 8px;
}

.stat-value {
    font-size: 36px;
    font-weight: 900;
    margin-top: 8px;
    color: var(--text-main);
    letter-spacing: -1px;
}

.stat-box.alert {
    border-color: var(--danger-light);
    background: linear-gradient(135deg, #fff 0%, #fef2f2 100%);
}

.stat-box.alert .stat-value {
    color: var(--danger);
}

.dashboard-split {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 30px;
}

.panel {
    background: var(--bg-surface);
    border: 2px solid var(--border);
    border-radius: var(--radius);
    overflow: hidden;
    box-shadow: var(--shadow-sm);
}

.panel-head {
    padding: 18px 24px;
    background: linear-gradient(to right, #f8fafc, #f1f5f9);
    border-bottom: 2px solid var(--border);
    font-weight: 800;
    font-size: 15px;
    color: var(--text-main);
}

/* --- OPTIMIZED POS LAYOUT --- */

/* 1. Main Container Adjustment */
.pos-container {
    display: grid;
    /* Reduced cart width from 450px to 360px to give product grid more room */
    grid-template-columns: 1fr 360px; 
    gap: 16px;
    /* Calculates exact height to prevent body scroll */
    height: calc(100vh - 100px); 
    padding-bottom: 10px;
}

/* 2. Left Side (Search + Grid) */
.pos-left {
    display: flex;
    flex-direction: column;
    gap: 12px;
    overflow: hidden;
    height: 100%;
}

/* Compact Search Bar Area */
.search-bar-container {
    display: flex;
    gap: 10px;
    height: 45px; /* Fixed height for consistency */
}

.search-bar-container input {
    flex: 1;
    height: 100%;
}

.search-bar-container select {
    width: 150px;
    height: 100%;
}

/* 3. Denser Product Grid */
.product-grid {
    display: grid;
    /* Smaller minimum width (130px) allows more columns */
    grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); 
    gap: 10px;
    overflow-y: auto;
    padding: 4px;
    padding-bottom: 60px; /* Space for scrolling */
    align-content: start;
}

/* Compact POS Card */
.pos-card {
    background: var(--bg-surface);
    border: 1px solid var(--border); /* Thinner border */
    padding: 10px; /* Reduced padding */
    border-radius: var(--radius-sm);
    cursor: pointer;
    position: relative;
    transition: var(--transition);
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    gap: 4px;
    min-height: 100px; /* Reduced min-height */
}

.pos-card:hover {
    border-color: var(--primary);
    box-shadow: var(--shadow);
    transform: translateY(-2px);
}

.pos-card h4 {
    margin: 0;
    font-size: 13px; /* Slightly smaller font */
    line-height: 1.2;
    font-weight: 700;
    color: var(--text-main);
    padding-right: 20px; /* Make room for stock tag */
}

.pos-card .code {
    font-size: 11px;
    color: var(--text-muted);
}

.pos-card .price {
    font-size: 14px;
    font-weight: 800;
    color: var(--primary);
    margin-top: 4px;
}

.stock-tag {
    position: absolute;
    top: 6px;
    right: 6px;
    background: var(--primary-light);
    color: var(--primary);
    font-size: 10px;
    padding: 2px 6px;
    border-radius: 4px;
}

/* 4. Optimized Right Panel (Cart) */
.pos-right {
    background: var(--bg-surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    display: flex;
    flex-direction: column;
    overflow: hidden;
    height: 100%; /* Fill container height */
    box-shadow: var(--shadow);
}

/* Compact Cart Header */
.cart-header {
    padding: 12px;
    background: #fff;
    border-bottom: 1px solid var(--border);
    flex-shrink: 0;
}

/* Customer Input Row - Compact */
.customer-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
}

.customer-grid input {
    padding: 8px;
    font-size: 12px;
}

/* Scrollable Cart List Area */
.cart-list {
    flex: 1; /* Takes up all available remaining space */
    overflow-y: auto;
    padding: 0;
    background: #fdfdfd;
}

.cart-item {
    padding: 8px 12px;
    border-bottom: 1px solid var(--border-light);
    font-size: 12px;
}

.cart-item-top {
    display: flex;
    justify-content: space-between;
    margin-bottom: 4px;
}

.cart-controls {
    display: flex;
    align-items: center;
    gap: 6px;
}

.cart-input {
    width: 50px;
    padding: 4px;
    font-size: 12px;
    height: 28px;
}

.btn-icon-sm {
    width: 28px;
    height: 28px;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0;
}

/* Sticky Footer (Totals + Pay Button) */
.cart-footer {
    padding: 12px;
    background: #fff;
    border-top: 1px solid var(--border);
    flex-shrink: 0; /* Prevents footer from shrinking */
    box-shadow: 0 -4px 10px rgba(0,0,0,0.02);
}

.total-row {
    margin-bottom: 6px;
    font-size: 12px;
}

.input-sm-row {
    display: flex;
    justify-content: flex-end;
    align-items: center;
    gap: 8px;
}

.input-sm-row input {
    width: 70px;
    padding: 4px;
    text-align: right;
}

.grand-total {
    margin: 10px 0;
    font-size: 18px;
    padding-top: 10px;
    border-top: 1px dashed var(--border);
}

.btn-pay {
    width: 100%;
    padding: 12px;
    font-size: 15px;
    justify-content: center;
}

/* Responsive Tweak for smaller screens */
@media (max-width: 1366px) {
    .pos-container {
        grid-template-columns: 1fr 320px; /* Even smaller cart on laptops */
    }
    
    .product-grid {
        grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
    }
}

/* --- 6. ENHANCED INVENTORY & TABLES --- */
.toolbar {
    display: flex;
    justify-content: space-between;
    margin-bottom: 20px;
    gap: 15px;
    flex-wrap: wrap;
    align-items: center;
}

.search-box {
    flex: 1;
    max-width: 450px;
    position: relative;
}

.table-wrap {
    background: var(--bg-surface);
    border: 2px solid var(--border);
    border-radius: var(--radius);
    overflow: hidden;
    box-shadow: var(--shadow);
}

table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
}

th {
    background: linear-gradient(to bottom, #f8fafc, #f1f5f9);
    padding: 14px 18px;
    text-align: left;
    border-bottom: 2px solid var(--border);
    color: var(--text-muted);
    cursor: pointer;
    user-select: none;
    font-weight: 700;
    text-transform: uppercase;
    font-size: 11px;
    letter-spacing: 0.5px;
    transition: var(--transition);
}

th:hover {
    background: #e2e8f0;
    color: var(--primary);
}

td {
    padding: 14px 18px;
    border-bottom: 1px solid var(--border-light);
}

tr:hover td {
    background: var(--border-light);
}

tr:last-child td {
    border-bottom: none;
}

/* --- 7. ENHANCED BUTTONS --- */
.btn {
    padding: 10px 20px;
    border-radius: var(--radius-sm);
    border: none;
    font-weight: 600;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
    transition: var(--transition);
    position: relative;
    overflow: hidden;
}

.btn::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 0;
    height: 0;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.3);
    transform: translate(-50%, -50%);
    transition: width 0.3s, height 0.3s;
}

.btn:active::before {
    width: 300px;
    height: 300px;
}

.btn-primary {
    background: rgb(36, 87, 230);
    color: white;
    box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
}

.btn-primary:hover {
    background: var(--primary-dark);
    box-shadow: 0 6px 20px rgba(205, 229, 70, 0.4);
    transform: translateY(-2px);
}

.btn-sec {
    background: white;
    border: 2px solid var(--border);
    color: var(--text-main);
}

.btn-sec:hover {
    background: var(--border-light);
    border-color: var(--primary);
    color: var(--primary);
    transform: translateY(-1px);
}

.btn-danger {
    background: var(--danger-light);
    color: var(--danger);
    border: 2px solid transparent;
}

.btn-danger:hover {
    background: var(--danger);
    color: white;
    transform: translateY(-1px);
}

.btn-sm {
    padding: 6px 12px;
    font-size: 12px;
}

/* --- 8. ENHANCED FORM INPUTS --- */
input, select {
    padding: 10px 14px;
    border: 2px solid var(--border);
    border-radius: var(--radius-sm);
    width: 100%;
    font-size: 14px;
    transition: var(--transition);
    background: var(--bg-surface);
}

input:focus, select:focus {
    border-color: var(--primary);
    box-shadow: 0 0 0 4px var(--primary-light);
}

input[type="number"]::-webkit-inner-spin-button,
input[type="number"]::-webkit-outer-spin-button {
    opacity: 1;
}

/* --- 9. ENHANCED MODALS --- */
.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(15, 23, 42, 0.7);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    backdrop-filter: blur(8px);
    animation: fadeIn 0.2s;
}

.modal-box {
    background: #ffffff;
    width: 700px;
    max-width: 95vw;
    max-height: 90vh;
    padding: 35px;
    border-radius: 20px;
    box-shadow: var(--shadow-xl);
    display: flex;
    flex-direction: column;
    gap: 24px;
    position: relative;
    animation: popIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    overflow-y: auto;
}

@keyframes popIn {
    from {
        transform: scale(0.9);
        opacity: 0;
    }
    to {
        transform: scale(1);
        opacity: 1;
    }
}

.modal-box h2, .modal-box h3 {
    margin: 0;
    color: var(--text-main);
}

/* --- 10. TAGS & BADGES --- */
.tag {
    padding: 4px 12px;
    border-radius: 16px;
    font-size: 11px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    display: inline-block;
}

.tag-sale {
    background: var(--success-light);
    color: #166534;
}

.tag-return {
    background: var(--danger-light);
    color: #991b1b;
}

/* --- 11. TABS --- */
.tab-container {
    display: flex;
    gap: 12px;
    margin-bottom: 24px;
    border-bottom: 2px solid var(--border);
}

.tab-btn {
    padding: 12px 24px;
    background: none;
    border: none;
    font-weight: 600;
    color: var(--text-muted);
    cursor: pointer;
    border-bottom: 3px solid transparent;
    transition: var(--transition);
    font-size: 14px;
}

.tab-btn:hover {
    color: var(--primary);
    background: var(--primary-light);
}

.tab-btn.active {
    color: var(--primary);
    border-bottom-color: var(--primary);
}

/* --- 12. SEARCH COMPONENTS --- */
.search-wrapper {
    position: relative;
    z-index: 50;
}

.search-input {
    width: 100%;
    padding: 16px 20px;
    padding-left: 50px;
    border: 2px solid var(--border);
    border-radius: var(--radius);
    font-size: 15px;
    transition: var(--transition);
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2394a3b8' stroke-width='2'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' d='M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z' /%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: 18px center;
    background-size: 22px;
}

.search-input:focus {
    border-color: var(--primary);
    box-shadow: 0 0 0 4px var(--primary-light);
}

.search-results {
    position: absolute;
    top: 110%;
    left: 0;
    width: 100%;
    background: white;
    border: 2px solid var(--border);
    border-radius: var(--radius);
    max-height: 350px;
    overflow-y: auto;
    box-shadow: var(--shadow-xl);
    display: none;
    animation: slideDown 0.2s ease-out;
    z-index: 100;
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.search-result-row, .search-item {
    padding: 14px 18px;
    border-bottom: 1px solid var(--border-light);
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: var(--transition);
}

.search-result-row:hover, .search-item:hover {
    background-color: var(--primary-light);
    color: var(--primary);
}

.search-result-row:last-child, .search-item:last-child {
    border-bottom: none;
}

.res-title {
    font-weight: 700;
    color: var(--text-main);
    display: block;
    font-size: 14px;
}

.res-sub {
    font-size: 12px;
    color: var(--text-muted);
    font-family: 'Courier New', monospace;
    margin-top: 2px;
}

.res-stock {
    font-size: 11px;
    background: var(--border);
    padding: 4px 10px;
    border-radius: 12px;
    font-weight: 700;
}

/* --- 13. FEEDBACK BOXES --- */
.feedback-box {
    margin-top: 8px;
    font-size: 12px;
    padding: 10px 14px;
    border-radius: var(--radius-sm);
    display: none;
    animation: fadeIn 0.3s;
    line-height: 1.5;
    font-weight: 500;
}

.fb-success {
    background-color: var(--success-light);
    color: #15803d;
    border: 2px solid #86efac;
}

.fb-error {
    background-color: var(--danger-light);
    color: #b91c1c;
    border: 2px solid #fca5a5;
}

.fb-warning {
    background-color: var(--warning-light);
    color: #c2410c;
    border: 2px solid #fcd34d;
}

.fb-link {
    text-decoration: underline;
    font-weight: 700;
    cursor: pointer;
    margin-left: 6px;
    transition: var(--transition);
}

.fb-link:hover {
    opacity: 0.7;
}

/* --- 14. VARIANT COMPONENTS --- */
.variant-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 12px;
    font-size: 13px;
}

.variant-table th {
    background: var(--border-light);
    padding: 10px 12px;
    text-align: left;
    border: 1px solid var(--border);
    font-weight: 700;
    font-size: 11px;
    text-transform: uppercase;
    color: var(--text-muted);
}

.variant-table td {
    padding: 8px 12px;
    border: 1px solid var(--border);
}

.v-input {
    width: 100%;
    border: none;
    background: transparent;
    outline: none;
    font-weight: 600;
}

.btn-icon {
    padding: 6px 10px;
    background: var(--danger-light);
    color: var(--danger);
    border-radius: var(--radius-sm);
    border: none;
    cursor: pointer;
    font-weight: 700;
    transition: var(--transition);
}

.btn-icon:hover {
    background: var(--danger);
    color: white;
}

.v-selector-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
    gap: 12px;
    margin-top: 18px;
}

.v-select-card {
    background: var(--border-light);
    border: 2px solid var(--border);
    padding: 14px;
    border-radius: var(--radius-sm);
    cursor: pointer;
    text-align: center;
    transition: var(--transition);
}

.v-select-card:hover {
    border-color: var(--primary);
    background: var(--primary-light);
    transform: translateY(-2px);
    box-shadow: var(--shadow);
}

.v-stock-badge {
    font-size: 10px;
    background: var(--border);
    padding: 3px 8px;
    border-radius: 10px;
    font-weight: 700;
    margin-top: 6px;
    display: inline-block;
}

/* --- 15. PRINT STYLES --- */
#print-area {
    display: none;
}

/* Scoped specifically for #category-manager */
#category-manager h3 {
    color: #222;
    font-size: 1.2rem;
    margin-bottom: 8px;
}

#category-manager .cat-input-container {
    display: flex;
    gap: 10px;
    margin-bottom: 12px;
}

#category-manager #new-cat {
    flex: 1;
    padding: 8px 12px;
    border: 1px solid #ccc;
    border-radius: 6px;
    font-size: 1rem;
    transition: border-color 0.2s;
}

#category-manager #new-cat:focus {
    border-color: #007bff;
    outline: none;
}

#category-manager .btn-add-cat {
    padding: 8px 16px;
    background-color: #007bff;
    color: #fff;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    transition: background-color 0.2s;
}

#category-manager .btn-add-cat:hover {
    background-color: #0056b3;
}

#category-manager #cat-list {
    list-style: none;
    padding: 0;
    margin: 0;
}

#category-manager #cat-list li {
    background-color: #fff;
    padding: 10px 15px;
    margin-bottom: 8px;
    border: 1px solid #ddd;
    border-radius: 6px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: box-shadow 0.2s;
}

#category-manager #cat-list li:hover {
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
}

#category-manager #cat-list li button {
    background-color: #dc3545;
    border: none;
    color: white;
    padding: 4px 8px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.9rem;
}

#category-manager #cat-list li button:hover {
    background-color: #c82333;
}


.input-tiny {
    width: 60px;
    padding: 4px;
    text-align: right;
    border: 1px solid var(--border);
    border-radius: 4px;
}

.badge-due {
    background-color: #fee2e2;
    color: #b91c1c;
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 11px;
    font-weight: 700;
}

.badge-paid {
    background-color: #dcfce7;
    color: #15803d;
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 11px;
    font-weight: 700;
}

.balance-red { color: #dc2626; } /* For Due */
.balance-green { color: #16a34a; } /* For Change Return */



/* Eye Button Style */
.btn-eye {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 14px;
    padding: 0 5px;
    color: var(--text-muted);
    transition: color 0.2s;
    position: relative; /* For positioning the popup */
}

.btn-eye:hover {
    color: var(--primary);
}

/* The Hidden Cost Popup */
.cost-popup {
    display: none; /* Hidden by default */
    position: absolute;
    bottom: 100%; /* Shows above the eye */
    left: 50%;
    transform: translateX(-50%);
    background-color: #334155;
    color: #fff;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 10px;
    white-space: nowrap;
    z-index: 10;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    font-weight: bold;
}

/* Tiny arrow for the popup */
.cost-popup::after {
    content: "";
    position: absolute;
    top: 100%;
    left: 50%;
    margin-left: -4px;
    border-width: 4px;
    border-style: solid;
    border-color: #334155 transparent transparent transparent;
}

@media print {
    body * {
        visibility: hidden;
        height: 0;
        overflow: hidden;
    }

    #print-area, #print-area * {
        visibility: visible;
        height: auto;
    }

    #print-area {
        display: block !important;
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        padding: 40px;
        background: white;
        font-family: 'Segoe UI', sans-serif;
        color: black;
    }

    @page {
        size: A4;
        margin: 0;
    }

    .print-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
    }

    .print-table th {
        border-bottom: 2px solid #000;
        text-align: left;
        padding: 8px;
    }

    .print-table td {
        border-bottom: 1px solid #ddd;
        padding: 8px;
    }

    .text-right {
        text-align: right;
    }

    .print-header {
        display: flex;
        justify-content: space-between;
        border-bottom: 2px solid #000;
        padding-bottom: 20px;
        margin-bottom: 20px;
    }
}

/* --- 16. RESPONSIVE ADJUSTMENTS --- */
@media (max-width: 1200px) {
    .pos-container {
        grid-template-columns: 1fr 400px;
    }

    .dashboard-split {
        grid-template-columns: 1fr;
    }
}

@media (max-width: 768px) {
    header {
        padding: 0 15px;
    }

    main {
        padding: 15px;
    }

    .pos-container {
        grid-template-columns: 1fr;
        height: auto;
    }

    .nav-bar {
        overflow-x: auto;
    }

    .toolbar {
        flex-direction: column;
    }

    .search-box {
        max-width: 100%;
    }
}

/* --- 17. UTILITY CLASSES --- */
.text-primary { color: var(--primary); }
.text-success { color: var(--success); }
.text-danger { color: var(--danger); }
.text-muted { color: var(--text-muted); }
.font-bold { font-weight: 700; }
.font-extrabold { font-weight: 800; }

    </style>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

    <!-- HEADER -->
    <header>
        <div class="brand">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 7h-9"/><path d="M14 17H5"/><circle cx="17" cy="17" r="3"/><circle cx="7" cy="7" r="3"/></svg>
            STOCKED <span style="font-weight:400; color:var(--text-muted); font-size:14px;">Ultimate</span>
        </div>
        <div class="nav-bar">
            <button class="nav-item active" onclick="nav('dashboard')">Dashboard</button>
            <button class="nav-item" onclick="nav('pos')">POS System</button>
            <button class="nav-item" onclick="nav('inventory')">Inventory</button>
            <button class="nav-item" onclick="nav('history')">History</button>
             <button class="nav-item" onclick="nav('due-section')">Due List</button> 
            <button class="nav-item" onclick="nav('settings')">Settings</button>
        </div>
    </header>

    <main>
        <!-- 1. DASHBOARD -->
        <div id="dashboard" class="section active">
            <div class="shortcut-grid">
                <div class="shortcut-card" onclick="nav('pos')">‚ö° Quick Sale</div>
                <div class="shortcut-card" onclick="openProdModal()">üì¶ New Product</div>
                <div class="shortcut-card" onclick="filterLowStock()">‚ö†Ô∏è Low Stock</div>
                <div class="shortcut-card" onclick="nav('history')">üìÑ View Reports</div>
            </div>

            <div class="stats-row">
                <div class="stat-box">
                    <div class="stat-label">Total Sales (Today)</div>
                    <div class="stat-value" style="color: var(--primary);" id="d-sales">0</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Net Profit (Today)</div>
                    <div class="stat-value" style="color: var(--success);" id="d-profit">0</div>
                </div>
                <div class="stat-box alert" onclick="filterLowStock()">
                    <div class="stat-label">Low Stock Items</div>
                    <div class="stat-value" id="d-low">0</div>
                    <div style="font-size:11px; color:var(--danger); margin-top:5px;">Click to manage</div>
                </div>
            </div>

            <div class="dashboard-split">
                <div class="panel">
                    <div class="panel-head">üî• Top Selling Products</div>
                    <table id="top-table">
                        <thead><tr><th>Product</th><th>Sold</th><th>Revenue</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div class="panel">
                    <div class="panel-head">üïí Recent Activity</div>
                    <div id="recent-list" style="padding:10px;"></div>
                </div>
            </div>
        </div>

        <!-- 2. POS SYSTEM -->
        <div id="pos" class="section">
            <div class="pos-container">
                <!-- LEFT: PRODUCTS -->
                <div class="pos-left">
                    <div style="display:flex; gap:10px;">
                        <input type="text" id="pos-search" placeholder="Scan Barcode or Search Name..." onkeyup="renderPOS()" autofocus>
                        <select id="pos-cat" onchange="renderPOS()" style="width:150px;">
                            <option value="">All Categories</option>
                        </select>
                    </div>
                    <div class="product-grid" id="pos-grid"></div>
                </div>

                <!-- RIGHT: CART -->
                <div class="pos-right">
                    <div class="cart-header">
                        <h3 style="margin:0 0 10px 0;">Current Order</h3>
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                            <input id="cust-name" placeholder="Customer Name">
                            <input id="cust-phone" placeholder="Phone Number">
                        </div>
                    </div>
                    <div class="cart-list" id="cart-list">
                        <!-- Items Injected Here -->
                    </div>
                   <!-- UPDATE THIS SECTION IN YOUR HTML -->
<div class="cart-footer">
    <div class="total-row"><span>Subtotal:</span> <span id="c-sub">0</span></div>
    
    <div class="total-row">
        <span>Delivery Charge:</span> 
        <input type="number" id="c-del" value="0" class="input-tiny" onchange="updateCartTotals()">
    </div>
    
    <div class="total-row" style="align-items: center;">
        <span>Discount (%):</span> 
        <input type="number" id="c-disc-global" placeholder="0" class="input-tiny" oninput="applyGlobalDiscount(this.value)">
    </div>

    <!-- NEW PAY/DUE SECTION -->
    <div style="margin: 10px 0; border-top: 1px dashed var(--border); padding-top:10px;">
        <div class="total-row" style="font-size: 16px; font-weight:800; color:var(--text-main);">
            <span>Net Payable:</span> <span id="c-total">0</span>
        </div>
        
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:8px;">
            <div>
                <label style="font-size:11px; color:var(--text-muted);">Paid Amount</label>
                <input type="number" id="c-paid" placeholder="Enter Amount" 
                       style="font-weight:bold; color:var(--success);" 
                       onkeyup="updateDueCalc()">
            </div>
            <div>
                <label style="font-size:11px; color:var(--text-muted);">Balance / Due</label>
                <div id="c-balance-display" 
                     style="background:#f1f5f9; padding:10px; border-radius:8px; text-align:right; font-weight:bold; color:var(--text-main);">
                    0
                </div>
            </div>
        </div>
    </div>
    
    <button class="btn btn-primary" style="width:100%; justify-content:center; padding:12px;" onclick="processCheckout()">
        ‚úÖ Complete Sale
    </button>
</div>
                </div>
            </div>
        </div>

        <!-- 3. INVENTORY -->
        <div id="inventory" class="section">
            <div class="toolbar">
                <div class="search-box">
                    <input id="inv-search" placeholder="Search by UID or Name..." onkeyup="renderInv()">
                </div>
                <select id="inv-cat-filter" onchange="renderInv()" style="width:180px;">
                    <option value="">All Categories</option>
                </select>
                <button class="btn btn-primary" onclick="openProdModal()">+ Add New Product</button>
            </div>
            <div class="table-wrap">
                <table>
                    <thead>
                        <tr>
                            <th onclick="sortInv('uid')">UID ‚Üï</th>
                            <th onclick="sortInv('name')">Product Name ‚Üï</th>
                            <th>Category</th>
                            <th>Supplier</th>
                            <th>Cost</th>
                            <th>Price</th>
                            <th onclick="sortInv('stock')">Stock ‚Üï</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="inv-body"></tbody>
                </table>
            </div>
        </div>

       <!-- 4. HISTORY & REPORTS -->
<div id="history" class="section">
    
    <!-- TABS -->
    <div class="tab-container">
 <button class="tab-btn active" onclick="switchTab('trans')">Sales & Returns</button>
        <button class="tab-btn" onclick="switchTab('batches')">üì¶ Batch Logs</button> <!-- NEW -->
        <button class="tab-btn" onclick="switchTab('logs')">Item Logs</button>
    </div>

    <!-- VIEW 1: SALES TRANSACTIONS -->
    <div id="view-trans">
        <div class="toolbar">
            <div style="display:flex; gap:10px; flex:1;">
                <!-- NEW: Search Bar for History -->
                <input id="hist-search" placeholder="üîç Search Bill ID, Customer or Phone..." onkeyup="renderHistory()">
                
                <input type="date" id="hist-date" onchange="renderHistory()" style="width:150px;">
                <select id="hist-type" onchange="renderHistory()" style="width:150px;">
                    <option value="">All Types</option>
                    <option value="sale">Sales</option>
                    <option value="return">Returns</option>
                </select>
            </div>
            <button class="btn btn-sec" onclick="renderHistory()">üîÑ Refresh</button>
        </div>
        <div class="table-wrap">
            <table>
                <thead><tr><th>ID</th><th>Date</th><th>Type</th><th>Customer</th><th>Total</th><th>Actions</th></tr></thead>
                <tbody id="hist-body"></tbody>
            </table>
        </div>
    </div>

       <!-- 2. NEW BATCH VIEW CONTAINER -->
    <div id="view-batches" style="display:none;">
        <div class="toolbar">
            <div class="search-box">
                <input id="batch-search" placeholder="Search Batch Ref or Supplier..." onkeyup="renderBatchLogs()">
            </div>
        </div>
        <div class="table-wrap">
            <table>
                <thead>
                    <tr>
                        <th>Batch Ref</th>
                        <th>Date</th>
                        <th>Supplier</th>
                        <th>Items Qty</th>
                        <th>Total Cost (Landed)</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="batch-body"></tbody>
            </table>
        </div>
    </div>


    <!-- VIEW 2: PRODUCT LOGS (NEW) -->
    <div id="view-logs" style="display:none;">
        <div class="toolbar">
            <div class="search-box">
                <input id="log-search" placeholder="üîç Search Log by Product Name or UID..." onkeyup="renderProductLogs()">
            </div>
        </div>
        <div class="table-wrap">
            <table>
<thead>
    <tr>
        <th>Date</th>
        <th>Batch Ref</th> <!-- NEW COLUMN -->
        <th>Action Type</th>
        <th>Product</th>
        <th>UID/SKU</th>
        <th>Qty</th>
    </tr>
</thead>
                <tbody id="log-body"></tbody>
            </table>
        </div>
    </div>
</div>


<!-- 6. DUE MANAGEMENT SECTION -->
<div id="due-section" class="section">
    <div class="toolbar">
        <h2 style="margin:0;">üìí Due Book Management</h2>
        <div class="search-box">
            <input id="due-search" placeholder="Search Customer Name or Phone..." onkeyup="renderDueList()">
        </div>
    </div>

    <div class="dashboard-split">
        <!-- LIST OF DEBTORS -->
        <div class="panel">
            <div class="panel-head">Unpaid Invoices</div>
            <div class="table-wrap" style="max-height: 70vh; overflow-y:auto;">
                <table style="width:100%;">
                    <thead>
                        <tr>
                            <th>Bill ID</th>
                            <th>Date</th>
                            <th>Customer</th>
                            <th>Total Bill</th>
                            <th>Paid</th>
                            <th>Due Amount</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="due-body"></tbody>
                </table>
            </div>
        </div>

        <!-- PAYMENT ACTION PANEL -->
        <div class="panel" style="height:fit-content;">
            <div class="panel-head">Collect Payment</div>
            <div id="due-action-panel" style="padding:20px; text-align:center; color:var(--text-muted);">
                Select an invoice from the list to collect payment.
            </div>
        </div>
    </div>
</div>

        <!-- 5. SETTINGS -->
        <div id="settings" class="section">
            <h2>‚öôÔ∏è Settings & Data</h2>
            <div style="max-width:600px; background:white; padding:20px; border-radius:8px; border:1px solid var(--border);">
                
                <h3>Shop Details (For Receipt)</h3>
                <div style="display:grid; gap:10px; margin-bottom:20px;">
                    <input id="set-name" placeholder="Shop Name" onchange="saveSettings()">
                    <input id="set-addr" placeholder="Address" onchange="saveSettings()">
                    <input id="set-phone" placeholder="Phone" onchange="saveSettings()">
                </div>

                
                
<div id="category-manager">
    <h3>Manage Categories</h3>
    <div id="cat-list"></div>
    <h3>Categories</h3>
    <div class="cat-input-container">
        <input id="new-cat" placeholder="New Category Name">
        <button class="btn-add-cat" onclick="addCategory()">Add</button>
    </div>
    <ul id="cat-list"></ul>
</div>




                <h3>Data Backup</h3>
                <p style="color:var(--text-muted); font-size:13px;">Download your data regularly to avoid loss.</p>
                <div style="display:flex; gap:10px; margin-bottom:20px;">
                    <button class="btn btn-primary" onclick="exportData()">‚¨áÔ∏è Export Backup</button>
                    <button class="btn btn-sec" onclick="document.getElementById('file-in').click()">‚¨ÜÔ∏è Restore Data</button>
                    <input type="file" id="file-in" hidden onchange="importData(this)">
                </div>
                
                <hr>
                <button class="btn btn-danger" onclick="factoryReset()" style="margin-top:10px;">‚ö†Ô∏è Factory Reset</button>
            </div>
        </div>
    </main>

    <!-- MODALS -->
    
<!-- MODAL: PRODUCT & VARIANT MASTER -->
<div id="modal-prod" class="modal">
    <div class="modal-box">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2 id="m-title" style="margin:0;">Product Manager</h2>
            <button onclick="closeModal('modal-prod')" style="background:none; border:none; font-size:20px; cursor:pointer;">&times;</button>
        </div>
        
        <!-- 1. MAIN SPOTLIGHT SEARCH -->
       <div class="search-wrapper">
    <input id="p-search" class="search-input" 
           placeholder="Scan Barcode, Type Name or UID to Edit..." 
           onkeyup="searchForModal(this.value)" 
           autocomplete="off">
    <div id="p-results" class="search-results"></div>
</div>

        <input type="hidden" id="p-id"> 


        

        <!-- MASTER DETAILS SECTION -->
        <div style="background: #f8fafc; padding: 20px; border-radius: 12px; border: 1px solid #e2e8f0;">
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-bottom:15px;">
                <!-- UID INPUT WITH FEEDBACK -->
                <div>
                    <label style="font-size:12px; font-weight:600; color:#64748b;">Master UID (Style Code)</label>
                    <input id="p-uid" placeholder="e.g. 1001" onkeyup="checkMasterUid(this.value)" autocomplete="off">
                    <!-- The Feedback Div -->
                    <div id="uid-feedback" class="feedback-box"></div>
                </div>
                <div>
                    <label style="font-size:12px; font-weight:600; color:#64748b;">Category</label>
                    <select id="p-cat" style="padding:10px;"></select>
                </div>
            </div>
            
            <!-- NAME INPUT WITH FEEDBACK -->
            <div style="margin-bottom:15px;">
                <label style="font-size:12px; font-weight:600; color:#64748b;">Product Name</label>
                <input id="p-name" onkeyup="checkMasterName(this.value)" autocomplete="off">
                <!-- The Feedback Div -->
                <div id="name-feedback" class="feedback-box"></div>
            </div>

<!-- UPDATED COST & PRICE SECTION -->
<div style="margin-top:15px; border-top:1px solid #e2e8f0; padding-top:15px;">
    
    <!-- LANDED COST CALCULATOR -->
    <div style="background:#eff6ff; padding:12px; border-radius:8px; border:1px solid #dbeafe; margin-bottom:15px;">
        <div style="font-size:11px; font-weight:700; color:#1e40af; margin-bottom:8px; display:flex; justify-content:space-between;">
            <span>üìâ LANDED COST CALCULATOR</span>
        </div>
        
        <!-- Inputs -->
        <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px; margin-bottom:10px;">
            <div>
                <label style="font-size:10px; color:#475569;">Supplier Unit Price</label>
                <input type="number" id="p-buy-base" placeholder="e.g. 500" class="v-input" 
                       style="background:white; border:1px solid #cbd5e1; padding:6px;" 
                       onkeyup="calcLandedCost()">
            </div>
            <div>
                <label style="font-size:10px; color:#475569;">Batch Extra Cost</label>
                <input type="number" id="p-buy-extra" placeholder="Total Ship Cost" class="v-input" 
                       style="background:white; border:1px solid #cbd5e1; padding:6px;" 
                       onkeyup="calcLandedCost()">
            </div>
            <div>
                <label style="font-size:10px; color:#1e40af; font-weight:bold;">Final Cost / Item</label>
                <input type="number" id="p-buy" readonly 
                       style="background:#dbeafe; border:1px solid #93c5fd; padding:6px; font-weight:bold; color:#1e3a8a;">
            </div>
        </div>

        <!-- NEW: BATCH SUMMARY FOOTER -->
        <div style="border-top:1px dashed #93c5fd; padding-top:8px; display:flex; justify-content:space-between; font-size:12px; color:#1e3a8a;">
            <div>
                Total Products: <strong><span id="summary-total-qty">0</span> pcs</strong>
            </div>
            <div>
                Total Investment: <strong>‡ß≥<span id="summary-total-cost">0</span></strong>
            </div>
        </div>
    </div>

    <!-- SELLING PRICE & SUPPLIER -->
    <div style="display:grid; grid-template-columns: 2fr 1fr; gap:15px;">
        <div>
            <label style="font-size:12px; font-weight:600; color:#64748b;">Supplier Name</label>
            <input id="p-sup" placeholder="Supplier Name">
        </div>
        <div>
            <label style="font-size:12px; font-weight:600; color:#0f172a;">Selling Price (MRP)</label>
            <input type="number" id="p-sell" style="border-color:var(--primary); font-weight:bold;">
        </div>
    </div>
</div>
        </div>

        <!-- VARIANT BUILDER (No changes to logic, just wrapper) -->
        <div>
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <h4 style="margin:0;">Variants & Stock</h4>
                <span style="font-size:11px; color:#64748b;">Total Stock: <span id="v-total-display">0</span></span>
            </div>
            
            <div style="display:flex; gap:10px; margin-bottom:10px;">
                <input id="v-color" placeholder="Color (e.g. Red)" style="flex:1">
                <input id="v-size" placeholder="Size (e.g. XL)" style="flex:1">
                <input type="number" id="v-qty" placeholder="Qty" style="width:80px;">
                <button class="btn btn-primary" onclick="addVariantRow()">+ Add</button>
            </div>
            
            <div style="max-height: 150px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 8px;">
                <table class="variant-table" style="margin:0;">
                    <thead style="position:sticky; top:0; background:#f1f5f9;">
                        <tr><th>SKU</th><th>Color</th><th>Size</th><th>Stock</th><th>Action</th></tr>
                    </thead>
                    <tbody id="variant-list"></tbody>
                </table>
            </div>
        </div>

        <div style="display:flex; justify-content:flex-end; gap:10px; padding-top:10px; border-top: 1px solid #e2e8f0;">
            <button class="btn btn-sec" onclick="closeModal('modal-prod')">Cancel</button>
            <button class="btn btn-primary" onclick="saveProduct()">üíæ Save Product</button>
        </div>
    </div>
</div>


<!-- NEW MODAL: POS VARIANT SELECTOR -->
<div id="modal-v-select" class="modal">
    <div class="modal-box" style="width: 400px;">
        <h3>Select Variation</h3>
        <p id="v-select-title" style="color:#64748b; margin-top:-10px;"></p>
        <div id="v-select-grid" class="v-selector-grid"></div>
        <div style="text-align:right; margin-top:15px;">
            <button class="btn btn-sec" onclick="closeModal('modal-v-select')">Cancel</button>
        </div>
    </div>
</div>

<!-- MODAL: VIEW TRANSACTION DETAILS -->
<div id="modal-trx" class="modal">
    <div class="modal-box">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <h3 style="margin:0;">Transaction Details</h3>
            <button onclick="closeModal('modal-trx')" style="background:none; border:none; font-size:24px; cursor:pointer; color:var(--text-muted);">&times;</button>
        </div>
        
        <!-- This container is where JS injects the bill details -->
        <div id="trx-content" style="max-height: 70vh; overflow-y: auto;"></div>

        <div style="text-align:right; margin-top:15px; pt-3; border-top:1px solid var(--border);">
            <button class="btn btn-sec" onclick="closeModal('modal-trx')">Close</button>
        </div>
    </div>
</div>


<!-- BATCH DETAILS MODAL -->
<div id="modal-batch" class="modal">
    <div class="modal-box">
        <div style="display:flex; justify-content:space-between;">
            <h3 id="mb-title">Batch Details</h3>
            <button onclick="closeModal('modal-batch')" style="border:none; background:none; font-size:20px;">&times;</button>
        </div>
        
        <!-- Batch Header Info -->
        <div id="mb-header" style="background:#f1f5f9; padding:15px; border-radius:8px; margin:15px 0; font-size:13px;"></div>

        <!-- Items Table -->
        <h4>Items in this Batch</h4>
        <div style="max-height:300px; overflow-y:auto; border:1px solid #e2e8f0;">
            <table style="width:100%;">
                <thead style="background:#f8fafc; font-size:11px;">
                    <tr><th>Product</th><th>Variant</th><th>Qty Added</th></tr>
                </thead>
                <tbody id="mb-items"></tbody>
            </table>
        </div>
        <div style="margin-top:15px; text-align:right;">
            <button class="btn btn-sec" onclick="closeModal('modal-batch')">Close</button>
        </div>
    </div>
</div>

<!-- EDIT BATCH INFO MODAL -->
<div id="modal-batch-edit" class="modal">
    <div class="modal-box" style="width:400px;">
        <h3>Edit Batch Info</h3>
        <input type="hidden" id="ebe-id">
        <div style="margin-bottom:10px;">
            <label>Supplier Name</label>
            <input id="ebe-sup">
        </div>
        <div style="margin-bottom:10px;">
            <label>Notes</label>
            <input id="ebe-note">
        </div>
        <button class="btn btn-primary" style="width:100%;" onclick="saveBatchEdit()">Update Info</button>
    </div>
</div>


    <!-- Hidden Print Area -->
    <div id="print-area"></div>

    <script>
/* --- 1. SUPABASE INIT --- */
const SUPABASE_URL = 'https://kfmqrqhjhfmlvomzrzoj.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtmbXFycWhqaGZtbHZvbXpyem9qIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM0NjA2OTYsImV4cCI6MjA3OTAzNjY5Nn0.AyI65ENP9GPXVz7l5OC2YQvFnSVoxOk506jZe6-kRRs';
// use the CDN-createClient to build the global 'supabase' client
const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// Global State
let db = { products: [], transactions: [], settings: {} };
let cart = [];
let sortKey = 'name', sortAsc = true;
let tempVariants = []; // Add this missing variable

// STARTUP
window.onload = async () => {
    // 1. Load all data (Products, Transactions, Categories)
    await loadAllData(); 
    
    // 2. Initialize UI
    nav('dashboard');
    
    // 3. Render Category Managers
    renderCategoryList();
    updateCategoryDropdowns();
};

async function loadAllData() {
    console.log("Syncing with Supabase...");
    
    // 1. Fetch Products & Variants
    const { data: prods, error: pErr } = await sb
        .from('products')
        .select(`*, variants(*)`); 
    
    if(pErr) return alert("Error loading products: " + pErr.message);

    db.products = prods.map(p => ({
        id: p.id,
        uid: p.uid,
        name: p.name,
        cat: p.category,
        sup: p.supplier,
        buy: p.buy_price,
        sell: p.sell_price,
        stock: p.variants ? p.variants.reduce((sum, v) => sum + v.stock, 0) : 0,
        variants: p.variants || []
    }));

   // 2. Fetch Transactions
    const { data: trxs, error: tErr } = await sb
        .from('transactions')
        .select(`*, transaction_items(*)`)
        .order('date', { ascending: false })
        .limit(100);

    if(tErr) console.error(tErr);

    db.transactions = trxs.map(t => ({
        id: t.id,
        date: t.date,
        type: t.type,
        cust: t.customer_name,
        phone: t.customer_phone,
        sub: t.subtotal,
        del: t.delivery_fee,
        disc: t.discount,
        total: t.total,
        profit: t.profit,
        // --- NEW FIELDS MAPPED HERE ---
        paid_amount: Number(t.paid_amount || t.total), // Default to total if null (old records)
        due_amount: Number(t.due_amount || 0),
        // -----------------------------
        items: t.transaction_items.map(i => ({
            db_item_id: i.id, 
            product_id: i.product_id,
            name: i.name,
            sku: i.sku,
            qty: i.qty,
            actualSell: i.sell_price,
            discPercent: i.discount_percent,
            unitFinalPrice: i.final_price,
            buy: i.buy_price,
            isReturned: i.is_returned
        }))
    }));

    // 3. Fetch Settings & Logs (No changes needed here)
    const { data: setts } = await sb.from('settings').select('*').single();
    if(setts) db.settings = { name: setts.shop_name, addr: setts.address, phone: setts.phone };
    
    const { data: logs } = await sb.from('stock_logs').select('*').order('date', {ascending:false}).limit(50);
    db.productLogs = logs || [];

    const { data: cats } = await sb.from("categories").select("*").order("name");
    db.categories = cats || [];

const { data: batches } = await sb.from('inventory_batches').select('*').order('created_at', {ascending:false}).limit(50);
db.batches = batches || [];




    console.log("Data Sync Complete");
    loadCategoriesUI();
}


        function nav(id) {
            document.querySelectorAll('.section').forEach(e => e.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
            // Simple active state logic based on button text matching id roughly
            const btns = document.querySelectorAll('.nav-item');
            btns.forEach(b => { if(b.innerText.toLowerCase().includes(id)) b.classList.add('active'); });

            if(id === 'dashboard') renderDash();
            if(id === 'pos') renderPOS();
            if(id === 'inventory') renderInv();
            if(id === 'history') renderHistory();
              if(id === 'due-section') renderDueList();
        }

        /* --- 2. INVENTORY LOGIC --- */
        function renderInv() {
            const tbody = document.getElementById('inv-body');
            tbody.innerHTML = "";
            const q = document.getElementById('inv-search').value.toLowerCase();
            const cat = document.getElementById('inv-cat-filter').value;

            let list = db.products.filter(p => 
                (p.name.toLowerCase().includes(q) || p.uid.toLowerCase().includes(q)) &&
                (cat === "" || p.cat === cat)
            );

            // Sort
            list.sort((a,b) => {
                let va = a[sortKey], vb = b[sortKey];
                if(typeof va === 'string') { va = va.toLowerCase(); vb = vb.toLowerCase(); }
                return (va > vb ? 1 : -1) * (sortAsc ? 1 : -1);
            });

            list.forEach(p => {
                tbody.innerHTML += `
                    <tr>
                        <td style="font-family:monospace; color:var(--primary); font-weight:bold;">${p.uid}</td>
                        <td>${p.name}</td>
                        <td><span class="tag" style="background:#f1f5f9;">${p.cat}</span></td>
                        <td>${p.sup}</td>
                        <td>${p.buy}</td>
                        <td>${p.sell}</td>
                        <td>${p.stock} ${p.stock<5 ? 'üî¥' : ''}</td>
                        <td>
                            <button class="btn btn-sec btn-sm" onclick="editProd(${p.id})">‚úèÔ∏è</button>
                            <button class="btn btn-danger btn-sm" onclick="delProd(${p.id})">üóë</button>
                        </td>
                    </tr>
                `;
            });
        }
        
        function editProd(id) {
    // Reuse the logic we built for the search bar
    // This ensures the modal opens and fills correctly
    openProdModal(); // Open and reset first
    fillModalFromSearch(id); // Fill with data
    document.getElementById('m-title').innerText = "Edit Product Details";
}


        function sortInv(key) {
            if(sortKey === key) sortAsc = !sortAsc;
            else { sortKey = key; sortAsc = true; }
            renderInv();
        }

        // --- SMART PRODUCT MODAL LOGIC ---

// 1. Open Modal (Resets everything)


function openProdModal() {
    // ... existing code ...
       document.getElementById('m-title').innerText = "Add New Product";
    document.getElementById('p-id').value = "";
    document.querySelectorAll('#modal-prod input').forEach(i => i.value = "");
    
    // --- ADD THESE LINES ---
    document.getElementById('uid-feedback').style.display = 'none';
    document.getElementById('name-feedback').style.display = 'none';
    // ----------------------

    // ... rest of existing code ...
    tempVariants = [];
    renderVariantTable();
    
    document.getElementById('p-uid').readOnly = false;
    document.getElementById('modal-prod').style.display = 'flex';
    setTimeout(() => document.getElementById('p-search').focus(), 100);
}

function fillModalFromSearch(id) {
    const p = db.products.find(x => x.id === id);
    if(!p) return;

    document.getElementById('p-id').value = p.id;
    document.getElementById('p-uid').value = p.uid;
    document.getElementById('p-uid').readOnly = true;
    document.getElementById('p-name').value = p.name;
    document.getElementById('p-cat').value = p.cat;
    document.getElementById('p-sup').value = p.sup;
    document.getElementById('p-sell').value = p.sell;

    // --- COST HANDLING ---
   document.getElementById('p-buy-base').value = "";
    document.getElementById('p-buy-extra').value = "";
    document.getElementById('calc-qty-display').innerText = "0";

    document.getElementById('uid-feedback').style.display = 'none';
    document.getElementById('name-feedback').style.display = 'none';

    tempVariants = [];
    renderVariantTable();
    
    document.getElementById('p-uid').readOnly = false;
    document.getElementById('modal-prod').style.display = 'flex';
    setTimeout(() => document.getElementById('p-search').focus(), 100);
}
// Add a row to the table (InMemory)
function addVariantRow() {
     // 1. Get raw input values
    const uid = document.getElementById('p-uid').value.trim();
    const rawColor = document.getElementById('v-color').value.trim();
    const rawSize = document.getElementById('v-size').value.trim();
    const qty = Number(document.getElementById('v-qty').value);

    // 2. Basic Validation
    if(!uid) return alert("Enter Master UID first!");
    if(qty <= 0) return alert("Enter Quantity");

    // 3. Determine Display Names
    const dispColor = rawColor || "Std"; 
    const dispSize = rawSize || "Std";

    // 4. SKU GENERATION
    let finalSku = uid;
    const cCode = rawColor ? rawColor.replace(/\s+/g, '').toUpperCase().slice(0, 3) : "";
    const sCode = rawSize ? rawSize.replace(/\s+/g, '').toUpperCase() : "";

    if (cCode && sCode) finalSku = `${uid}-${cCode}-${sCode}`;
    else if (cCode && !sCode) finalSku = `${uid}-${cCode}`;
    else if (!cCode && sCode) finalSku = `${uid}-${sCode}`;
    else finalSku = uid;

    // 5. Add to List
    const ex = tempVariants.find(v => v.sku === finalSku);
    if(ex) {
        ex.stock += qty; 
    } else {
        tempVariants.push({ 
            sku: finalSku, 
            color: dispColor, 
            size: dispSize, 
            stock: qty 
        });
    }

    // 6. Render and Clear
    renderVariantTable();
    document.getElementById('v-qty').value = "";
    document.getElementById('v-color').value = "";
    document.getElementById('v-size').value = "";

    // --- NEW: RE-CALCULATE COST WHEN QTY CHANGES ---
    calcLandedCost(); 
}
function renderVariantTable() {
    const tbody = document.getElementById('variant-list');
    tbody.innerHTML = tempVariants.map((v, i) => `
        <tr>
            <td>${v.sku}</td>
            <td>${v.color}</td>
            <td>${v.size}</td>
            <td><b>${v.stock}</b></td>
            <td><button class="btn-icon" onclick="removeVariant(${i})">√ó</button></td>
        </tr>
    `).join('');
    
    // Update the qty display in calculator
    calcLandedCost();
}

// Helper to remove and recalculate
function removeVariant(i) {
    tempVariants.splice(i, 1);
    renderVariantTable();
}

// --- ADVANCED SEARCH FOR MODAL ---

function searchForModal(q) {
    const resDiv = document.getElementById('p-results');
    
    // 1. Hide if empty
    if (!q || q.trim().length < 1) {
        resDiv.style.display = 'none';
        return;
    }
    
    const term = q.toLowerCase().trim();

    // 2. Filter Database
    const matches = db.products.filter(p => {
        // Safe check for fields in case they are undefined
        const name = (p.name || "").toLowerCase();
        const uid = (p.uid || "").toLowerCase();
        const sup = (p.sup || "").toLowerCase();
        
        // A. Check Master Details
        if (name.includes(term) || uid.includes(term) || sup.includes(term)) {
            return true;
        }

        // B. Check Child Variants (e.g., Scanning a specific sub-SKU)
        if (p.variants && p.variants.length > 0) {
            // Check if ANY variant sku matches the search term
            return p.variants.some(v => v.sku.toLowerCase().includes(term));
        }

        return false;
    });

    // 3. Render Results
    if (matches.length > 0) {
        resDiv.style.display = 'block';
        resDiv.innerHTML = matches.slice(0, 10).map(p => `
            <div class="search-item" onclick="fillModalFromSearch(${p.id})">
                <div style="display:flex; flex-direction:column; gap:2px;">
                    <div>
                        <strong style="color:var(--primary);">${p.name}</strong> 
                        <small style="color:#64748b; font-family:monospace;">[${p.uid}]</small>
                    </div>
                    <div style="font-size:11px; color:#64748b;">
                        Supplier: ${p.sup || 'N/A'}
                    </div>
                </div>
                <div style="text-align:right;">
                    <span style="font-size:12px; background:#f1f5f9; padding:2px 6px; border-radius:4px; font-weight:bold;">
                        Stock: ${p.stock}
                    </span>
                    <br>
                    <small style="font-size:10px; color:#94a3b8;">Click to Edit</small>
                </div>
            </div>
        `).join('');
    } else {
        resDiv.style.display = 'none';
    }
}

// HELPER: Centralized Logging for Variants
async function addLog(name, uid, sku, variant, qty, type, final) {
    await sb.from('stock_logs').insert({
        product_name: name, uid, sku, variant_details: variant,
        qty_change: qty, action_type: type, final_stock: final
    });
}

/* -------------------------------
   SAVE PRODUCT (Add or Update)
--------------------------------*/
async function saveProduct() {
    const id = document.getElementById('p-id').value; 
    const uid = document.getElementById('p-uid').value || "GEN-" + Date.now();
    const name = document.getElementById('p-name').value;
    const category = document.getElementById('p-cat').value;
    const supplier = document.getElementById('p-sup').value;
    const buy_price = Number(document.getElementById('p-buy').value); 
    const sell_price = Number(document.getElementById('p-sell').value);

    // Get Cost Details
    const baseP = Number(document.getElementById('p-buy-base').value) || 0;
    const extraC = Number(document.getElementById('p-buy-extra').value) || 0;

    if (!name || !sell_price) return alert("Name and Price required");
    if (tempVariants.length === 0) return alert("Add at least one variant");

    // 1. GENERATE BATCH REFERENCE
    const batchRef = "PO-" + Date.now().toString().slice(-6);
    
    // Calculate Batch Totals
    const totalBatchQty = tempVariants.reduce((sum, v) => sum + Number(v.stock), 0);
    // Total Investment = (Unit Base * Qty) + Flat Extra Cost
    const totalBatchCost = (baseP * totalBatchQty) + extraC;

    const prodData = { uid, name, category, supplier, buy_price, sell_price };
    let savedProductId;

    try {
        // A. Save Product Master
        if (!id) {
            const { data, error } = await sb.from("products").insert(prodData).select().single();
            if (error) throw error;
            savedProductId = data.id;
        } else {
            const { data, error } = await sb.from("products").update(prodData).eq("id", id).select().single();
            if (error) throw error;
            savedProductId = data.id;
        }

        // B. NEW: Create Inventory Batch Header
        const batchData = {
            batch_ref: batchRef,
            supplier: supplier,
            total_qty: totalBatchQty,
            total_cost: totalBatchCost,
            base_cost: baseP,
            extra_cost: extraC,
            note: `Product: ${name}` // Tag the product name for easier search
        };
        const { error: bErr } = await sb.from('inventory_batches').insert(batchData);
        if(bErr) throw new Error("Batch Log Error: " + bErr.message);

        // C. Clear Old Variants
        await sb.from("variants").delete().eq("product_id", savedProductId);

        // D. Prepare Item Logs & Variants
        const logEntries = [];
        const variantRows = [];
        
        tempVariants.forEach(v => {
            const stockVal = Number(v.stock);
            
            variantRows.push({
                product_id: savedProductId,
                sku: v.sku,
                color: v.color,
                size: v.size,
                stock: stockVal
            });

            logEntries.push({
                date: new Date().toISOString(),
                batch_id: batchRef, // Link to the Batch Header
                action_type: id ? 'Stock Update' : 'New Stock',
                product_name: name,
                uid: uid,
                sku: v.sku,
                variant_details: `${v.color}/${v.size}`,
                qty_change: stockVal, 
                final_stock: stockVal
            });
        });

        // E. Insert Variants & Logs
        await sb.from("variants").insert(variantRows);
        await sb.from("stock_logs").insert(logEntries);

        // F. Update Master Stock
        await sb.from("products").update({ stock: totalBatchQty }).eq("id", savedProductId);

        // G. Finish
        closeModal("modal-prod");
        await loadAllData(); 
        
        // Navigate to the new Batch Tab to show user
        nav('history');
        switchTab('batches');
        alert("‚úÖ Stock Added & Batch Created: " + batchRef);

    } catch (err) {
        alert("‚ùå Error: " + err.message);
        console.error(err);
    }
}



/* ----------------------------
   DELETE PRODUCT
----------------------------- */
async function delProd(id) {
    if (!confirm("Delete this product?")) return;

    // Delete product
    const { error: prodErr } = await sb
        .from("products")
        .delete()
        .eq("id", id);

    if (prodErr) return alert("Delete failed: " + prodErr.message);

    // Delete variants belonging to product
    await sb.from("variants").delete().eq("product_id", id);

    await loadAllData();
    renderInv();

    alert("Product Deleted");
}



        /* --- 3. POS LOGIC --- */
       function renderPOS() {
    const grid = document.getElementById('pos-grid');
    grid.innerHTML = "";
    const q = document.getElementById('pos-search').value.toLowerCase();
    const cat = document.getElementById('pos-cat').value;

    db.products.filter(p => 
        (p.name.toLowerCase().includes(q) || p.uid.toLowerCase().includes(q)) &&
        (cat === "" || p.cat === cat) && p.stock > 0
    ).forEach(p => {
        grid.innerHTML += `
            <div class="pos-card" onclick="addToCart(${p.id})">
                <div class="stock-tag">${p.stock}</div>
                <div style="font-weight:bold; font-size:14px;">${p.name}</div>
                <div style="font-size:12px; color:var(--text-muted);">${p.uid}</div>
                <div style="color:var(--primary); font-weight:bold; margin-top:auto;">‡ß≥${p.sell}</div>
            </div>
        `;
    });
}
function addToCart(idOrSku) {
    // 1. Try to find by specific Variant SKU first (Scanner behavior)
    let foundProd = null;
    let foundVariant = null;

    // Loop to find SKU match
    db.products.forEach(p => {
        if(p.variants) {
            const v = p.variants.find(v => v.sku === idOrSku); // Check Variant SKU
            if(v) { foundProd = p; foundVariant = v; }
        }
    });

    // 2. If scanned specific variant, add directly
    if(foundProd && foundVariant) {
        pushToCart(foundProd, foundVariant);
        return;
    }

    // 3. If not found by SKU, find by Master Product ID
    foundProd = db.products.find(x => x.id === idOrSku);
    
    if(foundProd) {
        // Handle "One-click" for old data or single variant
        if(!foundProd.variants || foundProd.variants.length <= 1) {
            // Create dummy variant if old data
            const v = foundProd.variants ? foundProd.variants[0] : {sku: foundProd.uid, color:'Std', size:'Std', stock: foundProd.stock};
            pushToCart(foundProd, v);
        } else {
            // MULTIPLE VARIANTS: Show Selector Modal
            openVariantSelector(foundProd);
        }
    }
}

// Helper: The "Which one?" Popup
function openVariantSelector(prod) {
    const grid = document.getElementById('v-select-grid');
    document.getElementById('v-select-title').innerText = prod.name;
    
    grid.innerHTML = prod.variants.map(v => `
        <div class="v-select-card" onclick="selectVariant(${prod.id}, '${v.sku}')">
            <div style="font-weight:bold;">${v.color} - ${v.size}</div>
            <div style="font-size:11px; color:#64748b;">${v.sku}</div>
            <div class="v-stock-badge ${v.stock<1?'bg-red':''}">Stock: ${v.stock}</div>
        </div>
    `).join('');
    
    document.getElementById('modal-v-select').style.display = 'flex';
}

function selectVariant(prodId, vSku) {
    const p = db.products.find(x => x.id === prodId);
    const v = p.variants.find(x => x.sku === vSku);
    pushToCart(p, v);
    closeModal('modal-v-select');
}

// Actual Cart Add Logic
function pushToCart(prod, variant) {
    if(variant.stock <= 0) return alert("Out of Stock!");

    // Check if this specific VARIANT is in cart
    const ex = cart.find(c => c.sku === variant.sku);
    
    if(ex) {
        if(ex.qty < variant.stock) ex.qty++;
        else alert("Stock Limit Reached");
    } else {
        const globalDisc = Number(document.getElementById('c-disc-global').value) || 0;
        cart.push({
            id: prod.id,
            name: prod.name,
            sku: variant.sku,        // STORE THE SKU
            color: variant.color,    // STORE DETAILS
            size: variant.size,
            stock: variant.stock,    // Max Stock
            actualSell: prod.sell,
            buy: prod.buy,
            qty: 1,
            discPercent: globalDisc,
            sup: prod.sup
        });
    }
    renderCart();
}
    function renderCart() {
    const div = document.getElementById('cart-list');
    div.innerHTML = "";
    
    cart.forEach((c, idx) => {
        // Math calculations
        const originalTotal = c.actualSell * c.qty;
        const discountAmount = originalTotal * (c.discPercent / 100);
        const finalLineTotal = originalTotal - discountAmount;

        div.innerHTML += `
            <div class="cart-item" style="display:block;">
                <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                    <span style="font-weight:600;">${c.name}</span>
                    <button style="color:red; border:none; background:none; cursor:pointer;" onclick="remCart(${idx})">‚úñ</button>
                </div>
                
                <div style="font-size:11px; color:#64748b; margin-bottom:5px;">
                    ${c.sup || 'N/A'} | Stock: ${c.stock} | ${c.sku}
                </div>
                
                <!-- PRICE ROW WITH EYE ICON -->
                <div style="display:flex; align-items:center; gap:5px; font-size:12px; color:#64748b;">
                    <span>Price: ‡ß≥</span>
                    <input class="cart-input" type="number" value="${c.actualSell}" 
                           onchange="updateCartItem(${idx}, 'price', this.value)" style="width:60px;">
                    
                    <!-- NEW: Eye Button & Popup -->
                    <button class="btn-eye" onclick="showCost(${idx})" title="View Cost">
                        üëÅ
                        <span id="cost-pop-${idx}" class="cost-popup">Buy: ‡ß≥${c.buy}</span>
                    </button>
                </div>

                <div style="display:flex; align-items:center; justify-content:space-between; margin-top:8px;">
                    <!-- QTY CONTROLS -->
                    <div class="cart-controls">
                        <button class="btn btn-sec btn-sm" onclick="updCart(${idx}, -1)">-</button>
                        <span style="font-weight:bold;">${c.qty}</span>
                        <button class="btn btn-sec btn-sm" onclick="updCart(${idx}, 1)">+</button>
                    </div>

                    <!-- DISCOUNT CONTROL -->
                    <div style="display:flex; align-items:center; gap:2px;">
                        <small>Disc%</small>
                        <input class="cart-input" type="number" value="${c.discPercent}" 
                               onchange="updateCartItem(${idx}, 'disc', this.value)" style="width:45px; border-color:var(--primary);">
                    </div>

                    <!-- FINAL PRICE DISPLAY -->
                    <div style="font-weight:bold; font-size:14px; color:var(--primary);">
                        ‡ß≥${Math.round(finalLineTotal)}
                    </div>
                </div>
            </div>
        `;
    });
    updateCartTotals();
}

function showCost(idx) {
    const popup = document.getElementById(`cost-pop-${idx}`);
    
    // Show it
    popup.style.display = 'block';
    
    // Hide it automatically after 3 seconds
    setTimeout(() => {
        popup.style.display = 'none';
    }, 3000);
}


        function updCart(idx, chg) {
            const c = cart[idx];
            if(c.qty + chg > 0 && c.qty + chg <= c.stock) {
                c.qty += chg;
                renderCart();
            }
        }
        function updPrice(idx, val) { cart[idx].actualSell = Number(val); renderCart(); }
        function remCart(idx) { cart.splice(idx, 1); renderCart(); }

       // Handle specific item updates
function updateCartItem(idx, type, val) {
    const v = Number(val);
    if(type === 'price') cart[idx].actualSell = v;
    if(type === 'disc') cart[idx].discPercent = v; // Update specific item discount
    renderCart();
}

// Handle "Apply to All" Discount
function applyGlobalDiscount(val) {
    const pct = Number(val);
    // Loop through all items and update their discount percent
    cart.forEach(item => {
        item.discPercent = pct;
    });
    renderCart();
}

// Calculate Grand Total
let currentNetPayable = 0; // Global variable to store current total

function updateCartTotals() {
    let grossSub = 0;
    
    // Calculate items
    cart.forEach(c => {
        const lineGross = c.actualSell * c.qty;
        const lineDisc = lineGross * (c.discPercent / 100);
        grossSub += lineGross;
    });

    // Apply Delivery Charge & Global Discount on items logic is already handled in item loop calculation above? 
    // Wait, previous logic calculated discount per item. 
    // Let's stick to the previous logic but update the totals.
    
    let totalPayable = 0;
    cart.forEach(c => {
        const lineGross = c.actualSell * c.qty;
        const lineDisc = lineGross * (c.discPercent / 100);
        totalPayable += (lineGross - lineDisc);
    });

    const del = Number(document.getElementById('c-del').value) || 0;
    currentNetPayable = Math.round(totalPayable + del);

    // Update UI
    document.getElementById('c-sub').innerText = grossSub;
    document.getElementById('c-total').innerText = "‡ß≥" + currentNetPayable;

    // Trigger Due Calculation
    updateDueCalc();
}

function updateDueCalc() {
    const paidInput = document.getElementById('c-paid').value;
    const paid = Number(paidInput);
    const display = document.getElementById('c-balance-display');

    if (paidInput === "") {
        display.innerText = "Enter Paid Amt";
        display.className = "";
        return;
    }

    const balance = paid - currentNetPayable;

    if (balance >= 0) {
        // Customer paid enough or more (Change)
        display.innerText = "Change: ‡ß≥" + balance;
        display.className = "balance-green";
    } else {
        // Customer paid less (Due)
        display.innerText = "Due: ‡ß≥" + Math.abs(balance);
        display.className = "balance-red";
    }
}

async function processCheckout() {
    if (cart.length === 0) return alert("Cart is Empty!");

    // --- 1. CALCULATE FINANCIALS & ITEMS ---
    let grossSub = 0, netTotal = 0;
    const del = Number(document.getElementById('c-del').value) || 0;
    const globalDiscPct = Number(document.getElementById('c-disc-global').value) || 0;

    // Prepare Items Array
    const finalItems = cart.map(c => {
        const unitGross = c.actualSell;
        // Apply item specific discount OR global discount
        const effectiveDisc = c.discPercent > 0 ? c.discPercent : globalDiscPct;
        const unitDiscAmt = unitGross * (effectiveDisc / 100);
        const unitFinal = unitGross - unitDiscAmt;

        grossSub += (unitGross * c.qty);
        netTotal += (unitFinal * c.qty);

        return {
            product_id: c.id,
            uid: c.uid || 'N/A',
            sku: c.sku,
            name: c.name,
            qty: c.qty,
            buy_price: c.buy,
            sell_price: c.actualSell,
            discount_percent: effectiveDisc, 
            final_price: unitFinal,
            total_line_amount: unitFinal * c.qty
        };
    });

    const grandTotal = Math.round(netTotal + del);
    const totalProfit = finalItems.reduce((acc, item) => acc + ((item.final_price - item.buy_price) * item.qty), 0);

    // --- 2. NEW: DUE MONEY CALCULATION ---
    const paidInput = document.getElementById('c-paid').value;
    
    // If paid input is empty, assume Full Payment. Otherwise use input value.
    let paidAmount = paidInput === "" ? grandTotal : Number(paidInput);
    
    // Safety check: Prevent negative numbers
    if (paidAmount < 0) paidAmount = 0;

    // Calculate Due (If paid is less than total, there is due. If paid is more, due is 0)
    const dueAmount = (grandTotal > paidAmount) ? (grandTotal - paidAmount) : 0;


    // --- 3. PREPARE TRANSACTION HEADER ---
    const trxId = "INV-" + Date.now().toString().slice(-6);
    
    const trxPayload = {
        id: trxId, 
        date: new Date().toISOString(),
        type: 'sale',
        customer_name: document.getElementById('cust-name').value || "Guest",
        customer_phone: document.getElementById('cust-phone').value || "",
        subtotal: grossSub,
        delivery_fee: del,
        discount: grossSub - netTotal,
        total: grandTotal,
        profit: totalProfit,
        // NEW FIELDS FOR DATABASE
        paid_amount: paidAmount,
        due_amount: dueAmount
    };

    try {
        // --- 4. DATABASE OPERATIONS ---
        
        // A. Insert Transaction Header
        const { error: tErr } = await sb.from('transactions').insert(trxPayload);
        if (tErr) throw new Error("Trans Header Failed: " + tErr.message);

        // B. Insert Transaction Items
        const dbItems = finalItems.map(i => ({ ...i, transaction_id: trxId }));
        const { error: iErr } = await sb.from('transaction_items').insert(dbItems);
        if (iErr) throw new Error("Trans Items Failed: " + iErr.message);

        // C. Update Stock & Create Logs (Existing Loop)
        for (const item of finalItems) {
            
            // Get current stock
            const { data: varData } = await sb
                .from('variants')
                .select('stock, product_id, color, size')
                .eq('sku', item.sku)
                .single();

            if (varData) {
                const newStock = varData.stock - item.qty;

                // Update Variant Stock
                await sb.from('variants').update({ stock: newStock }).eq('sku', item.sku);

                // Log the change
                await sb.from('stock_logs').insert({
                    date: new Date().toISOString(),
                    action_type: 'Sale',
                    product_name: item.name,
                    uid: item.uid,
                    sku: item.sku,
                    variant_details: `${varData.color}/${varData.size}`,
                    qty_change: -item.qty,
                    final_stock: newStock
                });

                // Update Master Product Total Stock
                const { data: allVars } = await sb.from('variants').select('stock').eq('product_id', varData.product_id);
                if(allVars) {
                    const totalStock = allVars.reduce((sum, v) => sum + v.stock, 0);
                    await sb.from('products').update({ stock: totalStock }).eq('id', varData.product_id); 
                }
            }
        }

        // --- 5. FINALIZE & PRINT ---
        alert("‚úÖ Sale Completed Successfully!");
        
        const printObj = {
            id: trxId,
            date: trxPayload.date,
            cust: trxPayload.customer_name,
            phone: trxPayload.customer_phone,
            items: finalItems.map(x => ({
                name: x.name, sku: x.sku, actualSell: x.sell_price, qty: x.qty, discPercent: x.discount_percent, unitFinalPrice: x.final_price, 
                color: x.sku.split('-')[1] || '', size: x.sku.split('-')[2] || '' 
            })),
            sub: trxPayload.subtotal,
            disc: trxPayload.discount,
            del: trxPayload.delivery_fee,
            total: trxPayload.total,
            // NEW FIELDS FOR RECEIPT
            paid_amount: paidAmount,
            due_amount: dueAmount
        };

        printReceipt(printObj);
        
        // --- 6. RESET UI ---
        cart = [];
        document.getElementById('c-del').value = 0;
        document.getElementById('c-disc-global').value = "";
        document.getElementById('cust-name').value = "";
        document.getElementById('cust-phone').value = "";
        
        // Clear New Due Money Inputs
        document.getElementById('c-paid').value = "";
        if(document.getElementById('c-balance-display')) {
            document.getElementById('c-balance-display').innerText = "0";
            document.getElementById('c-balance-display').className = "";
        }

        renderCart();
        
        await loadAllData(); 
        renderPOS();
        renderDash();

    } catch (err) {
        console.error(err);
        alert("‚ùå Error Processing Sale: " + err.message);
    }
}


// --- DUE MANAGEMENT LOGIC ---

function renderDueList() {
    const tbody = document.getElementById('due-body');
    tbody.innerHTML = "";
    const q = document.getElementById('due-search').value.toLowerCase();

    // Now that loadAllData is fixed, t.due_amount will be available
    const dues = db.transactions.filter(t => t.due_amount > 0);

    dues.forEach(t => {
        if(q && !(t.cust.toLowerCase().includes(q) || t.id.toLowerCase().includes(q))) return;

        tbody.innerHTML += `
            <tr style="cursor:pointer;" onclick="selectDue('${t.id}')">
                <td>${t.id}</td>
                <td>${new Date(t.date).toLocaleDateString()}</td>
                <td>${t.cust} <br><small>${t.phone}</small></td>
                <td>‡ß≥${t.total}</td>
                <td style="color:#16a34a;">‡ß≥${t.paid_amount}</td>
                <td style="color:#dc2626; font-weight:bold;">‡ß≥${t.due_amount}</td>
                <td><button class="btn btn-sm btn-primary">Pay</button></td>
            </tr>
        `;
    });

    if(dues.length === 0) tbody.innerHTML = "<tr><td colspan='7' style='text-align:center; padding:15px; color:#64748b;'>No Pending Dues</td></tr>";
}

let selectedDueTrx = null;

function selectDue(id) {
    selectedDueTrx = db.transactions.find(t => t.id === id);
    const panel = document.getElementById('due-action-panel');
    
    if(!selectedDueTrx) return;

    panel.innerHTML = `
        <div style="text-align:left;">
            <h3>Collecting Payment for <span style="color:var(--primary);">${selectedDueTrx.id}</span></h3>
            <p>Customer: <b>${selectedDueTrx.cust}</b></p>
            
            <div style="background:#fef2f2; padding:15px; border-radius:8px; border:1px solid #fee2e2; margin-bottom:15px;">
                <div style="font-size:12px; color:#991b1b;">Current Due Amount</div>
                <div style="font-size:24px; font-weight:900; color:#ef4444;">‡ß≥${selectedDueTrx.due_amount}</div>
            </div>

            <label>Amount Receiving Now:</label>
            <input type="number" id="pay-due-input" value="${selectedDueTrx.due_amount}" style="font-size:18px; font-weight:bold; margin-bottom:10px;">
            
            <button class="btn btn-primary" style="width:100%; justify-content:center;" onclick="submitDuePayment()">
                Confirm Payment & Clear Due
            </button>
        </div>
    `;
}

async function submitDuePayment() {
    if(!selectedDueTrx) return;
    
    const payAmt = Number(document.getElementById('pay-due-input').value);
    if(payAmt <= 0 || payAmt > selectedDueTrx.due_amount) return alert("Invalid Amount");

    const newPaid = Number(selectedDueTrx.paid_amount) + payAmt;
    const newDue = Number(selectedDueTrx.due_amount) - payAmt;

    try {
        // 1. Update Transaction
        const { error } = await sb.from('transactions')
            .update({ paid_amount: newPaid, due_amount: newDue })
            .eq('id', selectedDueTrx.id);

        if(error) throw error;

        // 2. Add to Payment Log (Audit)
        await sb.from('payment_logs').insert({
            transaction_id: selectedDueTrx.id,
            amount_paid: payAmt,
            note: "Due Collection"
        });

        alert("Payment Recorded!");
        
        // Refresh Data
        await loadAllData();
        renderDueList();
        document.getElementById('due-action-panel').innerHTML = "Select an invoice...";
        selectedDueTrx = null;

    } catch(err) {
        alert("Error: " + err.message);
    }
}

        /* --- 4. HISTORY & RETURNS --- */
        function renderHistory() {
            const tbody = document.getElementById('hist-body');
            tbody.innerHTML = "";
            const date = document.getElementById('hist-date').value;
            const type = document.getElementById('hist-type').value;

            db.transactions.forEach(t => {
                if(date && !t.date.startsWith(date)) return;
                if(type && t.type !== type) return;
                
                const tag = t.type === 'sale' ? '<span class="tag tag-sale">SALE</span>' : '<span class="tag tag-return">RETURN</span>';
                
                tbody.innerHTML += `
                    <tr>
                        <td>${t.id}</td>
                        <td>${new Date(t.date).toLocaleString()}</td>
                        <td>${tag}</td>
                        <td>${t.cust}<br><small>${t.phone}</small></td>
                        <td style="font-weight:bold;">‡ß≥${t.total}</td>
                        <td>
                            <button class="btn btn-sec btn-sm" onclick='viewTrx("${t.id}")'>üëÅ Details</button>
                            <button class="btn btn-sec btn-sm" onclick='printReceiptById("${t.id}")'>üñ® Print</button>
                        </td>
                    </tr>
                `;
            });
        }

function viewTrx(id) {
    // 1. Find the transaction
    const t = db.transactions.find(x => x.id === id);
    
    if (!t) {
        console.error("Transaction ID not found:", id);
        return alert("Error: Transaction not found in database.");
    }

    // --- NEW: Handle Due/Paid Variables with Fallbacks for old data ---
    const totalAmount = Number(t.total || 0);
    // If paid_amount is null (old record), assume full payment (total).
    const paidAmount = (t.paid_amount !== undefined && t.paid_amount !== null) ? Number(t.paid_amount) : totalAmount;
    // If due_amount is null, assume 0.
    const dueAmount = (t.due_amount !== undefined && t.due_amount !== null) ? Number(t.due_amount) : 0;
    
    // Dynamic Colors
    const dueColor = dueAmount > 0 ? '#dc2626' : '#64748b'; // Red if Due exists
    const paidColor = '#16a34a'; // Green

    // 2. Build Header
    let html = `
        <div style="display:flex; justify-content:space-between; margin-bottom:10px; align-items:center;">
            <div>
                <span style="font-size:18px; font-weight:bold; color:var(--primary);">Bill: ${t.id}</span>
                ${dueAmount > 0 ? '<span class="tag tag-return" style="margin-left:10px;">DUE PENDING</span>' : ''}
            </div>
            <div style="font-size:12px; color:#64748b;">${new Date(t.date).toLocaleString()}</div>
        </div>
        
        <div style="background:#f8fafc; padding:12px; border-radius:8px; margin-bottom:15px; border:1px solid #e2e8f0; font-size:13px;">
            <div style="display:flex; justify-content:space-between;">
                <span><strong>Customer:</strong> ${t.cust || 'Guest'}</span>
                <span><strong>Phone:</strong> ${t.phone || 'N/A'}</span>
            </div>
        </div>

        <table style="width:100%; border-collapse:collapse; font-size:13px;">
            <thead style="background:#f1f5f9; color:#475569;">
                <tr>
                    <th style="padding:10px; text-align:left; border-bottom:2px solid #e2e8f0;">Item Details</th>
                    <th style="padding:10px; text-align:center; border-bottom:2px solid #e2e8f0;">Price</th>
                    <th style="padding:10px; text-align:center; border-bottom:2px solid #e2e8f0;">Qty</th>
                    <th style="padding:10px; text-align:center; border-bottom:2px solid #e2e8f0;">Disc</th>
                    <th style="padding:10px; text-align:right; border-bottom:2px solid #e2e8f0;">Total</th>
                    <th style="padding:10px; text-align:center; border-bottom:2px solid #e2e8f0;">Action</th>
                </tr>
            </thead>
            <tbody>
    `;

    // 3. Loop Items (Kept exactly as is)
    t.items.forEach((i, idx) => {
        const isRet = i.isReturned === true;
        
        // SAFETY CHECKS
        const name = i.name || "Unknown Item";
        const sku = i.sku || i.uid || "";
        const variantInfo = (i.color || i.size) ? `(${i.color || ''}/${i.size || ''})` : "";
        
        const unitPrice = Number(i.actualSell || 0);
        const discPct = Number(i.discPercent || 0);
        const finalPrice = i.unitFinalPrice !== undefined ? Number(i.unitFinalPrice) : (unitPrice - (unitPrice * discPct / 100));
        
        const lineTotal = (i.qty * finalPrice).toFixed(2);
        
        // Styles
        const rowStyle = isRet ? 'background:#fff1f2; color:#991b1b;' : 'border-bottom:1px solid #f1f5f9;';
        const textStyle = isRet ? 'text-decoration:line-through; opacity:0.7;' : '';
        const statusBadge = isRet ? '<br><span class="tag tag-return" style="font-size:10px;">RETURNED</span>' : '';

        html += `
            <tr style="${rowStyle}">
                <td style="padding:10px;">
                    <div style="${textStyle}"><b>${name}</b></div>
                    <div style="font-size:11px; color:#64748b;">${sku} ${variantInfo}</div>
                    ${statusBadge}
                </td>
                <td style="text-align:center; ${textStyle}">${unitPrice}</td>
                <td style="text-align:center; ${textStyle}">${i.qty}</td>
                <td style="text-align:center; ${textStyle}">${discPct}%</td>
                <td style="text-align:right; font-weight:bold; ${textStyle}">${lineTotal}</td>
                <td style="text-align:center;">
                     ${t.type === 'sale' && !isRet ? 
                       `<button class="btn btn-danger btn-sm" style="padding:4px 8px;" onclick="processReturn('${t.id}', ${idx})">‚Ü©</button>` : 
                       '-'
                     }
                </td>
            </tr>
        `;
    });

    // 4. MODIFIED FOOTER (Includes Due/Paid logic)
    html += `</tbody></table>
        <div style="text-align:right; margin-top:20px; padding-top:15px; border-top:2px solid #e2e8f0;">
            <div style="margin-bottom:5px; color:#64748b;">Subtotal: <span style="color:#0f172a;">${t.sub || 0}</span></div>
            <div style="margin-bottom:5px; color:#ef4444;">Discount: -${(t.disc || 0).toFixed(2)}</div>
            <div style="margin-bottom:5px; color:#64748b;">Delivery: +${t.del || 0}</div>
            
            <!-- GRAND TOTAL -->
            <div style="font-size:18px; font-weight:800; color:var(--primary); margin-top:10px; border-top:1px dashed #cbd5e1; padding-top:10px;">
                Grand Total: ‡ß≥${totalAmount}
            </div>

            <!-- DUE / PAID BREAKDOWN -->
            <div style="display:flex; justify-content:flex-end; gap:20px; margin-top:10px;">
                <div style="text-align:right;">
                    <span style="font-size:11px; font-weight:700; color:#64748b; text-transform:uppercase;">Paid</span><br>
                    <span style="font-size:15px; font-weight:bold; color:${paidColor};">‡ß≥${paidAmount}</span>
                </div>
                <div style="text-align:right;">
                    <span style="font-size:11px; font-weight:700; color:#64748b; text-transform:uppercase;">Due</span><br>
                    <span style="font-size:15px; font-weight:bold; color:${dueColor};">‡ß≥${dueAmount}</span>
                </div>
            </div>
        </div>`;

    // 5. Inject and Show
    const contentDiv = document.getElementById('trx-content');
    const modalDiv = document.getElementById('modal-trx');

    if (contentDiv && modalDiv) {
        contentDiv.innerHTML = html;
        modalDiv.style.display = 'flex';
    } else {
        console.error("Modal elements missing in HTML");
    }
}



   async function processReturn(trxId, itemIdx) {
    if(!confirm("Process Return? This will:\n1. Restock the item\n2. Refund the customer\n3. Create a return log")) return;

    // 1. Find Data locally
    const trx = db.transactions.find(t => t.id === trxId);
    if (!trx) return alert("Transaction not found. Please refresh.");
    
    const item = trx.items[itemIdx];
    
    // Prevent double returns on the same item
    if (item.isReturned) return alert("Item already returned!");

    try {
        const returnId = "RET-" + Date.now().toString().slice(-6);

        // --- A. RESTOCK THE VARIANT ---
        // Get current stock
        const { data: vData } = await sb.from('variants').select('*').eq('sku', item.sku).single();
        
        let finalStockVal = 0;
        if (vData) {
            finalStockVal = vData.stock + item.qty;
            await sb.from('variants').update({ stock: finalStockVal }).eq('sku', item.sku);
        }

        // --- B. MARK ORIGINAL SALES ITEM AS RETURNED ---
        // This crosses it out in the original bill
        await sb.from('transaction_items')
            .update({ is_returned: true })
            .eq('id', item.db_item_id); 

        // --- C. CREATE STOCK LOG ---
        await sb.from('stock_logs').insert({
            date: new Date().toISOString(),
            action_type: 'Customer Return',
            product_name: item.name,
            uid: returnId,
            sku: item.sku,
            variant_details: "Restock from Return",
            qty_change: item.qty,
            final_stock: finalStockVal
        });

        // --- D. CREATE RETURN TRANSACTION HEADER ---
        const refundAmt = item.qty * item.unitFinalPrice;
        const reversedProfit = (item.unitFinalPrice - item.buy) * item.qty;

        const returnHeader = {
            id: returnId,
            date: new Date().toISOString(),
            type: 'return',
            customer_name: trx.cust,
            customer_phone: trx.phone,
            subtotal: -refundAmt,
            delivery_fee: 0,
            discount: 0,
            total: -refundAmt,
            profit: -reversedProfit
        };

        const { error: headErr } = await sb.from('transactions').insert(returnHeader);
        if(headErr) throw new Error("Header Error: " + headErr.message);

        // --- E. CREATE RETURN TRANSACTION ITEM (THE MISSING PART) ---
        // This is what makes the item show up in the View/Print modal
        const returnItemRow = {
            transaction_id: returnId,
            product_id: item.product_id,
            uid: item.uid || 'N/A',
            sku: item.sku,
            name: item.name,
            qty: item.qty,
            buy_price: item.buy,
            sell_price: item.actualSell,
            discount_percent: item.discPercent,
            final_price: item.unitFinalPrice,
            total_line_amount: -refundAmt, // Negative line total
            is_returned: true // Mark as a return item
        };

        const { error: itemErr } = await sb.from('transaction_items').insert(returnItemRow);
        if(itemErr) throw new Error("Item Error: " + itemErr.message);

        // --- F. FINISH ---
        alert("‚úÖ Return Processed & Logged!");
        closeModal('modal-trx');
        await loadAllData(); 
        renderHistory();
        renderDash();

    } catch (err) {
        console.error(err);
        alert("‚ùå Error: " + err.message);
    }
}
        /* --- 5. DASHBOARD LOGIC --- */
  function renderDash() {
    const today = new Date().toISOString().slice(0, 10);
    
    // Filter transactions for TODAY
    const dailyTrx = db.transactions.filter(t => t.date.startsWith(today));
    
    // Calculate Net Totals (Sales + Returns)
    // Since Returns are negative numbers, simply adding them works perfectly!
    const netSales = dailyTrx.reduce((sum, t) => sum + t.total, 0);
    const netProfit = dailyTrx.reduce((sum, t) => sum + t.profit, 0);
    
    // Low Stock Count
    const low = db.products.filter(p => p.stock < 5).length;
    
    // Update UI
    document.getElementById('d-sales').innerText = "‡ß≥" + netSales.toLocaleString();
    document.getElementById('d-profit').innerText = "‡ß≥" + netProfit.toLocaleString();
    document.getElementById('d-low').innerText = low;
    
    // Top Selling Logic (Exclude Returns from "Top Selling" visual)
    let counts = {};
    db.transactions.filter(t => t.type === 'sale').forEach(t => {
        t.items.forEach(i => {
            // Don't count if it was returned later
            if (!i.isReturned) {
                if (!counts[i.name]) counts[i.name] = { q: 0, rev: 0 };
                counts[i.name].q += i.qty;
                counts[i.name].rev += (i.qty * i.actualSell);
            }
        });
    });
    
    const top = Object.keys(counts).sort((a, b) => counts[b].q - counts[a].q).slice(0, 5);
    document.querySelector('#top-table tbody').innerHTML = top.map(k => `
        <tr><td>${k}</td><td>${counts[k].q}</td><td>‡ß≥${counts[k].rev}</td></tr>
    `).join('');
    
    // Recent Activity List
    document.getElementById('recent-list').innerHTML = db.transactions.slice(0, 6).map(t => `
        <div style="padding:10px; border-bottom:1px solid #f1f5f9; display:flex; justify-content:space-between; align-items:center;">
            <div>
                <div style="font-weight:600; font-size:13px;">${t.cust}</div> 
                <div style="font-size:11px; color:#64748b;">${t.type.toUpperCase()} #${t.id}</div>
            </div>
            <div style="font-weight:bold; color:${t.type==='sale'?'var(--success)':'var(--danger)'}">
                ${t.type==='sale' ? '+' : ''}‡ß≥${t.total}
            </div>
        </div>
    `).join('');
}

        function filterLowStock() {
            nav('inventory');
            // simple filter hack
            const rows = document.querySelectorAll('#inv-body tr');
            rows.forEach(r => {
                if(!r.innerHTML.includes('üî¥')) r.style.display = 'none';
            });
        }




        // --- REAL-TIME DUPLICATE CHECKER ---

/* --- UPDATED FEEDBACK LOGIC --- */

function checkMasterUid(val) {
    const box = document.getElementById('uid-feedback');
    const currentId = document.getElementById('p-id').value;
    
    // Reset classes
    box.className = 'feedback-box'; 
    
    if(!val) { box.style.display = 'none'; return; }

    const exist = db.products.find(p => p.uid.toLowerCase() === val.toLowerCase());

    if(exist) {
        if(currentId && exist.id == currentId) {
            box.style.display = 'none'; // Valid (Editing self)
            return;
        }
        // ERROR: Duplicate
        box.classList.add('fb-error');
        box.style.display = 'block';
        box.innerHTML = `
            <span>‚õî <b>UID Taken!</b> product "${exist.name}" uses this code.</span>
            <span class="fb-link" onclick="fillModalFromSearch(${exist.id})">Edit "${exist.name}" instead?</span>
        `;
    } else {
        // SUCCESS: Unique
        box.classList.add('fb-success');
        box.style.display = 'block';
        box.innerHTML = `<span>‚úÖ <b>Available!</b> This UID is unique.</span>`;
    }
}

function checkMasterName(val) {
    const box = document.getElementById('name-feedback');
    
    // Reset
    box.className = 'feedback-box';
    
    if(!val) { box.style.display = 'none'; return; }

    const similar = db.products.filter(p => p.name.toLowerCase().includes(val.toLowerCase()));
    
    if(similar.length > 0) {
        // WARNING: Similar names exist
        box.classList.add('fb-warning');
        box.style.display = 'block';
        const links = similar.slice(0,3).map(p => 
            `<span class="fb-link" onclick="fillModalFromSearch(${p.id})">${p.name}</span>`
        ).join(', ');
        
        box.innerHTML = `<span>üí° <b>Similar Products:</b> ${links}</span>`;
    } else {
        box.style.display = 'none';
    }
}

// Update the Search Result Renderer to match new CSS
/* --- FIXED MAIN SEARCH FOR MODAL --- */
function searchForModal(q) {
    const resDiv = document.getElementById('p-results');
    
    // 1. Safety Check: Hide if input is empty
    if (!q || q.trim().length < 1) {
        resDiv.style.display = 'none';
        return;
    }
    
    const term = q.toLowerCase().trim();

    // 2. Filter Logic: Search EVERYWHERE (Name, UID, Supplier, Variants)
    const matches = db.products.filter(p => {
        // Safe access to strings
        const name = (p.name || "").toLowerCase();
        const uid = (p.uid || "").toLowerCase();
        const sup = (p.sup || "").toLowerCase();
        
        // A. Check Master Details
        if (name.includes(term) || uid.includes(term) || sup.includes(term)) {
            return true;
        }

        // B. Check Child Variants (e.g. searching "RED" or a specific SKU)
        if (p.variants && p.variants.length > 0) {
            return p.variants.some(v => v.sku.toLowerCase().includes(term));
        }

        return false;
    });

    // 3. Render UI: Uses the new CSS classes
    if (matches.length > 0) {
        resDiv.style.display = 'block';
        resDiv.innerHTML = matches.slice(0, 10).map(p => `
            <div class="search-result-row" onclick="fillModalFromSearch(${p.id})">
                <div style="display:flex; flex-direction:column;">
                    <span class="res-title">${p.name}</span>
                    <span class="res-sub">UID: ${p.uid} ‚Ä¢ Sup: ${p.sup || 'N/A'}</span>
                </div>
                <div style="text-align:right;">
                    <span class="res-stock">Stock: ${p.stock}</span>
                </div>
            </div>
        `).join('');
    } else {
        resDiv.style.display = 'none';
    }
}


    function updateCatDropdowns() {
    if (!db.categories) return;

    // POS Filter + Inventory Filter
    let opts = `<option value="">All Categories</option>`;
    db.categories.forEach(c => {
        opts += `<option value="${c.name}">${c.name}</option>`;
    });
    document.getElementById('pos-cat').innerHTML = opts;
    document.getElementById('inv-cat-filter').innerHTML = opts;

    // Product Add / Edit Modal
    let modOpts = "";
    db.categories.forEach(c => {
        modOpts += `<option value="${c.name}">${c.name}</option>`;
    });
    document.getElementById('p-cat').innerHTML = modOpts;
}



        function loadSettings() {
            if(db.settings) {
                document.getElementById('set-name').value = db.settings.name;
                document.getElementById('set-addr').value = db.settings.addr;
                document.getElementById('set-phone').value = db.settings.phone;
            }
        }
async function saveSettings() {
    const s = {
        shop_name: document.getElementById('set-name').value,
        address: document.getElementById('set-addr').value,
        phone: document.getElementById('set-phone').value
    };
    
    const { error } = await sb.from('settings').upsert({id: 1, ...s});
    if(error) alert("Error saving settings");
    else alert("Settings saved to cloud");
}

        function printReceiptById(id) {
            const t = db.transactions.find(x => x.id === id);
            if(t) printReceipt(t);
        }
    function printReceipt(t) {
    const shop = db.settings || { name: "Shop Name", addr: "Address", phone: "Phone" };
    
    const html = `
        <div style="max-width: 210mm; margin: 0 auto;">
            <div class="print-header">
                <div>
                    <h1 style="margin:0; font-size: 24px; color: #4f46e5;">${shop.name}</h1>
                    <p style="margin:5px 0;">${shop.addr}</p>
                    <p style="margin:0;">üìû ${shop.phone}</p>
                </div>
                <div style="text-align: right;">
                    <h2 style="margin:0; color: #333;">INVOICE</h2>
                    <p style="margin:5px 0;"><b>Bill ID:</b> ${t.id}</p>
                    <p style="margin:0;"><b>Date:</b> ${new Date(t.date).toLocaleString()}</p>
                </div>
            </div>

            <div style="margin-bottom: 20px; padding: 10px; border: 1px solid #eee; border-radius: 5px;">
                <strong>Bill To:</strong> <span style="font-size: 16px;">${t.cust}</span>
                <span style="float:right">Phone: ${t.phone || "N/A"}</span>
            </div>

            <table class="print-table">
                <thead>
                    <tr>
                        <th style="width: 5%;">#</th>
                        <th style="width: 45%;">Item Description</th>
                        <th style="width: 15%; text-align: center;">Rate</th>
                        <th style="width: 10%; text-align: center;">Qty</th>
                        <th style="width: 10%; text-align: center;">Disc%</th>
                        <th style="width: 15%; text-align: right;">Amount</th>
                    </tr>
                </thead>
                <tbody>
                    ${t.items.map((item, index) => `
                        <tr>
                            <td>${index + 1}</td>
                            <td>
                                <b>${item.name}</b>
                                <br><small style="color:#666;">${item.sku || item.uid} ${item.size ? `(${item.color}/${item.size})` : ''}</small>
                            </td>
                            <td style="text-align: center;">${item.actualSell}</td>
                            <td style="text-align: center;">${item.qty}</td>
                           <td style="text-align: center;">${(item.discPercent || 0).toFixed(2)}%</td>
                            <td class="text-right">${(item.qty * item.unitFinalPrice).toFixed(2)}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>

            <div style="display: flex; justify-content: flex-end; margin-top: 20px;">
                <div style="width: 250px;">
                    <div style="display: flex; justify-content: space-between; padding: 5px 0;">
                        <span>Subtotal:</span> <span>${t.sub}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 5px 0; color: red;">
                     <span>Discount:</span> <span>- ${(t.disc || 0).toFixed(2)}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 5px 0;">
                        <span>Delivery:</span> <span>+${t.del}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 10px 0; border-top: 2px solid #000; font-weight: bold; font-size: 18px;">
                        <span>Grand Total:</span> <span>‡ß≥${t.total}</span>
                    </div>

    <div style="display: flex; justify-content: space-between; padding: 5px 0; border-bottom:1px dashed #ccc;">
        <span>Paid Amount:</span> <span>‡ß≥${t.paid_amount || t.total}</span>
    </div>
    <div style="display: flex; justify-content: space-between; padding: 10px 0; font-weight: bold; font-size: 16px;">
        <span>Due Amount:</span> <span style="color:${(t.due_amount > 0) ? 'red' : 'black'}">‡ß≥${t.due_amount || 0}</span>
    </div>
</div>


                </div>
            </div>

            <div style="margin-top: 50px; border-top: 1px solid #ddd; padding-top: 10px; display: flex; justify-content: space-between; font-size: 12px; color: #666;">
                <div>Authorized Signature</div>
                <div>Software by STOCKED BD</div>
            </div>
        </div>
    `;
    
    document.getElementById('print-area').innerHTML = html;
    window.print();
}




function calcLandedCost() {
    // 1. Get Values
    const basePrice = Number(document.getElementById('p-buy-base').value) || 0;
    const extraCost = Number(document.getElementById('p-buy-extra').value) || 0;
    
    // 2. Get Total Quantity from the variant table
    const totalQty = tempVariants.reduce((sum, v) => sum + v.stock, 0);
    
    // 3. Calculate Final Unit Cost (Per Item)
    let finalCost = basePrice;
    
    if (totalQty > 0 && extraCost > 0) {
        // Distribute extra cost across all items
        const costPerItem = extraCost / totalQty;
        finalCost = basePrice + costPerItem;
    }

    // 4. Calculate Total Investment (Grand Total for this batch)
    // Formula: (Base Price * Total Qty) + Total Extra Cost
    const totalInvestment = (basePrice * totalQty) + extraCost;

    // 5. Update UI
    // Unit Cost
    document.getElementById('p-buy').value = parseFloat(finalCost.toFixed(2));
    
    // Summary Footer
    document.getElementById('summary-total-qty').innerText = totalQty;
    document.getElementById('summary-total-cost').innerText = totalInvestment.toLocaleString();
    
    // Also update the header display if you still kept it
    const headerDisplay = document.getElementById('calc-qty-display');
    if(headerDisplay) headerDisplay.innerText = totalQty;
}


        function exportData() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(db));
            const a = document.createElement('a');
            a.href = dataStr;
            a.download = "stocked_backup_" + Date.now() + ".json";
            a.click();
        }

        function importData(input) {
            const reader = new FileReader();
            reader.onload = e => {
                try {
                    db = JSON.parse(e.target.result);
                    save();
                    location.reload();
                } catch(err) { alert("Invalid File"); }
            };
            reader.readAsText(input.files[0]);
        }

async function factoryReset() {
    // 1. First Warning
    if (!confirm("‚ö†Ô∏è FACTORY RESET WARNING ‚ö†Ô∏è\n\nThis will PERMANENTLY DELETE:\n- All Products & Stock\n- All Sales History & Logs\n- All Payment Records\n\n‚úÖ Shop Details & Category List will be SAVED.\n\nAre you sure you want to proceed?")) return;

    // 2. Second Warning (Safety)
    if (!confirm("üî¥ FINAL CONFIRMATION\n\nThis action cannot be undone. All business data will be wiped. Confirm?")) return;

    try {
        // Show a temporary loading indicator
        const btn = event.target; // The button clicked
        const originalText = btn.innerText;
        btn.innerText = "‚è≥ Wiping Data...";
        btn.disabled = true;

        // --- STEP 1: Delete Dependent/Child Tables First (To avoid foreign key errors) ---
        
        // Delete Transaction Items (Linked to Transactions & Products)
        const { error: e1 } = await sb.from('transaction_items').delete().gt('id', 0);
        if (e1) throw new Error("Error clearing Items: " + e1.message);

        // Delete Payment Logs (Linked to Transactions)
        const { error: e2 } = await sb.from('payment_logs').delete().gt('id', 0);
        if (e2) console.log("Note: Payment logs empty or error"); // Non-fatal

        // Delete Stock Logs
        const { error: e3 } = await sb.from('stock_logs').delete().gt('id', 0);
        if (e3) throw new Error("Error clearing Logs: " + e3.message);

        // Delete Variants (Linked to Products)
        const { error: e4 } = await sb.from('variants').delete().gt('id', 0);
        if (e4) throw new Error("Error clearing Variants: " + e4.message);

        // --- STEP 2: Delete Parent Tables ---

        // Delete Transactions (String IDs usually, checking 'id' is not null)
        const { error: e5 } = await sb.from('transactions').delete().neq('id', '0'); 
        if (e5) throw new Error("Error clearing Transactions: " + e5.message);

        // Delete Products
        const { error: e6 } = await sb.from('products').delete().gt('id', 0);
        if (e6) throw new Error("Error clearing Products: " + e6.message);

        // --- STEP 3: Success & Reload ---
        alert("‚úÖ System Reset Successful!\n\n- Products: Cleared\n- History: Cleared\n- Settings: SAVED\n- Categories: SAVED");
        location.reload();

    } catch (err) {
        console.error(err);
        alert("‚ùå Reset Failed: " + err.message);
        // Restore button state
        const btn = event.target;
        if(btn) {
            btn.innerText = "‚ö†Ô∏è Factory Reset";
            btn.disabled = false;
        }
    }
}

       async function loadCategories() {
    // Fetch from Supabase
    const { data, error } = await sb.from("categories").select("*").order("name");
    
    if (error) {
        console.error("Error loading categories:", error);
        return;
    }

    // FIX: Use 'db' directly, NOT 'window.db'
    db.categories = data || []; 
    
    // Update UI elements
    renderCategoryList();
    updateCategoryDropdowns();
}
/* --- UNIFIED CATEGORY MANAGER --- */

// 1. Update all <select> dropdowns in the app
function updateCategoryDropdowns() {
    const options = db.categories.map(c => `<option value="${c.name}">${c.name}</option>`).join("");
    const defaultOpt = `<option value="">All Categories</option>`;
    
    // Update POS Filter
    const posSelect = document.getElementById('pos-cat');
    if(posSelect) posSelect.innerHTML = defaultOpt + options;

    // Update Inventory Filter
    const invSelect = document.getElementById('inv-cat-filter');
    if(invSelect) invSelect.innerHTML = defaultOpt + options;

    // Update Product Modal (No "All" option needed here)
    const prodSelect = document.getElementById('p-cat');
    if(prodSelect) prodSelect.innerHTML = `<option value="">Select Category</option>` + options;
}

// 2. Render the list in Settings > Manage Categories
function renderCategoryList() {
    const list = document.getElementById("cat-list");
    if(!list) return;

    list.innerHTML = db.categories.map(c => `
        <li style="background: white; padding: 10px; margin-bottom: 8px; border: 1px solid #e2e8f0; border-radius: 6px; display: flex; justify-content: space-between; align-items: center;">
            <span>${c.name}</span>
            <button onclick="deleteCategory(${c.id})" style="color: #ef4444; background: #fee2e2; border: none; padding: 4px 10px; border-radius: 4px; cursor: pointer; font-weight: bold;">‚úï</button>
        </li>
    `).join('');
}

// 3. Add Category Logic
async function addCategory() {
    // Try to find input with either ID (you had duplicates in HTML)
    const input = document.getElementById("new-cat") || document.getElementById("new-cat-name");
    
    if (!input || !input.value.trim()) return alert("Please enter a category name");
    
    const name = input.value.trim();

    const { data, error } = await sb.from("categories").insert({ name }).select().single();
    
    if (error) return alert("Error: " + error.message);

    // Update Local Data & UI immediately
    db.categories.push(data);
    updateCategoryDropdowns();
    renderCategoryList();
    
    input.value = ""; // Clear input
}

// 4. Delete Category Logic
async function deleteCategory(id) {
    if (!confirm("Delete this category?")) return;

    const { error } = await sb.from("categories").delete().eq("id", id);
    if (error) return alert("Error: " + error.message);

    // Update Local Data & UI immediately
    db.categories = db.categories.filter(c => c.id !== id);
    updateCategoryDropdowns();
    renderCategoryList();
}
async function loadCategoriesUI() {
    const list = document.getElementById("cat-list");
    list.innerHTML = "";

    db.categories.forEach(c => {
        list.innerHTML += `
            <li style="margin-bottom:5px;">
                ${c.name}
                <button onclick="delCategory(${c.id})" 
                    style="float:right; color:red; background:none; border:none;">
                    ‚úñ
                </button>
            </li>
        `;
    });
}

async function addCategory() {
    const name = document.getElementById("new-cat").value.trim();
    if (!name) return alert("Enter category name");

    const { error } = await sb.from("categories").insert({name});
    if (error) return alert(error.message);

    await loadAllData();
    updateCatDropdowns();
    loadCategoriesUI();

    document.getElementById("new-cat").value = "";
}

async function delCategory(id) {
    const { error } = await sb.from("categories").delete().eq("id", id);
    if (error) return alert(error.message);

    await loadAllData();
    updateCatDropdowns();
    loadCategoriesUI();
}


        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        
        // --- HISTORY TABS & LOGIC ---

function switchTab(tab) {
    // 1. Hide all views first
    document.getElementById('view-trans').style.display = 'none';
    document.getElementById('view-logs').style.display = 'none';
    const batchView = document.getElementById('view-batches');
    if(batchView) batchView.style.display = 'none'; // Safety check if element exists
    
    // 2. Show the selected view
    const targetDiv = document.getElementById('view-' + tab);
    if(targetDiv) targetDiv.style.display = 'block';

    // 3. Update Buttons (The fix is here)
    const btns = document.querySelectorAll('.tab-btn');
    btns.forEach(b => {
        b.classList.remove('active');
        
        // We check if the button's onclick code matches the tab we are switching to
        // This finds the correct button even if we didn't click it!
        if(b.getAttribute('onclick').includes(`'${tab}'`)) {
            b.classList.add('active');
        }
    });

    // 4. Render Data
    if(tab === 'trans') renderHistory();
    if(tab === 'batches') renderBatchLogs();
    if(tab === 'logs') renderProductLogs();
}


function renderBatchLogs() {
    const tbody = document.getElementById('batch-body');
    tbody.innerHTML = "";
    const q = document.getElementById('batch-search').value.toLowerCase();

    db.batches.forEach(b => {
        if(q && !(b.batch_ref.toLowerCase().includes(q) || b.supplier.toLowerCase().includes(q))) return;

        tbody.innerHTML += `
            <tr>
                <td style="font-family:monospace; color:#2563eb; font-weight:bold;">${b.batch_ref}</td>
                <td>${new Date(b.created_at).toLocaleDateString()}</td>
                <td>${b.supplier || 'N/A'}</td>
                <td style="font-weight:bold;">${b.total_qty}</td>
                <td>‡ß≥${b.total_cost.toLocaleString()}</td>
                <td>
                    <button class="btn btn-sec btn-sm" onclick="viewBatchDetails('${b.batch_ref}')">üëÅ View</button>
                    <button class="btn btn-sec btn-sm" onclick="editBatchInfo('${b.id}')">‚úèÔ∏è Edit</button>
                </td>
            </tr>
        `;
    });
}

// Updated Transaction History with Search
function renderHistory() {
    const tbody = document.getElementById('hist-body');
    tbody.innerHTML = "";
    
    const q = document.getElementById('hist-search').value.toLowerCase();
    const date = document.getElementById('hist-date').value;
    const type = document.getElementById('hist-type').value;

    // Sort by Date Descending (Newest first)
    const sortedTrx = [...db.transactions].sort((a, b) => new Date(b.date) - new Date(a.date));

    sortedTrx.forEach(t => {
        // Filter Logic
        if(date && !t.date.startsWith(date)) return;
        if(type && t.type !== type) return;
        
        // Search Logic
        const searchStr = (t.id + (t.cust||"") + (t.phone||"")).toLowerCase();
        if(q && !searchStr.includes(q)) return;
        
        const tag = t.type === 'sale' ? 
            '<span class="tag tag-sale">SALE</span>' : 
            '<span class="tag tag-return">RETURN</span>';
        
        tbody.innerHTML += `
            <tr>
                <td style="font-family:monospace; color:var(--primary);">${t.id}</td>
                <td style="font-size:12px;">${new Date(t.date).toLocaleString()}</td>
                <td>${tag}</td>
                <td>
                    <div style="font-weight:600;">${t.cust || 'Guest'}</div>
                    <div style="font-size:11px; color:#64748b;">${t.phone || ''}</div>
                </td>
                <td style="font-weight:bold;">‡ß≥${t.total}</td>
                <td>
                    <!-- ENSURE ID IS QUOTED CORRECTLY -->
                    <button class="btn btn-sec btn-sm" onclick="viewTrx('${t.id}')" title="View Details">üëÅ</button>
                    <button class="btn btn-sec btn-sm" onclick="printReceiptById('${t.id}')" title="Print Receipt">üñ®</button>
                </td>
            </tr>
        `;
    });
}

// New Product Log Renderer
function renderProductLogs() {
    const tbody = document.getElementById('log-body');
    const q = document.getElementById('log-search').value.toLowerCase();

    tbody.innerHTML = "";

    if(!db.productLogs || db.productLogs.length === 0) {
        tbody.innerHTML = "<tr><td colspan='6' style='text-align:center; padding:20px;'>No logs found</td></tr>";
        return;
    }

    db.productLogs.forEach(log => {
        const action = log.action_type || "Unknown"; 
        const date = new Date(log.date).toLocaleString();
        const batch = log.batch_id || "-"; // Get Batch ID
        const name = log.product_name || "N/A";
        const sku = log.sku || "";
        const change = log.qty_change || 0;

        // Search Filter (Includes Batch ID now)
        const searchStr = (name + sku + action + batch).toLowerCase();
        if(q && !searchStr.includes(q)) return;

        let typeColor = '#334155';
        if(action.includes('New') || action.includes('Update')) typeColor = '#2563eb';
        if(action.includes('Sale')) typeColor = '#059669';
        if(action.includes('Return')) typeColor = '#dc2626';

        tbody.innerHTML += `
            <tr style="border-bottom:1px solid #f1f5f9; font-size:13px;">
                <td style="color:#64748b;">${date}</td>
                <td style="font-family:monospace; color:#6366f1; font-weight:bold;">${batch}</td>
                <td><b style="color:${typeColor}">${action}</b></td>
                <td>${name}</td>
                <td style="font-family:monospace;">${sku}</td>
                <td style="font-weight:bold; color:${change > 0 ? '#16a34a' : '#dc2626'};">
                    ${change > 0 ? '+' : ''}${change}
                </td>
            </tr>
        `;
    });
}


// VIEW BATCH ITEMS
async function viewBatchDetails(ref) {
    // 1. Get Batch Header
    const batch = db.batches.find(b => b.batch_ref === ref);
    
    // 2. Fetch Items from Stock Logs (using the Batch Ref)
    // Note: We query the DB dynamically to ensure we get all items
    const { data: items } = await sb.from('stock_logs').select('*').eq('batch_id', ref);

    if(!batch || !items) return alert("Batch data not found");

    // 3. Render Header
    document.getElementById('mb-title').innerText = `Batch: ${batch.batch_ref}`;
    document.getElementById('mb-header').innerHTML = `
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
            <div><strong>Supplier:</strong> ${batch.supplier}</div>
            <div><strong>Date:</strong> ${new Date(batch.created_at).toLocaleString()}</div>
            <div><strong>Total Qty:</strong> ${batch.total_qty}</div>
            <div><strong>Total Cost:</strong> ‡ß≥${batch.total_cost}</div>
            <div style="grid-column: span 2; margin-top:5px; color:#64748b;"><em>${batch.note || ''}</em></div>
        </div>
    `;

    // 4. Render Items
    const tbody = document.getElementById('mb-items');
    tbody.innerHTML = items.map(i => `
        <tr style="border-bottom:1px solid #eee;">
            <td style="padding:8px;">${i.product_name}</td>
            <td style="padding:8px;">${i.variant_details}</td>
            <td style="padding:8px; font-weight:bold; color:#16a34a;">+${i.qty_change}</td>
        </tr>
    `).join('');

    document.getElementById('modal-batch').style.display = 'flex';
}

// EDIT BATCH INFO (Supplier/Note only for safety)
function editBatchInfo(id) {
    const b = db.batches.find(x => x.id == id); // Loose equality for string/int match
    if(!b) return;

    document.getElementById('ebe-id').value = id;
    document.getElementById('ebe-sup').value = b.supplier || "";
    document.getElementById('ebe-note').value = b.note || "";
    
    document.getElementById('modal-batch-edit').style.display = 'flex';
}

async function saveBatchEdit() {
    const id = document.getElementById('ebe-id').value;
    const sup = document.getElementById('ebe-sup').value;
    const note = document.getElementById('ebe-note').value;

    const { error } = await sb.from('inventory_batches')
        .update({ supplier: sup, note: note })
        .eq('id', id);

    if(error) return alert("Error: " + error.message);

    alert("Batch Info Updated");
    closeModal('modal-batch-edit');
    await loadAllData();
    renderBatchLogs();
}


    </script>
</body>
</html>
