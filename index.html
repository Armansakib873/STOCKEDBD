<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>STOCKED BD | Ultimate POS</title>
    <style>
        /* --- 1. CORE THEME --- */
        :root {
            --primary: #4f46e5; /* Indigo 600 */
            --primary-dark: #4338ca;
            --bg-body: #f1f5f9; /* Slate 100 */
            --bg-surface: #ffffff;
            --text-main: #0f172a;
            --text-muted: #64748b;
            --border: #e2e8f0;
            --success: #10b981;
            --danger: #ef4444;
            --radius: 8px;
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
        }
        * { box-sizing: border-box; outline: none; }
        body { 
            font-family: 'Segoe UI', system-ui, sans-serif; margin: 0; 
            background: var(--bg-body); color: var(--text-main); 
            height: 100vh; display: flex; flex-direction: column; overflow: hidden; 
        }

        /* --- 2. HEADER --- */
        header {
            background: var(--bg-surface); height: 65px; 
            border-bottom: 1px solid var(--border); padding: 0 25px;
            display: flex; align-items: center; justify-content: space-between; z-index: 10;
        }
        .brand { font-size: 22px; font-weight: 800; color: var(--primary); letter-spacing: -0.5px; display: flex; align-items: center; gap: 8px; }
        .nav-bar { background: #f8fafc; padding: 5px; border-radius: var(--radius); border: 1px solid var(--border); display: flex; gap: 5px; }
        .nav-item {
            padding: 8px 16px; border: none; background: transparent; color: var(--text-muted);
            font-weight: 600; font-size: 14px; cursor: pointer; border-radius: 6px; transition: 0.2s;
        }
        .nav-item:hover { color: var(--primary); background: #eef2ff; }
        .nav-item.active { background: var(--bg-surface); color: var(--primary); box-shadow: 0 1px 2px rgba(0,0,0,0.1); }

        /* --- 3. LAYOUT --- */
        main { flex: 1; overflow-y: auto; padding: 25px; max-width: 1600px; margin: 0 auto; width: 100%; }
        .section { display: none; animation: fadeIn 0.3s ease; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- 4. DASHBOARD COMPONENTS --- */
        .shortcut-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .shortcut-card {
            background: var(--bg-surface); padding: 15px; border-radius: var(--radius);
            border: 1px solid var(--border); cursor: pointer; font-weight: 600;
            display: flex; align-items: center; gap: 10px; color: var(--text-muted); transition: 0.2s;
        }
        .shortcut-card:hover { border-color: var(--primary); color: var(--primary); transform: translateY(-2px); box-shadow: var(--shadow); }
        
        .stats-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 25px; }
        .stat-box {
            background: var(--bg-surface); padding: 20px; border-radius: var(--radius);
            border: 1px solid var(--border); position: relative; overflow: hidden; cursor: pointer;
        }
        .stat-box:hover { box-shadow: var(--shadow); }
        .stat-label { font-size: 13px; color: var(--text-muted); text-transform: uppercase; font-weight: 600; }
        .stat-value { font-size: 32px; font-weight: 800; margin-top: 5px; color: var(--text-main); }
        .stat-box.alert .stat-value { color: var(--danger); }

        .dashboard-split { display: grid; grid-template-columns: 2fr 1fr; gap: 25px; }
        .panel { background: var(--bg-surface); border: 1px solid var(--border); border-radius: var(--radius); overflow: hidden; }
        .panel-head { padding: 15px 20px; background: #f8fafc; border-bottom: 1px solid var(--border); font-weight: 700; }

        /* --- 5. POS SYSTEM --- */
        .pos-container { display: grid; grid-template-columns: 1fr 420px; gap: 20px; height: calc(100vh - 130px); }
        .pos-left { display: flex; flex-direction: column; gap: 15px; overflow: hidden; }
        .product-grid { 
            display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); 
            gap: 12px; overflow-y: auto; padding: 2px; align-content: start; 
        }
        .pos-card {
            background: var(--bg-surface); border: 1px solid var(--border); padding: 12px;
            border-radius: var(--radius); cursor: pointer; position: relative; transition: 0.2s;
            display: flex; flex-direction: column; gap: 5px;
        }
        .pos-card:hover { border-color: var(--primary); box-shadow: var(--shadow); }
        .stock-tag { position: absolute; top: 8px; right: 8px; background: #f1f5f9; font-size: 10px; padding: 2px 6px; border-radius: 4px; font-weight: bold; }
        
        .pos-right { background: var(--bg-surface); border: 1px solid var(--border); border-radius: var(--radius); display: flex; flex-direction: column; overflow: hidden; }
        .cart-header { padding: 15px; border-bottom: 1px solid var(--border); background: #f8fafc; }
        .cart-list { flex: 1; overflow-y: auto; padding: 0; }
        .cart-item { 
            padding: 12px; border-bottom: 1px dashed var(--border); font-size: 13px; 
            display: grid; grid-template-columns: 1fr auto; gap: 8px;
        }
        .cart-controls { display: flex; align-items: center; gap: 8px; margin-top: 5px; }
        .cart-input { width: 60px; padding: 4px; text-align: center; border: 1px solid var(--border); border-radius: 4px; }
        .cart-footer { padding: 15px; background: #f8fafc; border-top: 1px solid var(--border); }
        .total-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px; }
        .grand-total { font-size: 20px; font-weight: 800; color: var(--primary); margin: 10px 0; display: flex; justify-content: space-between; }

        /* --- 6. INVENTORY & TABLES --- */
        .toolbar { display: flex; justify-content: space-between; margin-bottom: 15px; gap: 15px; flex-wrap: wrap; }
        .search-box { flex: 1; max-width: 400px; position: relative; }
        .table-wrap { background: var(--bg-surface); border: 1px solid var(--border); border-radius: var(--radius); overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th { background: #f8fafc; padding: 12px 15px; text-align: left; border-bottom: 1px solid var(--border); color: var(--text-muted); cursor: pointer; user-select: none; }
        th:hover { background: #e2e8f0; }
        td { padding: 10px 15px; border-bottom: 1px solid var(--border); }
        tr:hover td { background: #f8fafc; }
        
        .btn { padding: 8px 16px; border-radius: 6px; border: none; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 6px; font-size: 13px; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-sec { background: white; border: 1px solid var(--border); color: var(--text-main); }
        .btn-sec:hover { background: #f1f5f9; }
        .btn-danger { background: #fee2e2; color: var(--danger); }
        .btn-sm { padding: 4px 8px; font-size: 12px; }

        input, select { padding: 8px 12px; border: 1px solid var(--border); border-radius: 6px; width: 100%; font-size: 13px; }
        
        /* --- 7. MODALS & PRINT --- */
        .modal { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 1000; backdrop-filter: blur(2px); }
        .modal-box { background: white; padding: 25px; border-radius: 12px; width: 500px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); animation: popIn 0.2s; max-height: 90vh; overflow-y: auto; }
        @keyframes popIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        .tag { padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: bold; }
        .tag-sale { background: #dcfce7; color: #166534; }
        .tag-return { background: #fee2e2; color: #991b1b; }
        
        
        /* --- TABS --- */
.tab-container { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #e2e8f0; }
.tab-btn { 
    padding: 10px 20px; background: none; border: none; 
    font-weight: 600; color: var(--text-muted); cursor: pointer; 
    border-bottom: 3px solid transparent; transition: 0.2s;
}
.tab-btn:hover { color: var(--primary); }
.tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); }

   /* --- PRINT SETTINGS (A4) --- */
    
    /* 1. Hide the print area strictly in normal view */
    #print-area { 
        display: none; 
    }

    /* 2. A4 Print Layout */
    @media print {
        /* Hide the App Interface */
        body * { visibility: hidden; height: 0; overflow: hidden; }
        
        /* Show only the receipt area */
        #print-area, #print-area * { visibility: visible; height: auto; }
        
        #print-area {
            display: block !important;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            padding: 40px; /* A4 Margins */
            background: white;
            font-family: 'Segoe UI', sans-serif; /* Professional Font */
            color: black;
        }

        /* A4 Page Setup */
        @page { 
            size: A4; 
            margin: 0; 
        }

        /* Print Specific Table Styling */
        .print-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .print-table th { border-bottom: 2px solid #000; text-align: left; padding: 8px; }
        .print-table td { border-bottom: 1px solid #ddd; padding: 8px; }
        .text-right { text-align: right; }
        .print-header { display: flex; justify-content: space-between; border-bottom: 2px solid #000; padding-bottom: 20px; margin-bottom: 20px; }
        
        /* --- SEARCH DROPDOWN IN MODAL --- */
.search-wrapper { position: relative; margin-bottom: 15px; }
.search-results { 
    position: absolute; top: 100%; left: 0; width: 100%; 
    background: white; border: 1px solid var(--border); 
    border-radius: 0 0 8px 8px; max-height: 200px; overflow-y: auto; 
    z-index: 50; box-shadow: var(--shadow); display: none; 
}
.search-item { padding: 10px; border-bottom: 1px solid #f1f5f9; cursor: pointer; display: flex; justify-content: space-between; }
.search-item:hover { background: #f8fafc; color: var(--primary); }
.search-item:last-child { border-bottom: none; }
    }
    </style>
</head>
<body>

    <!-- HEADER -->
    <header>
        <div class="brand">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 7h-9"/><path d="M14 17H5"/><circle cx="17" cy="17" r="3"/><circle cx="7" cy="7" r="3"/></svg>
            STOCKED <span style="font-weight:400; color:var(--text-muted); font-size:14px;">Ultimate</span>
        </div>
        <div class="nav-bar">
            <button class="nav-item active" onclick="nav('dashboard')">Dashboard</button>
            <button class="nav-item" onclick="nav('pos')">POS System</button>
            <button class="nav-item" onclick="nav('inventory')">Inventory</button>
            <button class="nav-item" onclick="nav('history')">History</button>
            <button class="nav-item" onclick="nav('settings')">Settings</button>
        </div>
    </header>

    <main>
        <!-- 1. DASHBOARD -->
        <div id="dashboard" class="section active">
            <div class="shortcut-grid">
                <div class="shortcut-card" onclick="nav('pos')">‚ö° Quick Sale</div>
                <div class="shortcut-card" onclick="openProdModal()">üì¶ New Product</div>
                <div class="shortcut-card" onclick="filterLowStock()">‚ö†Ô∏è Low Stock</div>
                <div class="shortcut-card" onclick="nav('history')">üìÑ View Reports</div>
            </div>

            <div class="stats-row">
                <div class="stat-box">
                    <div class="stat-label">Total Sales (Today)</div>
                    <div class="stat-value" style="color: var(--primary);" id="d-sales">0</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Net Profit (Today)</div>
                    <div class="stat-value" style="color: var(--success);" id="d-profit">0</div>
                </div>
                <div class="stat-box alert" onclick="filterLowStock()">
                    <div class="stat-label">Low Stock Items</div>
                    <div class="stat-value" id="d-low">0</div>
                    <div style="font-size:11px; color:var(--danger); margin-top:5px;">Click to manage</div>
                </div>
            </div>

            <div class="dashboard-split">
                <div class="panel">
                    <div class="panel-head">üî• Top Selling Products</div>
                    <table id="top-table">
                        <thead><tr><th>Product</th><th>Sold</th><th>Revenue</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div class="panel">
                    <div class="panel-head">üïí Recent Activity</div>
                    <div id="recent-list" style="padding:10px;"></div>
                </div>
            </div>
        </div>

        <!-- 2. POS SYSTEM -->
        <div id="pos" class="section">
            <div class="pos-container">
                <!-- LEFT: PRODUCTS -->
                <div class="pos-left">
                    <div style="display:flex; gap:10px;">
                        <input type="text" id="pos-search" placeholder="Scan Barcode or Search Name..." onkeyup="renderPOS()" autofocus>
                        <select id="pos-cat" onchange="renderPOS()" style="width:150px;">
                            <option value="">All Categories</option>
                        </select>
                    </div>
                    <div class="product-grid" id="pos-grid"></div>
                </div>

                <!-- RIGHT: CART -->
                <div class="pos-right">
                    <div class="cart-header">
                        <h3 style="margin:0 0 10px 0;">Current Order</h3>
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                            <input id="cust-name" placeholder="Customer Name">
                            <input id="cust-phone" placeholder="Phone Number">
                        </div>
                    </div>
                    <div class="cart-list" id="cart-list">
                        <!-- Items Injected Here -->
                    </div>
                    <div class="cart-footer">
                        <div class="total-row"><span>Subtotal:</span> <span id="c-sub">0</span></div>
                        <div class="total-row">
                            <span>Delivery:</span> 
                            <input type="number" id="c-del" value="0" style="width:80px; text-align:right;" onchange="updateCartTotals()">
                        </div>
                        <div class="total-row">
                            <span>Discount:</span> 
                            <input type="number" id="c-disc" value="0" style="width:80px; text-align:right;" onchange="updateCartTotals()">
                        </div>
                        <div class="grand-total"><span>Total:</span> <span id="c-total">0</span></div>
                        <button class="btn btn-primary" style="width:100%; justify-content:center; padding:12px;" onclick="processCheckout()">‚úÖ Complete Sale & Print</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 3. INVENTORY -->
        <div id="inventory" class="section">
            <div class="toolbar">
                <div class="search-box">
                    <input id="inv-search" placeholder="Search by UID or Name..." onkeyup="renderInv()">
                </div>
                <select id="inv-cat-filter" onchange="renderInv()" style="width:180px;">
                    <option value="">All Categories</option>
                </select>
                <button class="btn btn-primary" onclick="openProdModal()">+ Add New Product</button>
            </div>
            <div class="table-wrap">
                <table>
                    <thead>
                        <tr>
                            <th onclick="sortInv('uid')">UID ‚Üï</th>
                            <th onclick="sortInv('name')">Product Name ‚Üï</th>
                            <th>Category</th>
                            <th>Supplier</th>
                            <th>Cost</th>
                            <th>Price</th>
                            <th onclick="sortInv('stock')">Stock ‚Üï</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="inv-body"></tbody>
                </table>
            </div>
        </div>

       <!-- 4. HISTORY & REPORTS -->
<div id="history" class="section">
    
    <!-- TABS -->
    <div class="tab-container">
        <button class="tab-btn active" onclick="switchTab('trans')">Sales & Returns</button>
        <button class="tab-btn" onclick="switchTab('logs')">Stock Entry Logs</button>
    </div>

    <!-- VIEW 1: SALES TRANSACTIONS -->
    <div id="view-trans">
        <div class="toolbar">
            <div style="display:flex; gap:10px; flex:1;">
                <!-- NEW: Search Bar for History -->
                <input id="hist-search" placeholder="üîç Search Bill ID, Customer or Phone..." onkeyup="renderHistory()">
                
                <input type="date" id="hist-date" onchange="renderHistory()" style="width:150px;">
                <select id="hist-type" onchange="renderHistory()" style="width:150px;">
                    <option value="">All Types</option>
                    <option value="sale">Sales</option>
                    <option value="return">Returns</option>
                </select>
            </div>
            <button class="btn btn-sec" onclick="renderHistory()">üîÑ Refresh</button>
        </div>
        <div class="table-wrap">
            <table>
                <thead><tr><th>ID</th><th>Date</th><th>Type</th><th>Customer</th><th>Total</th><th>Actions</th></tr></thead>
                <tbody id="hist-body"></tbody>
            </table>
        </div>
    </div>

    <!-- VIEW 2: PRODUCT LOGS (NEW) -->
    <div id="view-logs" style="display:none;">
        <div class="toolbar">
            <div class="search-box">
                <input id="log-search" placeholder="üîç Search Log by Product Name or UID..." onkeyup="renderProductLogs()">
            </div>
        </div>
        <div class="table-wrap">
            <table>
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Action Type</th>
                        <th>Product</th>
                        <th>UID</th>
                        <th>Qty Added</th>
                        <th>Stock After</th>
                    </tr>
                </thead>
                <tbody id="log-body"></tbody>
            </table>
        </div>
    </div>
</div>

        <!-- 5. SETTINGS -->
        <div id="settings" class="section">
            <h2>‚öôÔ∏è Settings & Data</h2>
            <div style="max-width:600px; background:white; padding:20px; border-radius:8px; border:1px solid var(--border);">
                
                <h3>Shop Details (For Receipt)</h3>
                <div style="display:grid; gap:10px; margin-bottom:20px;">
                    <input id="set-name" placeholder="Shop Name" onchange="saveSettings()">
                    <input id="set-addr" placeholder="Address" onchange="saveSettings()">
                    <input id="set-phone" placeholder="Phone" onchange="saveSettings()">
                </div>

                <h3>Data Backup</h3>
                <p style="color:var(--text-muted); font-size:13px;">Download your data regularly to avoid loss.</p>
                <div style="display:flex; gap:10px; margin-bottom:20px;">
                    <button class="btn btn-primary" onclick="exportData()">‚¨áÔ∏è Export Backup</button>
                    <button class="btn btn-sec" onclick="document.getElementById('file-in').click()">‚¨ÜÔ∏è Restore Data</button>
                    <input type="file" id="file-in" hidden onchange="importData(this)">
                </div>
                
                <hr>
                <button class="btn btn-danger" onclick="factoryReset()" style="margin-top:10px;">‚ö†Ô∏è Factory Reset</button>
            </div>
        </div>
    </main>

    <!-- MODALS -->
    
<!-- MODAL: SMART PRODUCT ENTRY -->
<div id="modal-prod" class="modal">
    <div class="modal-box">
        <h2 id="m-title">Product Entry</h2>
        
        <!-- 1. SMART SEARCH BAR -->
        <div class="search-wrapper">
            <input id="p-search" placeholder="üîç Type Name or UID to search existing..." 
                   onkeyup="searchForModal(this.value)" 
                   style="background: #f8fafc; border: 1px solid var(--primary); font-weight: bold;">
            <div id="p-results" class="search-results"></div>
        </div>

        <input type="hidden" id="p-id"> <!-- Hidden ID to track if updating -->

        <div style="display:grid; gap:15px;">
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <div>
                    <label>UID / Code</label>
                    <input id="p-uid" placeholder="Auto or Scan">
                </div>
                <div>
                    <label>Category</label>
                    <select id="p-cat" style="padding:9px;"></select>
                </div>
            </div>
            
            <div><label>Product Name</label><input id="p-name"></div>
            <div><label>Supplier</label><input id="p-sup"></div>
            
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <div><label>Buy Price</label><input type="number" id="p-buy"></div>
                <div><label>Sell Price</label><input type="number" id="p-sell"></div>
            </div>
            
            <!-- Stock Logic -->
            <div style="background: #f0fdf4; padding: 10px; border-radius: 8px; border: 1px solid #bbf7d0;">
                <div id="stock-info" style="font-size:12px; color: var(--text-muted); margin-bottom: 5px;">
                    Initial Stock:
                </div>
                <input type="number" id="p-stock" placeholder="Enter Quantity to ADD">
            </div>

            <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:10px;">
                <button class="btn btn-sec" onclick="closeModal('modal-prod')">Cancel</button>
                <button class="btn btn-primary" onclick="saveProduct()">üíæ Save / Update</button>
            </div>
        </div>
    </div>
</div>

    <!-- Transaction Detail / Return Modal -->
    <div id="modal-trx" class="modal">
        <div class="modal-box" style="width:600px;">
            <h2>Transaction Details</h2>
            <div id="trx-content"></div>
            <div style="text-align:right; margin-top:20px;">
                <button class="btn btn-sec" onclick="closeModal('modal-trx')">Close</button>
            </div>
        </div>
    </div>

    <!-- Hidden Print Area -->
    <div id="print-area"></div>

    <script>
        /* --- 1. DATA STRUCTURE & INIT --- */
        const DB_NAME = "stocked_ultimate_db";
        let db = { 
            products: [], 
            transactions: [], 
            settings: { name: "My Shop", addr: "Dhaka", phone: "017..." } 
        };
        let cart = [];
        let sortKey = 'name', sortAsc = true;

        window.onload = () => {
    const saved = localStorage.getItem(DB_NAME);
    if (saved) db = JSON.parse(saved);
    else seedData();
    
    // --- ADD THIS LINE ---
    if (!db.productLogs) db.productLogs = []; // Ensure logs array exists
    // --------------------
    
    loadSettings();
    nav('dashboard');
    updateCatDropdowns();
};

        function seedData() {
            db.products = [
                {id:1, uid:"1001", name:"Cotton Polo Shirt", cat:"Clothing", sup:"FashionBd", buy:300, sell:550, stock:40},
                {id:2, uid:"2050", name:"USB-C Charger", cat:"Electronics", sup:"GadgetMart", buy:150, sell:350, stock:8}
            ];
            save();
        }
        function save() { localStorage.setItem(DB_NAME, JSON.stringify(db)); }

        function nav(id) {
            document.querySelectorAll('.section').forEach(e => e.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
            // Simple active state logic based on button text matching id roughly
            const btns = document.querySelectorAll('.nav-item');
            btns.forEach(b => { if(b.innerText.toLowerCase().includes(id)) b.classList.add('active'); });

            if(id === 'dashboard') renderDash();
            if(id === 'pos') renderPOS();
            if(id === 'inventory') renderInv();
            if(id === 'history') renderHistory();
        }

        /* --- 2. INVENTORY LOGIC --- */
        function renderInv() {
            const tbody = document.getElementById('inv-body');
            tbody.innerHTML = "";
            const q = document.getElementById('inv-search').value.toLowerCase();
            const cat = document.getElementById('inv-cat-filter').value;

            let list = db.products.filter(p => 
                (p.name.toLowerCase().includes(q) || p.uid.toLowerCase().includes(q)) &&
                (cat === "" || p.cat === cat)
            );

            // Sort
            list.sort((a,b) => {
                let va = a[sortKey], vb = b[sortKey];
                if(typeof va === 'string') { va = va.toLowerCase(); vb = vb.toLowerCase(); }
                return (va > vb ? 1 : -1) * (sortAsc ? 1 : -1);
            });

            list.forEach(p => {
                tbody.innerHTML += `
                    <tr>
                        <td style="font-family:monospace; color:var(--primary); font-weight:bold;">${p.uid}</td>
                        <td>${p.name}</td>
                        <td><span class="tag" style="background:#f1f5f9;">${p.cat}</span></td>
                        <td>${p.sup}</td>
                        <td>${p.buy}</td>
                        <td>${p.sell}</td>
                        <td>${p.stock} ${p.stock<5 ? 'üî¥' : ''}</td>
                        <td>
                            <button class="btn btn-sec btn-sm" onclick="editProd(${p.id})">‚úèÔ∏è</button>
                            <button class="btn btn-danger btn-sm" onclick="delProd(${p.id})">üóë</button>
                        </td>
                    </tr>
                `;
            });
        }
        
        function editProd(id) {
    // Reuse the logic we built for the search bar
    // This ensures the modal opens and fills correctly
    openProdModal(); // Open and reset first
    fillModalFromSearch(id); // Fill with data
    document.getElementById('m-title').innerText = "Edit Product Details";
}


        function sortInv(key) {
            if(sortKey === key) sortAsc = !sortAsc;
            else { sortKey = key; sortAsc = true; }
            renderInv();
        }

        // --- SMART PRODUCT MODAL LOGIC ---

// 1. Open Modal (Resets everything)
function openProdModal() {
    // Reset Title & ID
    document.getElementById('m-title').innerText = "Add Product / Update Stock";
    document.getElementById('p-id').value = ""; // Empty ID means NEW product
    
    // Clear Inputs
    document.querySelectorAll('#modal-prod input').forEach(i => i.value = "");
    
    // Reset Search Elements
    document.getElementById('p-search').value = "";
    document.getElementById('p-results').style.display = 'none';
    
    // Reset Logic specific to "New Product"
    document.getElementById('p-uid').readOnly = false; // Allow typing UID
    document.getElementById('stock-info').innerHTML = "Initial Stock:";
    document.getElementById('p-stock').placeholder = "Enter Quantity";
    
    // Show Modal
    document.getElementById('modal-prod').style.display = 'flex';
    
    // Focus on search bar for speed
    setTimeout(() => document.getElementById('p-search').focus(), 100);
}

// 2. Search as you type
function searchForModal(q) {
    const resDiv = document.getElementById('p-results');
    
    // Hide if empty
    if (q.length < 1) {
        resDiv.style.display = 'none';
        return;
    }
    
    // Find matches (Name or UID)
    const matches = db.products.filter(p =>
        p.name.toLowerCase().includes(q.toLowerCase()) ||
        p.uid.toLowerCase().includes(q.toLowerCase())
    );
    
    if (matches.length > 0) {
        resDiv.style.display = 'block';
        resDiv.innerHTML = matches.map(p => `
                <div class="search-item" onclick="fillModalFromSearch(${p.id})">
                    <div>
                        <strong>${p.name}</strong>
                        <br><small style="color:#666">${p.uid}</small>
                    </div>
                    <div style="text-align:right">
                        <span class="tag" style="background:#dcfce7; color:#166534">Stock: ${p.stock}</span>
                        <br><small>‡ß≥${p.sell}</small>
                    </div>
                </div>
            `).join('');
    } else {
        resDiv.style.display = 'none';
    }
}

// 3. Select Existing Product (Switch to Update Mode)
function fillModalFromSearch(id) {
    const p = db.products.find(x => x.id === id);
    if (!p) return;
    
    // Fill the form
    document.getElementById('p-id').value = p.id; // Set ID (Critical for Update)
    document.getElementById('p-uid').value = p.uid;
    document.getElementById('p-uid').readOnly = true; // Lock UID
    document.getElementById('p-name').value = p.name;
    document.getElementById('p-cat').value = p.cat;
    document.getElementById('p-sup').value = p.sup;
    document.getElementById('p-buy').value = p.buy;
    document.getElementById('p-sell').value = p.sell;
    
    // UI Updates for "Stock Adding" mode
    document.getElementById('stock-info').innerHTML = `Current Stock: <b>${p.stock}</b> + New Entry:`;
    document.getElementById('p-stock').value = ""; // Clear stock so user adds NEW amount
    document.getElementById('p-stock').placeholder = "Add amount (e.g. 10)";
    document.getElementById('p-stock').focus();
    
    // Hide Search Results
    document.getElementById('p-results').style.display = 'none';
    document.getElementById('p-search').value = ""; // Clear search bar
}

// 4. Save (Handles both NEW and EXISTING)
function saveProduct() {
    const id = document.getElementById('p-id').value;
    const inputStock = Number(document.getElementById('p-stock').value);
    
    const obj = {
        uid: document.getElementById('p-uid').value || "GEN-" + Date.now(),
        name: document.getElementById('p-name').value,
        cat: document.getElementById('p-cat').value || "General",
        sup: document.getElementById('p-sup').value,
        buy: Number(document.getElementById('p-buy').value),
        sell: Number(document.getElementById('p-sell').value)
    };
    
    if (!obj.name || !obj.sell) return alert("Name and Price required!");
    
    let logEntry = {
        date: new Date().toISOString(),
        name: obj.name,
        uid: obj.uid,
        added: inputStock,
        type: 'New Item'
    };
    
    if (id) {
        // UPDATE EXISTING
        const index = db.products.findIndex(x => x.id == id);
        if (index > -1) {
            obj.id = Number(id);
            const oldStock = db.products[index].stock;
            
            // Logic: Only add inputStock if user typed something
            obj.stock = oldStock + inputStock;
            
            // Log details
            logEntry.type = inputStock > 0 ? 'Restock' : 'Update Info';
            logEntry.finalStock = obj.stock;
            
            db.products[index] = obj;
            if (inputStock > 0) alert(`Stock Updated! New Total: ${obj.stock}`);
            else alert("Product Details Updated");
        }
    } else {
        // CREATE NEW
        obj.id = Date.now();
        obj.stock = inputStock;
        
        logEntry.type = 'Created';
        logEntry.finalStock = inputStock;
        
        db.products.push(obj);
        alert("New Product Created!");
    }
    
    // --- SAVE LOG ---
    // Only log if stock changed or created
    if (inputStock > 0 || !id) {
        if (!db.productLogs) db.productLogs = [];
        db.productLogs.unshift(logEntry);
    }
    // ----------------
    
    save();
    closeModal('modal-prod');
    renderInv();
    updateCatDropdowns();
    renderPOS();
    filterLowStock();
}

        function delProd(id) {
            if(confirm("Delete this product?")) {
                db.products = db.products.filter(x => x.id !== id);
                save();
                renderInv();
            }
        }

        /* --- 3. POS LOGIC --- */
        function renderPOS() {
            const grid = document.getElementById('pos-grid');
            grid.innerHTML = "";
            const q = document.getElementById('pos-search').value.toLowerCase();
            const cat = document.getElementById('pos-cat').value;

            db.products.filter(p => 
                (p.name.toLowerCase().includes(q) || p.uid.toLowerCase().includes(q)) &&
                (cat === "" || p.cat === cat) && p.stock > 0
            ).forEach(p => {
                grid.innerHTML += `
                    <div class="pos-card" onclick="addToCart(${p.id})">
                        <div class="stock-tag">${p.stock}</div>
                        <div style="font-weight:bold; font-size:14px;">${p.name}</div>
                        <div style="font-size:12px; color:var(--text-muted);">${p.uid}</div>
                        <div style="color:var(--primary); font-weight:bold; margin-top:auto;">‡ß≥${p.sell}</div>
                    </div>
                `;
            });
        }

        function addToCart(id) {
            const p = db.products.find(x => x.id === id);
            const ex = cart.find(x => x.id === id);
            if(ex) {
                if(ex.qty < p.stock) ex.qty++;
                else alert("Stock Limit Reached");
            } else {
                // actualSell is editable in cart
                cart.push({...p, qty:1, actualSell: p.sell});
            }
            renderCart();
        }

        function renderCart() {
            const div = document.getElementById('cart-list');
            div.innerHTML = "";
            cart.forEach((c, idx) => {
                div.innerHTML += `
                    <div class="cart-item">
                        <div>
                            <div style="font-weight:600;">${c.name}</div>
                            <div style="font-size:11px; color:var(--text-muted);">${c.sup} | Stock: ${c.stock}</div>
                            <div class="cart-controls">
                                <button class="btn btn-sec btn-sm" onclick="updCart(${idx}, -1)">-</button>
                                <span>${c.qty}</span>
                                <button class="btn btn-sec btn-sm" onclick="updCart(${idx}, 1)">+</button>
                                <span style="font-size:12px; margin-left:5px;">Price:</span>
                                <input class="cart-input" type="number" value="${c.actualSell}" onchange="updPrice(${idx}, this.value)">
                            </div>
                        </div>
                        <div style="text-align:right;">
                            <button style="color:red; background:none; border:none; cursor:pointer;" onclick="remCart(${idx})">‚úñ</button>
                            <div style="font-weight:bold; margin-top:15px;">‡ß≥${c.qty * c.actualSell}</div>
                        </div>
                    </div>
                `;
            });
            updateCartTotals();
        }

        function updCart(idx, chg) {
            const c = cart[idx];
            if(c.qty + chg > 0 && c.qty + chg <= c.stock) {
                c.qty += chg;
                renderCart();
            }
        }
        function updPrice(idx, val) { cart[idx].actualSell = Number(val); renderCart(); }
        function remCart(idx) { cart.splice(idx, 1); renderCart(); }

        function updateCartTotals() {
            const sub = cart.reduce((a,b) => a + (b.qty * b.actualSell), 0);
            const del = Number(document.getElementById('c-del').value);
            const disc = Number(document.getElementById('c-disc').value);
            document.getElementById('c-sub').innerText = sub;
            document.getElementById('c-total').innerText = "‡ß≥" + (sub + del - disc);
        }

        function processCheckout() {
            if(cart.length === 0) return alert("Cart Empty");
            
            const sub = cart.reduce((a,b) => a + (b.qty * b.actualSell), 0);
            const del = Number(document.getElementById('c-del').value);
            const disc = Number(document.getElementById('c-disc').value);
            const total = sub + del - disc;
            const profit = cart.reduce((a,b) => a + ((b.actualSell - b.buy) * b.qty), 0) - disc;

            const trx = {
                id: "INV-" + Date.now().toString().slice(-6),
                date: new Date().toISOString(),
                type: 'sale',
                cust: document.getElementById('cust-name').value || "Guest",
                phone: document.getElementById('cust-phone').value || "",
                items: cart.map(c => ({...c})), // copy
                sub, del, disc, total, profit
            };

            // Update DB Stock
            trx.items.forEach(i => {
                const p = db.products.find(x => x.id === i.id);
                if(p) p.stock -= i.qty;
            });

            db.transactions.unshift(trx);
            save();
            printReceipt(trx);
            
            // Reset
            cart = [];
            document.getElementById('c-del').value=0;
            document.getElementById('c-disc').value=0;
            document.getElementById('cust-name').value="";
            document.getElementById('cust-phone').value="";
            renderCart();
            renderPOS();
        }

        /* --- 4. HISTORY & RETURNS --- */
        function renderHistory() {
            const tbody = document.getElementById('hist-body');
            tbody.innerHTML = "";
            const date = document.getElementById('hist-date').value;
            const type = document.getElementById('hist-type').value;

            db.transactions.forEach(t => {
                if(date && !t.date.startsWith(date)) return;
                if(type && t.type !== type) return;
                
                const tag = t.type === 'sale' ? '<span class="tag tag-sale">SALE</span>' : '<span class="tag tag-return">RETURN</span>';
                
                tbody.innerHTML += `
                    <tr>
                        <td>${t.id}</td>
                        <td>${new Date(t.date).toLocaleString()}</td>
                        <td>${tag}</td>
                        <td>${t.cust}<br><small>${t.phone}</small></td>
                        <td style="font-weight:bold;">‡ß≥${t.total}</td>
                        <td>
                            <button class="btn btn-sec btn-sm" onclick='viewTrx("${t.id}")'>üëÅ Details</button>
                            <button class="btn btn-sec btn-sm" onclick='printReceiptById("${t.id}")'>üñ® Print</button>
                        </td>
                    </tr>
                `;
            });
        }

        function viewTrx(id) {
    const t = db.transactions.find(x => x.id === id);
    
    let html = `
        <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
            <div><strong>ID:</strong> ${t.id}</div>
            <div>${new Date(t.date).toLocaleString()}</div>
        </div>
        <div style="background:#f8fafc; padding:10px; border-radius:6px; margin-bottom:10px;">
            <strong>Customer:</strong> ${t.cust}<br>
            <strong>Phone:</strong> ${t.phone || 'N/A'}
        </div>
        <table style="width:100%; border-collapse:collapse;">
            <thead style="background:#f1f5f9;">
                <tr><th style="padding:8px; text-align:left;">Item</th><th>Qty</th><th>Price</th><th>Total</th><th>Action</th></tr>
            </thead>
            <tbody>
    `;
    
    t.items.forEach((i, idx) => {
        // Check if item is returned
        const isRet = i.isReturned === true;
        const rowStyle = isRet ? 'background:#fee2e2; color:#991b1b; text-decoration:line-through;' : '';
        const status = isRet ? '<span class="tag tag-return">RETURNED</span>' : '';
        
        html += `
            <tr style="border-bottom:1px solid #eee; ${isRet ? 'background:#fff1f2;' : ''}">
                <td style="padding:8px;">
                    ${i.name} ${status}
                </td>
                <td style="text-align:center;">${i.qty}</td>
                <td style="text-align:center;">${i.actualSell}</td>
                <td style="text-align:center;">${i.qty * i.actualSell}</td>
                <td style="text-align:center;">
                     ${t.type === 'sale' && !isRet ? 
                       `<button class="btn btn-danger btn-sm" onclick="processReturn('${t.id}', ${idx})">‚Ü© Return</button>` : 
                       '-'
                     }
                </td>
            </tr>
        `;
    });
    
    html += `</tbody></table>
        <div style="text-align:right; margin-top:15px; border-top:2px solid #eee; padding-top:10px;">
            <p style="margin:5px 0;">Subtotal: ${t.sub}</p>
            <p style="margin:5px 0;">Discount: -${t.disc}</p>
            <h3 style="margin:5px 0;">Total Paid: ‡ß≥${t.total}</h3>
        </div>`;
    
    document.getElementById('trx-content').innerHTML = html;
    document.getElementById('modal-trx').style.display = 'flex';
}
        function processReturn(tid, idx) {
    if (!confirm("Process Return? Stock will be restored and Profit deducted.")) return;
    
    // 1. Find Original Transaction & Item
    const orgTrx = db.transactions.find(x => x.id === tid);
    const item = orgTrx.items[idx];
    
    // Check if already returned
    if (item.isReturned) return alert("Item already returned!");
    
    // 2. Restore Stock to Inventory
    const prod = db.products.find(p => p.id === item.id);
    if (prod) {
        prod.stock += item.qty;
        
        // Log the stock return
        if (!db.productLogs) db.productLogs = [];
        db.productLogs.unshift({
            date: new Date().toISOString(),
            name: prod.name,
            uid: prod.uid,
            added: item.qty,
            type: 'Customer Return',
            finalStock: prod.stock
        });
    }
    
    // 3. MARK ITEM AS RETURNED IN ORIGINAL BILL
    item.isReturned = true; // <--- New Flag
    orgTrx.items[idx] = item; // Update the item in the list
    
    // 4. Create the Negative Return Transaction (For Accounting/Dashboard)
    const amount = item.qty * item.actualSell;
    const profitLoss = (item.actualSell - item.buy) * item.qty; // Calculate profit to reverse
    
    const retTrx = {
        id: "RET-" + Date.now().toString().slice(-6),
        date: new Date().toISOString(),
        type: 'return',
        cust: orgTrx.cust,
        phone: orgTrx.phone,
        items: [{ ...item }], // Copy item details
        sub: -amount,
        del: 0,
        disc: 0,
        total: -amount,
        profit: -profitLoss // Deduct from profit
    };
    
    db.transactions.unshift(retTrx);
    save();
    
    closeModal('modal-trx');
    renderHistory(); // Refresh list
    renderDash(); // Update stats
    alert("Return Processed Successfully");
}

        /* --- 5. DASHBOARD LOGIC --- */
  function renderDash() {
    const today = new Date().toISOString().slice(0, 10);
    
    // Filter transactions for TODAY
    const dailyTrx = db.transactions.filter(t => t.date.startsWith(today));
    
    // Calculate Net Totals (Sales + Returns)
    // Since Returns are negative numbers, simply adding them works perfectly!
    const netSales = dailyTrx.reduce((sum, t) => sum + t.total, 0);
    const netProfit = dailyTrx.reduce((sum, t) => sum + t.profit, 0);
    
    // Low Stock Count
    const low = db.products.filter(p => p.stock < 5).length;
    
    // Update UI
    document.getElementById('d-sales').innerText = "‡ß≥" + netSales.toLocaleString();
    document.getElementById('d-profit').innerText = "‡ß≥" + netProfit.toLocaleString();
    document.getElementById('d-low').innerText = low;
    
    // Top Selling Logic (Exclude Returns from "Top Selling" visual)
    let counts = {};
    db.transactions.filter(t => t.type === 'sale').forEach(t => {
        t.items.forEach(i => {
            // Don't count if it was returned later
            if (!i.isReturned) {
                if (!counts[i.name]) counts[i.name] = { q: 0, rev: 0 };
                counts[i.name].q += i.qty;
                counts[i.name].rev += (i.qty * i.actualSell);
            }
        });
    });
    
    const top = Object.keys(counts).sort((a, b) => counts[b].q - counts[a].q).slice(0, 5);
    document.querySelector('#top-table tbody').innerHTML = top.map(k => `
        <tr><td>${k}</td><td>${counts[k].q}</td><td>‡ß≥${counts[k].rev}</td></tr>
    `).join('');
    
    // Recent Activity List
    document.getElementById('recent-list').innerHTML = db.transactions.slice(0, 6).map(t => `
        <div style="padding:10px; border-bottom:1px solid #f1f5f9; display:flex; justify-content:space-between; align-items:center;">
            <div>
                <div style="font-weight:600; font-size:13px;">${t.cust}</div> 
                <div style="font-size:11px; color:#64748b;">${t.type.toUpperCase()} #${t.id}</div>
            </div>
            <div style="font-weight:bold; color:${t.type==='sale'?'var(--success)':'var(--danger)'}">
                ${t.type==='sale' ? '+' : ''}‡ß≥${t.total}
            </div>
        </div>
    `).join('');
}

        function filterLowStock() {
            nav('inventory');
            // simple filter hack
            const rows = document.querySelectorAll('#inv-body tr');
            rows.forEach(r => {
                if(!r.innerHTML.includes('üî¥')) r.style.display = 'none';
            });
        }

        /* --- 6. UTILS, SETTINGS & PRINT --- */
        function updateCatDropdowns() {
            const cats = [...new Set(db.products.map(p=>p.cat))];
            const opts = `<option value="">All Categories</option>` + cats.map(c=>`<option value="${c}">${c}</option>`).join('');
            document.getElementById('pos-cat').innerHTML = opts;
            document.getElementById('inv-cat-filter').innerHTML = opts;
            
            // For Add Modal
            const modOpts = cats.map(c=>`<option value="${c}">${c}</option>`).join('') + `<option value="General">General</option>`;
            document.getElementById('p-cat').innerHTML = modOpts;
        }

        function loadSettings() {
            if(db.settings) {
                document.getElementById('set-name').value = db.settings.name;
                document.getElementById('set-addr').value = db.settings.addr;
                document.getElementById('set-phone').value = db.settings.phone;
            }
        }
        function saveSettings() {
            db.settings = {
                name: document.getElementById('set-name').value,
                addr: document.getElementById('set-addr').value,
                phone: document.getElementById('set-phone').value
            };
            save();
        }

        function printReceiptById(id) {
            const t = db.transactions.find(x => x.id === id);
            if(t) printReceipt(t);
        }

        function printReceipt(t) {
    const shop = db.settings || { name: "Shop Name", addr: "Address", phone: "Phone" };
    
    // Create the HTML for A4 Invoice
    const html = `
        <div style="max-width: 210mm; margin: 0 auto;">
            <!-- HEADER -->
            <div class="print-header">
                <div>
                    <h1 style="margin:0; font-size: 24px; color: #4f46e5;">${shop.name}</h1>
                    <p style="margin:5px 0;">${shop.addr}</p>
                    <p style="margin:0;">üìû ${shop.phone}</p>
                </div>
                <div style="text-align: right;">
                    <h2 style="margin:0; color: #333;">INVOICE</h2>
                    <p style="margin:5px 0;"><b>Bill ID:</b> ${t.id}</p>
                    <p style="margin:0;"><b>Date:</b> ${new Date(t.date).toLocaleString()}</p>
                </div>
            </div>

            <!-- CUSTOMER INFO -->
            <div style="margin-bottom: 20px;">
                <strong>Bill To:</strong><br>
                <span style="font-size: 16px;">${t.cust}</span><br>
                Phone: ${t.phone || "N/A"}
            </div>

            <!-- TABLE -->
            <table class="print-table">
                <thead>
                    <tr>
                        <th style="width: 5%;">#</th>
                        <th style="width: 50%;">Item Description</th>
                        <th style="width: 15%; text-align: center;">Qty</th>
                        <th style="width: 15%; text-align: right;">Unit Price</th>
                        <th style="width: 15%; text-align: right;">Total</th>
                    </tr>
                </thead>
                <tbody>
                    ${t.items.map((item, index) => `
                        <tr>
                            <td>${index + 1}</td>
                            <td>
                                <b>${item.name}</b><br>
                                <small style="color:#666;">UID: ${item.uid || item.id}</small>
                            </td>
                            <td style="text-align: center;">${item.qty}</td>
                            <td class="text-right">${item.actualSell}</td>
                            <td class="text-right">${(item.qty * item.actualSell).toFixed(2)}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>

            <!-- TOTALS -->
            <div style="display: flex; justify-content: flex-end; margin-top: 20px;">
                <div style="width: 250px;">
                    <div style="display: flex; justify-content: space-between; padding: 5px 0;">
                        <span>Subtotal:</span>
                        <span>${t.sub}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 5px 0;">
                        <span>Delivery Charge:</span>
                        <span>+${t.del}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 5px 0; color: red;">
                        <span>Discount:</span>
                        <span>-${t.disc}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 10px 0; border-top: 2px solid #000; font-weight: bold; font-size: 18px;">
                        <span>Grand Total:</span>
                        <span>‡ß≥${t.total}</span>
                    </div>
                </div>
            </div>

            <!-- FOOTER -->
            <div style="margin-top: 50px; border-top: 1px solid #ddd; padding-top: 10px; display: flex; justify-content: space-between; font-size: 12px; color: #666;">
                <div>Authorized Signature</div>
                <div>Thank you for your business!</div>
            </div>
        </div>
    `;
    
    // Inject and Print
    document.getElementById('print-area').innerHTML = html;
    window.print();
}

        function exportData() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(db));
            const a = document.createElement('a');
            a.href = dataStr;
            a.download = "stocked_backup_" + Date.now() + ".json";
            a.click();
        }

        function importData(input) {
            const reader = new FileReader();
            reader.onload = e => {
                try {
                    db = JSON.parse(e.target.result);
                    save();
                    location.reload();
                } catch(err) { alert("Invalid File"); }
            };
            reader.readAsText(input.files[0]);
        }

        function factoryReset() {
            if(confirm("PERMANENTLY DELETE ALL DATA?")) {
                localStorage.removeItem(DB_NAME);
                location.reload();
            }
        }

        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        
        // --- HISTORY TABS & LOGIC ---

function switchTab(tab) {
    // Toggle Views
    document.getElementById('view-trans').style.display = tab === 'trans' ? 'block' : 'none';
    document.getElementById('view-logs').style.display = tab === 'logs' ? 'block' : 'none';
    
    // Toggle Buttons
    const btns = document.querySelectorAll('.tab-btn');
    btns.forEach(b => b.classList.remove('active'));
    event.target.classList.add('active');

    if(tab === 'trans') renderHistory();
    if(tab === 'logs') renderProductLogs();
}

// Updated Transaction History with Search
function renderHistory() {
    const tbody = document.getElementById('hist-body');
    tbody.innerHTML = "";
    
    const q = document.getElementById('hist-search').value.toLowerCase(); // Search Query
    const date = document.getElementById('hist-date').value;
    const type = document.getElementById('hist-type').value;

    db.transactions.forEach(t => {
        // Filter Logic
        if(date && !t.date.startsWith(date)) return;
        if(type && t.type !== type) return;
        
        // Search Logic (ID, Cust Name, Phone)
        const searchStr = (t.id + t.cust + t.phone).toLowerCase();
        if(q && !searchStr.includes(q)) return;
        
        const tag = t.type === 'sale' ? '<span class="tag tag-sale">SALE</span>' : '<span class="tag tag-return">RETURN</span>';
        
        tbody.innerHTML += `
            <tr>
                <td>${t.id}</td>
                <td>${new Date(t.date).toLocaleString()}</td>
                <td>${tag}</td>
                <td>${t.cust}<br><small>${t.phone}</small></td>
                <td style="font-weight:bold;">‡ß≥${t.total}</td>
                <td>
                    <button class="btn btn-sec btn-sm" onclick='viewTrx("${t.id}")'>üëÅ</button>
                    <button class="btn btn-sec btn-sm" onclick='printReceiptById("${t.id}")'>üñ®</button>
                </td>
            </tr>
        `;
    });
}

// New Product Log Renderer
function renderProductLogs() {
    const tbody = document.getElementById('log-body');
    tbody.innerHTML = "";
    const q = document.getElementById('log-search').value.toLowerCase();

    if(!db.productLogs) return;

    db.productLogs.forEach(log => {
        // Filter by Name or UID
        if(q && !log.name.toLowerCase().includes(q) && !log.uid.toLowerCase().includes(q)) return;

        // Color code the type
        let typeColor = log.type === 'Created' ? 'blue' : 'green';
        if(log.type === 'Update Info') typeColor = 'gray';

        tbody.innerHTML += `
            <tr>
                <td style="font-size:12px;">${new Date(log.date).toLocaleString()}</td>
                <td><b style="color:${typeColor}">${log.type}</b></td>
                <td>${log.name}</td>
                <td style="font-family:monospace;">${log.uid}</td>
                <td style="font-weight:bold; color:green;">+${log.added}</td>
                <td>${log.finalStock}</td>
            </tr>
        `;
    });
}

    </script>
</body>
</html>
